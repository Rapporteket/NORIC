---
title: "`r paste('Norsk register for invasiv kardiologi (NORIC)', 'Månedsrapport: Aortaklaff for ', params$hospitalName) `"
params:
  author: ukjent forfatter
  hospitalName: ukjent sykehus
  tableFormat: html
  reshID: 999999
  registryName: rapbase
  userFullName: Ukjent bruker
  userRole: ukjent rolle
  rendered_by_shiny: FALSE
header-includes:
- \usepackage[english, norsk]{babel}
- \usepackage{booktabs}
- \usepackage{rotating}
- \usepackage{float}
abstract: '`r paste0("Denne rapporten er generert ved hjelp av resultatløsningen _Rapporteket_ og er kun ment til internt bruk!", "\\newline ", "\\newline ", "Rapporten inneholder tabeller og figurer med resultater basert på forløp registrert ved ", params$hospitalName, ". Opptellinger og statistikker er gjort per forløp/prosedyre, og ikke per individ. Tabellene og figurene presenteres med data fra de siste 14 månedene." , "\\newline ", "\\newline ", "Eventuelle spørsmål knyttet til rapporten kan rettes til [noric@helse-bergen.no](mailto:noric@helse-bergen.no)") `'
date: '`r format(Sys.time(), "%d. %B, %Y")`'
registryName: NORIC
regtext: '`r readLines(system.file("registryShortDescription.txt", package = "noric"))`'
reglogo: '`r system.file("logoNORIC.png", package = "noric")`'
userFullName: '`r params$userFullName`'
linkcolor: darkblue
output:
  fig_caption: yes
---

```{r knitrOptions, include=FALSE}
library(magrittr)
library(knitr)
library(kableExtra)
library(dplyr)
library(janitor)

options(knitr.table.format = params$tableFormat)

knitr::opts_chunk$set(warnings = FALSE, echo = FALSE)
options(stringsAsFactors = FALSE)

# For some reason Shiny Server does not get the server locale settings right.
# To display dates correct, enforce locale here:
Sys.setlocale("LC_TIME", "nb_NO.UTF-8")
``` 


```{r SKDEcol, include=FALSE}

colPrimary <- c("#000059",
                "#084594",
                "#2171b5",
                "#4292c6",
                "#6baed6",
                "#c6dbef")
colNeutral <- c("#4D4D4D", "#737373", "#A6A6A6", "#DADADA")
colKontrast <- "#FF7260"

hospitalName <- params$hospitalName
``` 


```{r }
if (params$rendered_by_shiny == TRUE && params$tableFormat == "latex")
    shiny::setProgress(0.05)  # set progress to 5%
```


```{r latest_entry, include=FALSE, eval=TRUE}
# DATAGRUNNLAG: PERIODE FOR SQL SPØRRING

# NYESTE DATO:
# Finne nyeste prosedyredato (=nyeste registrering). Vi ønsker ikke at
# forhåndsregisrerte planlagte forløp kommer med i rapporten. Derfor brukes
# gårsdagens dato som referanse, ingen forløp etter denne kommer med .
# Vi vil dermed også kunne se dersom ingen nye registreringer gjøres eller om
# overføringer har stoppet opp

# ELDSTE DATO:
# Januar fra i fjor (hele foregående år skal vise i rapporten)



# Nyeste registrering eller gårsdagen (ikke forhåndsregistreringer)
if(params$registryName %in% "noricStagingNasjonal"){
  nyeste_reg <- min(
      (as.Date(Sys.time()) - 1),
      
      noric::getLatestEntryHospital(registryName = params$registryName, 
                                    reshID = params$reshID)
  )
  
} else {
  nyeste_reg <- min(
      (as.Date(Sys.time()) - 1),
      noric::getLatestEntry(registryName = params$registryName)
  )
}



periode_data <- data.frame(nyeste_reg = nyeste_reg) %>% 
    dplyr::mutate(
      
      
      # SISTE DATO AVGJØR SISTE MÅNED: 
      siste_dato_innevarende_mnd = lubridate::ceiling_date(
        x = nyeste_reg, unit =  "month") - lubridate::days(1),
      
      siste_dato = dplyr::case_when(
        # siste dato er nyeste dato --> nyeste mnd er komlett
        siste_dato_innevarende_mnd == nyeste_reg ~ 
          nyeste_reg, 
        
        # siste dato er ikke nyeste --> nyest mnd er ikke komplett, ta forrige
        siste_dato_innevarende_mnd != nyeste_reg ~ 
          lubridate::floor_date(nyeste_reg, "month") - 
          lubridate::days(1), 
        
        TRUE ~ as.Date(NA_character_)),
      
      
      
      
      # SISTE DATO AVGJØR SISTE KVARTAL
      siste_dato_innevarende_kvartal = lubridate::ceiling_date(
        x = nyeste_reg, 
        unit =  "quarter") - lubridate::days(1),
      
      kvartal_komplett_start = dplyr::case_when(
        # siste dato i kvartalet er lik nyeste dato --> kvartalet er komplett
        siste_dato_innevarende_kvartal == nyeste_reg ~ 
          lubridate::floor_date(nyeste_reg, 
                                unit =  "quarter"), 
        
        # siste dato i kvartalet er ulik nyeste dato -->bruk forrige kvartal
        siste_dato_innevarende_kvartal != nyeste_reg ~ 
          lubridate::floor_date(nyeste_reg, 
                                unit =  "quarter") - months(3), 
        
        TRUE ~ as.Date(NA_character_)),
      
      
      
      # Inneværende år: 
      nyesteRegYear = as.numeric(format(siste_dato, format = "%Y")),
      
      # Fjoråret
      sisteHeleYear = nyesteRegYear - 1, 

      # Inneværende måned i år: 
      nyesteRegMnd = as.numeric(format(siste_dato, format = "%m")),
      
      # Første dato for SQL -spørring : 01. januar fjoråret
      forste_dato  = as.Date(paste0(sisteHeleYear, "-01-01"),
                             format = "%Y-%m-%d"), 
      
      # Aortaklaff + Segment stent (indikator per kvartal): 
      forste_dato_kvartal = as.Date(paste0(sisteHeleYear -1, "-01-01"),
                                  format = "%Y-%m-%d")
    ) %>% 
    dplyr::select(-siste_dato_innevarende_mnd, 
                  -siste_dato_innevarende_kvartal)
  



```

```{r monthTabPrepare, include=FALSE, eval=TRUE}

timeTableMonth <- data.frame(
  monthDato = seq(periode_data$forste_dato, 
                  periode_data$siste_dato,
                  by = "month")) %>% 
  dplyr::transmute(maaned = as.factor(format(x = monthDato, 
                                             format = "%Y-%m"))) %>% 
  dplyr::mutate(maaned = as.ordered(maaned))


rangeProsDato <- paste(format(periode_data$forste_dato, 
                              "%d/%m-%Y"), 
                       "til", 
                       format(periode_data$siste_dato, 
                              "%d/%m-%Y"))
```



```{r GetData, include=FALSE, cache=FALSE}

if(params$registryName %in% "noricStagingNasjonal"){
  # SPørring til NASJONAL database. 
  # Kun utvalgt sykehus
  AK <- noric::getPrepAkData(registryName = params$registryName,
                             fromDate  = periode_data$forste_dato,
                             toDate = periode_data$siste_dato,
                             singleRow = FALSE, 
                             singleHospital = params$reshID)
  
  } else{
    # SPørring til LOKAL database. 
    # Kun et sykehus, som er registry name
    AK <- noric::getPrepAkData(registryName = params$registryName,
                               fromDate  = periode_data$forste_dato,
                               toDate = periode_data$siste_dato,
                               singleRow = FALSE, 
                               singleHospital = NULL)
}   


```

```{r prepdata}

AK %<>% 
  dplyr::mutate(
    Prosedyre2 = factor(
      x = dplyr::case_when(
        Prosedyre %in% "TAVI" ~ "TAVI", 
        Prosedyre %in% "BAV" ~ "BAV", 
        Prosedyre %in% "Avbrutt, ikke utført TAVI/BAV" ~ "Avbrutt", 
        Prosedyre %in% NA_character_ ~ NA_character_, ), 
      
      levels = c("TAVI",
                 "BAV", 
                 "Avbrutt", 
                 NA_character_)),
    
    ForlopsType2 = factor(x = ForlopsType2, 
                          levels = c("Planlagt",
                                     "Subakutt", 
                                     "Akutt", 
                                     NA_character_)), 
       
    OperativTilgang = factor(x = OperativTilgang, 
                             levels = c("Transfemoral", 
                                        "A.subclavia", 
                                        "Direkte aorta", 
                                        "Transapical", 
                                        "Annen", 
                                        NA_character_))
    
    )

```

```{r }
if (params$rendered_by_shiny == TRUE && params$tableFormat == "latex")
    shiny::setProgress(0.1)  # set progress to 10%
```



`r if(params$tableFormat !="html") {"<!--"}`
# Månedsrapport: Prosedyrer på aortaklaff {-}
Denne rapporten er generert ved hjelp av resultatløsningen *Rapporteket* og er kun ment til internt bruk! 
<br/> <br/>
Rapporten inneholder tabeller og figurer med resultater basert på forløp registrert ved `r params$hospitalName`. Opptellinger og statistikker er gjort per forløp/prosedyre, og ikke per individ. Tabellene og figurene presenteres med data fra perioden `r rangeProsDato`.
<br/><br/>
Eventuelle spørsmål knyttet til rapporten kan rettes til [noric@helse-bergen.no](mailto:noric@helse-bergen.no)
`r if(params$tableFormat !="html") {"-->"}`


`r if(params$tableFormat !="latex") {"<!--"}`
\newpage
`r if(params$tableFormat !="latex") {"-->"}`

<br/><br/>








\bigskip \bigskip \bigskip

# Datagrunnlag
Rapporten er generert med utgangspunkt i NORIC's database for
`r params$hospitalName`.    

Det presenteres månedlige resultater for hele fjorårets produksjon, samt alle
fullførte måndeder hittil i år. 
Den siste prosedyredatoen som er med i tabellene og 
figurene er dermed `r format(periode_data$siste_dato, '%d. %B %Y')`. 

Totalt `r AK %>% nrow()` prosedyrer ligger til grunn for rapporten. 

# Produksjon hittil i år
```{r}
df_cumplot <- AK %>%
  dplyr::select(maaned_nr, aar) %>% 
  dplyr::count(maaned_nr, aar) %>% 
  dplyr::arrange(maaned_nr) %>% 
  dplyr::group_by(aar) %>% 
  dplyr::mutate(
    Total=cumsum(n), 
    Maaned = factor(maaned_nr, 
                    levels = c("01", "02", "03", "04", "05", "06", "07", 
                               "08", "09", "10", "11", "12"),
                    labels = c("Jan", "Feb", "Mars", "April", "Mai", 
                               "Juni", "Juli", "Aug", "Sept", "Okt", 
                               "Nov", "Des")),
    max_tota = max(Total, na.rm = TRUE),
    
    Label = ifelse(Total == max_tota, 
                   max_tota, 
                   NA_character_))

  
  
tot_fjor <- df_cumplot %>% 
  dplyr::filter(aar == periode_data$sisteHeleYear) %>% 
  dplyr::pull(Total) %>% max(., na.rm = TRUE)

tot_aar <- df_cumplot %>% 
  dplyr::filter(aar == periode_data$nyesteRegYear) %>% 
  dplyr::pull(Total) %>% max(., na.rm = TRUE)




ggplot2::ggplot(df_cumplot) +
    ggplot2::geom_line(
      mapping = ggplot2::aes(x = Maaned, 
                             y = Total, 
                             group = aar, 
                             colour =aar), linewidth = 1.5) + 
  ggplot2::scale_color_manual(name = "",
                                values = c(colPrimary[3], colKontrast), 
                                labels = as.character(periode_data$sisteHeleYear:periode_data$nyesteRegYear), 
                                breaks = periode_data$sisteHeleYear:periode_data$nyesteRegYear) +
  
  ggplot2::geom_label(mapping = ggplot2::aes(x= 12,
                                             y = tot_fjor*0.95,
                                             label = tot_fjor) ,
                     colour = colPrimary[3]) +

   ggplot2::geom_label(mapping = ggplot2::aes(x= periode_data$nyesteRegMnd,
                                             y = tot_aar*0.95,
                                             label = tot_aar),
                     colour = colKontrast) +


 
  ggplot2::ggtitle("Prosedyrer på aortaklaff", 
                   subtitle = hospitalName) + 
  ggplot2::xlab("") + 
  ggplot2::ylab("Kumulert antall prosedyrer") + 
  ggplot2::theme_minimal() + 
  ggplot2::theme(legend.title = ggplot2::element_blank(),
                 axis.text = ggplot2::element_text(size = 12),
                 axis.text.x = ggplot2::element_text(angle = 45, hjust = 1), 
                 axis.title = ggplot2::element_text(size = 12), 
                 legend.text = ggplot2::element_text(size = 12), 
                 legend.position = "top")
  






```









# Prosedyren

## Prosedyretype {#prosedyretype}
Variabelen _prosedyre_ er ny fra våren 2023. Registreringer før 1. april 2023
er ikke med i figuren under. 

```{r FigNProsedyreType, fig.cap =  paste0("Antall prosedyrer på aortaklaff registrert i NORIC per måned ved ", params$hospitalName, " i perioden ", rangeProsDato ,  "."), fig.width = 8, fig.height = 5,  fig.pos = "H", fig.align = "center", out.width = "\\textwidth"}

pal <- colPrimary[c(5, 3, 2, 1)]


prosedyreTypeMaaned <- AK %>%
  dplyr::filter(ProsedyreDato >= as.Date("2023-04-01", format = "%Y-%m-%d")) %>% 
  dplyr::count(maaned,
               Prosedyre2,
               .drop = FALSE) %>%
  dplyr::group_by(maaned, Prosedyre2) %>% 
  mutate(n = ifelse(n==0,NA, n ))


prosedyreTypeMaaned %>% ggplot2::ggplot(
  ggplot2::aes(x = maaned,
               y = n,
               fill = factor(Prosedyre2))) +
  ggplot2::geom_bar(position = ggplot2::position_stack(reverse = TRUE),
                    stat = "identity", 
                    color = NA, linewidth = 0) +
  ggplot2::scale_fill_manual(values = pal) +
  # ggplot2::guides(fill = ggplot2::guide_legend(nrow = 2, byrow = TRUE)) +
  ggplot2::theme_minimal() +
  ggplot2::xlab("") +
  ggplot2::ylab("Antall prosedyrer") +
  ggplot2::theme(legend.title = ggplot2::element_blank(),
                 axis.text = ggplot2::element_text(size = 12),
                 axis.text.x = ggplot2::element_text(angle = 45, hjust = 1), 
                 axis.title = ggplot2::element_text(size = 12), 
                 legend.text = ggplot2::element_text(size = 12), 
                 legend.position = "top")

```





```{r TabPros, results='asis', eval=TRUE}
cap <- paste0("Alle prosedyrer som ikke er TAVI  ",
              "  ved ", params$hospitalName,
              " i perioden ", rangeProsDato, ".")

TabPros <- AK %>% 
  dplyr::filter(! Prosedyre2 %in% "TAVI" , 
                ProsedyreDato >= as.Date("2023-04-01", format = "%Y-%m-%d")) %>% 
  select(maaned, ProsedyreDato, ForlopsID, Prosedyre)


align <- c("l", rep("c", 3))
digs <-  rep(0, 4)


if (params$tableFormat == "html") {
  knitr::kable(x = TabPros, caption = cap, align = align) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped",
                                                    "hover",
                                                    "condensed"),
                              full_width = FALSE, 
                              font_size = 8) %>%
    kableExtra::column_spec(column = 1, width = "7em")
} else if (params$tableFormat == "latex") {
  knitr::kable(x = TabPros,
               format = params$tableFormat,
               caption = cap,
               booktabs = TRUE,
               align = "r") %>%
    kableExtra::kable_styling(latex_options = "HOLD_position", 
                             font_size = 8)
}

```




`r if(params$tableFormat !="latex") {"<!--"}`
\newpage
`r if(params$tableFormat !="latex") {"-->"}`



## Hastegrad {#hastegrad}


```{r FigNHastegrad, fig.cap =  paste0("Foredling av hastegrad på aortaklaff registrert i NORIC per måned ved ", params$hospitalName, " i perioden ", rangeProsDato ,  "."), fig.width = 8, fig.height = 5,  fig.pos = "H", fig.align = "center", out.width = "\\textwidth"}

pal <- colPrimary[c(5, 3, 2, 1)]


hastegradMaaned <- AK %>%
  dplyr::count(maaned,
               ForlopsType2,
               .drop = FALSE) %>%
  dplyr::group_by(maaned, ForlopsType2) %>% 
    mutate(n = ifelse(n==0,NA, n ))


hastegradMaaned %>% ggplot2::ggplot(
  ggplot2::aes(x = maaned,
               y = n,
               fill = factor(ForlopsType2))) +
  ggplot2::geom_bar(position = ggplot2::position_stack(reverse = TRUE),
                    stat = "identity") +
  ggplot2::scale_fill_manual(values = pal) +
  # ggplot2::guides(fill = ggplot2::guide_legend(reverse =TRUE)) +
  ggplot2::theme_minimal() +
  ggplot2::xlab("") +
  ggplot2::ylab("Antall prosedyrer") +
  ggplot2::theme(legend.title = ggplot2::element_blank(),
                 axis.text = ggplot2::element_text(size = 12),
                 axis.text.x = ggplot2::element_text(angle = 45, hjust = 1), 
                 axis.title = ggplot2::element_text(size = 12), 
                 legend.text = ggplot2::element_text(size = 12), 
                 legend.position ="top")

```




`r if(params$tableFormat !="latex") {"<!--"}`
\newpage
`r if(params$tableFormat !="latex") {"-->"}`



## Operativ tilgang {#optilgang}


```{r FigNTilgang, fig.cap =  paste0("Foredling av Operativ tilgang på aortaklaff registrert i NORIC per måned ved ", params$hospitalName, " i perioden ", rangeProsDato ,  "."), fig.width = 8, fig.height = 5,  fig.pos = "H", fig.align = "center", out.width = "\\textwidth"}

pal <- colPrimary[c(5, 4, 3, 2, 1)]


optilgangMaaned <- AK %>%
  dplyr::count(maaned,
               OperativTilgang,
               .drop = FALSE) %>%
  dplyr::group_by(maaned, OperativTilgang) %>% 
    mutate(n = ifelse(n==0,NA, n ))


optilgangMaaned %>% ggplot2::ggplot(
  ggplot2::aes(x = maaned,
               y = n,
               fill = factor(OperativTilgang))) +
  ggplot2::geom_bar(position = ggplot2::position_stack(reverse = TRUE),
                    stat = "identity") +
  ggplot2::scale_fill_manual(values = pal) +
  ggplot2::guides(fill = ggplot2::guide_legend(nrow = 2, byrow = TRUE)) +
  ggplot2::theme_minimal() +
  ggplot2::xlab("") +
  ggplot2::ylab("Antall prosedyrer") +
  ggplot2::theme(legend.title = ggplot2::element_blank(),
                 axis.text = ggplot2::element_text(size = 12),
                 axis.text.x = ggplot2::element_text(angle = 45, hjust = 1), 
                 axis.title = ggplot2::element_text(size = 12), 
                 legend.text = ggplot2::element_text(size = 12), 
                 legend.position ="top")

```



```{r TabTilgang, results='asis', eval=TRUE}
cap <- paste0("Antall prosedyrer registrert i NORIC per måned ",
              " per Operativ Tilgang ved ", params$hospitalName,
              " i perioden ", rangeProsDato, ".")

TabOpTilgang <- AK %>% 
  janitor::tabyl(maaned,
                 OperativTilgang) %>%
  janitor::adorn_totals("col", name = "Totalt")


TabOpTilgang <- timeTableMonth %>%
  merge(., TabOpTilgang, 
        by.x = c("maaned"), by.y = c("maaned"),
        all.x = TRUE, all.y = FALSE) %>% 
  dplyr::rename(" " = "maaned") %>% 
  janitor::adorn_totals("row", name = "Totalt")

TabOpTilgang[TabOpTilgang == 0] <- " - "
TabOpTilgang[is.na(TabOpTilgang)] <- " - "

align <- c("l", rep("c", dim(TabOpTilgang)[2] - 1))
digs <-  rep(0, dim(TabOpTilgang)[2] )


if (params$tableFormat == "html") {
  knitr::kable(x = TabOpTilgang, caption = cap, align = align) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped",
                                                    "hover",
                                                    "condensed"),
                              full_width = FALSE, 
                              font_size = 8) %>%
    kableExtra::column_spec(column = 1, width = "7em")
} else if (params$tableFormat == "latex") {
  knitr::kable(x = TabOpTilgang,
               format = params$tableFormat,
               caption = cap,
               booktabs = TRUE,
               align = "r") %>%
    kableExtra::kable_styling(latex_options = "HOLD_position", 
                             font_size = 8)
}

```

<br/>

```{r}
if (params$rendered_by_shiny == TRUE && params$tableFormat == "latex")
    shiny::setProgress(0.3)  # set progress to 30%
```


`r if(params$tableFormat !="latex") {"<!--"}`
\newpage
`r if(params$tableFormat !="latex") {"-->"}`

