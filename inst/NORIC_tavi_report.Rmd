---
title: "`r paste('Norsk register for invasiv kardiologi (NORIC)', 'Månedsrapport: Aortaklaff for ', params$hospitalName) `"
params:
  author: ukjent forfatter
  hospitalName: ukjent sykehus
  tableFormat: html
  reshID: 999999
  registryName: rapbase
  userFullName: Ukjent bruker
  userRole: ukjent rolle
  rendered_by_shiny: FALSE
header-includes:
- \usepackage[english, norsk]{babel}
- \usepackage{booktabs}
- \usepackage{rotating}
- \usepackage{float}
abstract: '`r paste0("Denne rapporten er generert ved hjelp av resultatløsningen _Rapporteket_ og er kun ment til internt bruk!", "\\newline ", "\\newline ", "Rapporten inneholder tabeller og figurer med resultater basert på forløp registrert ved ", params$hospitalName, ". Opptellinger og statistikker er gjort per forløp/prosedyre, og ikke per individ. Tabellene og figurene presenteres med data fra de siste 14 månedene." , "\\newline ", "\\newline ", "Eventuelle spørsmål knyttet til rapporten kan rettes til [noric@helse-bergen.no](mailto:noric@helse-bergen.no)") `'
date: '`r format(Sys.time(), "%d. %B, %Y")`'
registryName: NORIC
regtext: '`r readLines(system.file("registryShortDescription.txt", package = "noric"))`'
reglogo: '`r system.file("logoNORIC.png", package = "noric")`'
userFullName: '`r params$userFullName`'
linkcolor: darkblue
output:
  fig_caption: yes
---

```{r knitrOptions, include=FALSE}
library(magrittr)
library(knitr)
library(kableExtra)
library(dplyr)
library(janitor)

options(knitr.table.format = params$tableFormat)

knitr::opts_chunk$set(warnings = FALSE, echo = FALSE)
options(stringsAsFactors = FALSE)

# For some reason Shiny Server does not get the server locale settings right.
# To display dates correct, enforce locale here:
Sys.setlocale("LC_TIME", "nb_NO.UTF-8")
``` 


```{r SKDEcol, include=FALSE}

colPrimary <- c("#000059",
                "#084594",
                "#2171b5",
                "#4292c6",
                "#6baed6",
                "#c6dbef")
colNeutral <- c("#4D4D4D", "#737373", "#A6A6A6", "#DADADA")
colKontrast <- "#FF7260"

hospitalName <- params$hospitalName
``` 


```{r }
if (params$rendered_by_shiny == TRUE && params$tableFormat == "latex")
    shiny::setProgress(0.05)  # set progress to 5%
```


```{r latest_entry, include=FALSE, eval=TRUE}
# DATAGRUNNLAG: PERIODE FOR SQL SPØRRING

# NYESTE DATO:
# Finne nyeste prosedyredato (=nyeste registrering). Vi ønsker ikke at
# forhåndsregisrerte planlagte forløp kommer med i rapporten. Derfor brukes
# gårsdagens dato som referanse, ingen forløp etter denne kommer med .
# Vi vil dermed også kunne se dersom ingen nye registreringer gjøres eller om
# overføringer har stoppet opp

# ELDSTE DATO:
# Januar fra i fjor (hele foregående år skal vise i rapporten)



# Nyeste registrering eller gårsdagen (ikke forhåndsregistreringer)
if(params$registryName %in% "noricStagingNasjonal"){
  nyeste_reg <- min(
      (as.Date(Sys.time()) - 1),
      
      noric::getLatestEntryHospital(registryName = params$registryName, 
                                    reshID = params$reshID)
  )
  
} else {
  nyeste_reg <- min(
      (as.Date(Sys.time()) - 1),
      noric::getLatestEntry(registryName = params$registryName)
  )
}



periode_data <- data.frame(nyeste_reg = nyeste_reg) %>% 
    dplyr::mutate(
      
      
      # SISTE DATO AVGJØR SISTE MÅNED: 
      siste_dato_innevarende_mnd = lubridate::ceiling_date(
        x = nyeste_reg, unit =  "month") - lubridate::days(1),
      
      siste_dato = dplyr::case_when(
        # siste dato er nyeste dato --> nyeste mnd er komlett
        siste_dato_innevarende_mnd == nyeste_reg ~ 
          nyeste_reg, 
        
        # siste dato er ikke nyeste --> nyest mnd er ikke komplett, ta forrige
        siste_dato_innevarende_mnd != nyeste_reg ~ 
          lubridate::floor_date(nyeste_reg, "month") - 
          lubridate::days(1), 
        
        TRUE ~ as.Date(NA_character_)),
      
      
      
      
      # SISTE DATO AVGJØR SISTE KVARTAL
      siste_dato_innevarende_kvartal = lubridate::ceiling_date(
        x = nyeste_reg, 
        unit =  "quarter") - lubridate::days(1),
      
      kvartal_komplett_start = dplyr::case_when(
        # siste dato i kvartalet er lik nyeste dato --> kvartalet er komplett
        siste_dato_innevarende_kvartal == nyeste_reg ~ 
          lubridate::floor_date(nyeste_reg, 
                                unit =  "quarter"), 
        
        # siste dato i kvartalet er ulik nyeste dato -->bruk forrige kvartal
        siste_dato_innevarende_kvartal != nyeste_reg ~ 
          lubridate::floor_date(nyeste_reg, 
                                unit =  "quarter") - months(3), 
        
        TRUE ~ as.Date(NA_character_)),
      
      
      
      # Inneværende år: 
      nyesteRegYear = as.numeric(format(siste_dato, format = "%Y")),
      
      # Fjoråret
      sisteHeleYear = nyesteRegYear - 1, 

      # Inneværende måned i år: 
      nyesteRegMnd = as.numeric(format(siste_dato, format = "%m")),
      
      # Første dato for SQL -spørring : 01. januar fjoråret
      forste_dato  = as.Date(paste0(sisteHeleYear, "-01-01"),
                             format = "%Y-%m-%d"), 
      
      # Aortaklaff + Segment stent (indikator per kvartal): 
      forste_dato_kvartal = as.Date(paste0(sisteHeleYear -1, "-01-01"),
                                  format = "%Y-%m-%d")
    ) %>% 
    dplyr::select(-siste_dato_innevarende_mnd, 
                  -siste_dato_innevarende_kvartal)
  



```

```{r monthTabPrepare, include=FALSE, eval=TRUE}

timeTableMonth <- data.frame(
  monthDato = seq(periode_data$forste_dato, 
                  periode_data$siste_dato,
                  by = "month")) %>% 
  dplyr::transmute(maaned = as.factor(format(x = monthDato, 
                                             format = "%Y-%m"))) %>% 
  dplyr::mutate(maaned = as.ordered(maaned))


timeTableMonth_fjor <- data.frame(
  monthDato = seq(periode_data$forste_dato, 
                  as.Date(paste("30-12-", periode_data$sisteHeleYear), 
                          format = "%d-%m-%Y"),
                  by = "month")) %>% 
  dplyr::transmute(maaned = as.factor(format(x = monthDato, 
                                             format = "%Y-%m"))) %>% 
  dplyr::transmute(
    maaned = as.ordered(maaned))

timeTableMonth_aar <- data.frame(
  monthDato = seq(as.Date(paste("01-01-", periode_data$nyesteRegYear), 
                          format = "%d-%m-%Y"),
                  periode_data$siste_dato,
                  by = "month")) %>% 
  dplyr::transmute(maaned = as.factor(format(x = monthDato, 
                                             format = "%Y-%m"))) %>% 
    dplyr::transmute(
      maaned = as.ordered(maaned))



rangeProsDato <- paste(format(periode_data$forste_dato, 
                              "%d/%m-%Y"), 
                       "til", 
                       format(periode_data$siste_dato, 
                              "%d/%m-%Y"))
```



```{r GetData, include=FALSE, cache=FALSE}

if(params$registryName %in% "noricStagingNasjonal"){
  # SPørring til NASJONAL database. 
  # Kun utvalgt sykehus
  AK <- noric::getPrepAkData(registryName = params$registryName,
                             fromDate  = periode_data$forste_dato,
                             toDate = periode_data$siste_dato,
                             singleRow = FALSE, 
                             singleHospital = params$reshID)
  
  } else{
    # SPørring til LOKAL database. 
    # Kun et sykehus, som er registry name
    AK <- noric::getPrepAkData(registryName = params$registryName,
                               fromDate  = periode_data$forste_dato,
                               toDate = periode_data$siste_dato,
                               singleRow = FALSE, 
                               singleHospital = NULL)
}   


```

```{r prepdata}

AK %<>% 
  dplyr::mutate(
    Prosedyre2 = factor(
      x = dplyr::case_when(
        Prosedyre %in% "TAVI" ~ "TAVI", 
        Prosedyre %in% "BAV" ~ "BAV", 
        Prosedyre %in% "Avbrutt, ikke utført TAVI/BAV" ~ "Avbrutt", 
        Prosedyre %in% NA_character_ ~ NA_character_, ), 
      
      levels = c("TAVI",
                 "BAV", 
                 "Avbrutt", 
                 NA_character_)),
    
    ForlopsType2 = factor(x = ForlopsType2, 
                          levels = c("Planlagt",
                                     "Subakutt", 
                                     "Akutt", 
                                     NA_character_)), 
       
    OperativTilgang = factor(x = OperativTilgang, 
                             levels = c("Transfemoral", 
                                        "A.subclavia", 
                                        "Direkte aorta", 
                                        "Transapical", 
                                        "Annen", 
                                        NA_character_)), 
    
    TypeKlaffeprotese2 = factor(
      x = dplyr::case_when(
        TypeKlaffeprotese %in% c("Edwards SAPIEN 3", 
                                 "Edwards SAPIEN 3 Ultra", 
                                 "Edwards SAPIEN XT", 
                                 "Edwards") ~ "Edwards", 
        
        TypeKlaffeprotese %in% c("CoreValve Evolut PRO", 
                                  "CoreValve Evolut R", 
                                  "CoreValve") ~ "CoreValve", 
        
        !is.na(TypeKlaffeprotese) ~ "Annet", 
        is.na(TypeKlaffeprotese) ~ NA_character_), 
      levels = c("Edwards", "CoreValve", "Annet", NA_character_)), 
    
      Maaned = factor(maaned_nr, 
                    levels = c("01", "02", "03", "04", "05", "06", "07", 
                               "08", "09", "10", "11", "12"),
                    labels = c("Jan", "Feb", "Mars", "April", "Mai", 
                               "Juni", "Juli", "Aug", "Sept", "Okt", 
                               "Nov", "Des")), 
    
      KlaffIKlaff = factor(x = KlaffIKlaff, 
                          levels = c("Nei",
                                     "Ja", 
                                     NA_character_)), 
    
     ParavalvularLekkasje = factor(x = ParavalvularLekkasje, 
                          levels = c("Nei",
                                     "Ja", 
                                     "Ukjent",
                                     NA_character_))) %>% 
  noric::legg_til_ventetid_tavi() %>% 
  noric::legg_til_liggedogn_tavi() %>% 
  noric::ki_ak_pacemakerbehov() %>% 
  dplyr::mutate(indik_pacemakerbehov = factor(x = indik_pacemakerbehov, 
                          levels = c("nei",
                                     "ja", 
                                     "ikke ferdigstilt",
                                     NA_character_)))

```

```{r }
if (params$rendered_by_shiny == TRUE && params$tableFormat == "latex")
    shiny::setProgress(0.1)  # set progress to 10%
```



`r if(params$tableFormat !="html") {"<!--"}`
# Månedsrapport: Prosedyrer på aortaklaff {-}
Denne rapporten er generert ved hjelp av resultatløsningen *Rapporteket* og er kun ment til internt bruk! 
<br/> <br/>
Rapporten inneholder tabeller og figurer med resultater basert på forløp registrert ved `r params$hospitalName`. Opptellinger og statistikker er gjort per forløp/prosedyre, og ikke per individ. Tabellene og figurene presenteres med data fra perioden `r rangeProsDato`.
<br/><br/>
Eventuelle spørsmål knyttet til rapporten kan rettes til [noric@helse-bergen.no](mailto:noric@helse-bergen.no)
`r if(params$tableFormat !="html") {"-->"}`


`r if(params$tableFormat !="latex") {"<!--"}`
\newpage
`r if(params$tableFormat !="latex") {"-->"}`

<br/><br/>








\bigskip \bigskip \bigskip

# Datagrunnlag

## Datagrunnlag
Rapporten er generert med utgangspunkt i NORIC's database for
`r params$hospitalName`.    

Det presenteres månedlige resultater for hele fjorårets produksjon, samt alle
fullførte måndeder hittil i år. Den siste prosedyredatoen som er med i tabellene og 
figurene er `r format(periode_data$siste_dato, '%d. %B %Y')`. 

Totalt `r AK %>% nrow()` aortaklaff-prosedyrer ligger til grunn for rapporten, 
`r AK %>% dplyr::filter(aar == periode_data$sisteHeleYear) %>% nrow()` fra 
`r periode_data$sisteHeleYear ` og 
`r AK %>% dplyr::filter(aar == periode_data$nyesteRegYear) %>% nrow()` fra 
`r periode_data$nyesteRegYear ` . 


\bigskip \bigskip \bigskip


## Kumulert produksjon per år
```{r FigKumulertProde, fig.cap =  paste0("Kumulert antall prosedyrer på aortaklaff registrert i NORIC ved ", params$hospitalName, " for hele fjoråret og hittil i år (t.o.m ", periode_data$siste_dato , ")."), fig.width = 8, fig.height = 5,  fig.pos = "H", fig.align = "center", out.width = "\\textwidth"}

df_cumplot <- AK %>%
  dplyr::select(maaned_nr, aar) %>% 
  dplyr::count(maaned_nr, aar) %>% 
  dplyr::arrange(maaned_nr) %>% 
  dplyr::group_by(aar) %>% 
  dplyr::mutate(
    Total=cumsum(n), 
    Maaned = factor(maaned_nr, 
                    levels = c("01", "02", "03", "04", "05", "06", "07", 
                               "08", "09", "10", "11", "12"),
                    labels = c("Jan", "Feb", "Mars", "April", "Mai", 
                               "Juni", "Juli", "Aug", "Sept", "Okt", 
                               "Nov", "Des")),
    max_tota = max(Total, na.rm = TRUE),
    
    Label = ifelse(Total == max_tota, 
                   max_tota, 
                   NA_character_))

  
  
tot_fjor <- df_cumplot %>% 
  dplyr::filter(aar == periode_data$sisteHeleYear) %>% 
  dplyr::pull(Total) %>% max(., na.rm = TRUE)

tot_aar <- df_cumplot %>% 
  dplyr::filter(aar == periode_data$nyesteRegYear) %>% 
  dplyr::pull(Total) %>% max(., na.rm = TRUE)




ggplot2::ggplot(df_cumplot) +
    ggplot2::geom_line(
      mapping = ggplot2::aes(x = Maaned, 
                             y = Total, 
                             group = aar, 
                             colour =aar), linewidth = 1.5) + 
  ggplot2::scale_color_manual(name = "",
                                values = c(colPrimary[3], colKontrast), 
                                labels = as.character(periode_data$sisteHeleYear:periode_data$nyesteRegYear), 
                                breaks = periode_data$sisteHeleYear:periode_data$nyesteRegYear) +
  
  ggplot2::geom_label(mapping = ggplot2::aes(x= 12,
                                             y = tot_fjor*0.95,
                                             label = tot_fjor) ,
                     colour = colPrimary[3]) +

   ggplot2::geom_label(mapping = ggplot2::aes(x= periode_data$nyesteRegMnd,
                                             y = tot_aar*0.95,
                                             label = tot_aar),
                     colour = colKontrast) +

  ggplot2::xlab("") + 
  ggplot2::ylab("Kumulert antall prosedyrer") + 
  ggplot2::theme_minimal() + 
  ggplot2::theme(legend.title = ggplot2::element_blank(),
                 axis.text = ggplot2::element_text(size = 12),
                 axis.title = ggplot2::element_text(size = 12), 
                 legend.text = ggplot2::element_text(size = 12), 
                 legend.position = "top")
  


```




`r if(params$tableFormat !="latex") {"<!--"}`
\newpage
`r if(params$tableFormat !="latex") {"-->"}`





# Prosedyreskjema 


## Prosedyretype {#prosedyretype}

```{r TabPros, results='asis', eval=TRUE}
cap <- paste0("Fordeling av prosedyretyper registrert i NORIC ",
              "ved ", params$hospitalName,
              " i perioden ", rangeProsDato, 
              ". Merk at variablen er ny fra våren 2023 og eldre ", 
              "registreringer vil ha verdien NA (not available).")


TabPros_fjor <- merge(
  x = timeTableMonth_fjor,
  y = AK %>%  
    janitor::tabyl(maaned,Prosedyre2) %>% 
    janitor::adorn_totals("col", name= "Totalt"), 
  by.x  = "maaned", 
  by.y = "maaned") %>% 
  janitor::adorn_totals("row", name = paste0("Totalt i ", periode_data$sisteHeleYear)) %>% 
  dplyr::mutate(aar = periode_data$sisteHeleYear) %>% 
  dplyr::relocate("aar", .before = "maaned") 

TabPros_aar <- merge(
  x = timeTableMonth_aar,
  y = AK %>%  
    janitor::tabyl(maaned,Prosedyre2) %>% 
    janitor::adorn_totals("col", name= "Totalt"), 
  by.x  = "maaned", 
  by.y = "maaned") %>% 
  janitor::adorn_totals("row", name = paste0("Totalt hittil i ",
                                            periode_data$nyesteRegYear)) %>% 
  dplyr::mutate(aar = periode_data$nyesteRegYear) %>% 
  dplyr::relocate("aar", .before = "maaned") 


TabPros <- rbind(
  TabPros_fjor, 
  TabPros_aar
)


TabPros[TabPros == 0] <- " - "
TabPros[is.na(TabPros)] <- " - "

align <- c("l", rep("c", dim(TabPros)[2] - 1))
digs <-  rep(0, dim(TabPros)[2] )


if (params$tableFormat == "html") {
  TabPros %>% dplyr::select(-aar) %>% 
    knitr::kable(caption = cap, align = align) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped",
                                                    "hover",
                                                    "condensed"),
                              full_width = FALSE, 
                              font_size = 8) %>%
    kableExtra::column_spec(column = 1, width = "7em") %>% 
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=dim(TabPros)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1, 
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabPros)[1])

} else if (params$tableFormat == "latex") {
  TabPros %>% dplyr::select(-aar) %>% 
    knitr::kable(format = params$tableFormat,
               caption = cap,
               booktabs = TRUE,
               align = "r") %>%
    kableExtra::kable_styling(latex_options = "HOLD_position", 
                             font_size = 8) %>% 
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE)%>%
    kableExtra::row_spec(row=dim(TabPros)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1,
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabPros)[1])


}

```







<!-- `r if(params$tableFormat !="latex") {"<!--"}` -->
<!-- \newpage -->
<!-- `r if(params$tableFormat !="latex") {"-->"}` -->



## Hastegrad {#hastegrad}


```{r FigNHastegrad, fig.cap =  cap, fig.width = 8, fig.height = 5,  fig.pos = "H", fig.align = "center", out.width = "\\textwidth"}

cap <- paste0("Fordeling av hastegrad registrert i NORIC ",
              "ved ", params$hospitalName,
              " i perioden ", rangeProsDato, ".")


TabHast_fjor <- merge(
  x = timeTableMonth_fjor,
  y = AK %>%  
    janitor::tabyl(maaned, ForlopsType2) %>% 
    janitor::adorn_totals("col", name= "Totalt"), 
  by.x  = "maaned", 
  by.y = "maaned") %>% 
  janitor::adorn_totals("row", name = paste0("Totalt i ", periode_data$sisteHeleYear)) %>% 
  dplyr::mutate(aar = periode_data$sisteHeleYear) %>% 
  dplyr::relocate("aar", .before = "maaned") 

TabHast_aar <- merge(
  x = timeTableMonth_aar,
  y = AK %>%  
    janitor::tabyl(maaned, ForlopsType2) %>% 
    janitor::adorn_totals("col", name= "Totalt"), 
  by.x  = "maaned", 
  by.y = "maaned") %>% 
  janitor::adorn_totals("row", name = paste0("Totalt hittil i ",
                                            periode_data$nyesteRegYear)) %>% 
  dplyr::mutate(aar = periode_data$nyesteRegYear) %>% 
  dplyr::relocate("aar", .before = "maaned") 


TabHast <- rbind(
  TabHast_fjor, 
  TabHast_aar
)


TabHast[TabHast == 0] <- " - "
TabHast[is.na(TabHast)] <- " - "

align <- c("l", rep("c", dim(TabHast)[2] - 1))
digs <-  rep(0, dim(TabHast)[2] )


if (params$tableFormat == "html") {
  TabHast %>% dplyr::select(-aar) %>% 
    knitr::kable(caption = cap, align = align) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped",
                                                    "hover",
                                                    "condensed"),
                              full_width = FALSE, 
                              font_size = 8) %>%
    kableExtra::column_spec(column = 1, width = "7em") %>% 
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=dim(TabHast)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1, 
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabHast)[1])

} else if (params$tableFormat == "latex") {
  TabHast %>% dplyr::select(-aar) %>% 
    knitr::kable(format = params$tableFormat,
               caption = cap,
               booktabs = TRUE,
               align = "r") %>%
    kableExtra::kable_styling(latex_options = "HOLD_position", 
                             font_size = 8) %>% 
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE)%>%
    kableExtra::row_spec(row=dim(TabHast)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1,
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabHast)[1])


}


```




`r if(params$tableFormat !="latex") {"<!--"}`
\newpage
`r if(params$tableFormat !="latex") {"-->"}`




<br/>

```{r}
if (params$rendered_by_shiny == TRUE && params$tableFormat == "latex")
    shiny::setProgress(0.2)  # set progress to 30%
```


`r if(params$tableFormat !="latex") {"<!--"}`
\newpage
`r if(params$tableFormat !="latex") {"-->"}`




## Operativ tilgang {#optilgang}



```{r TabTilgang, results='asis', eval=TRUE}
cap <- paste0("Fordeling av operativ tilgang registrert i NORIC ",
              "ved ", params$hospitalName,
              " i perioden ", rangeProsDato, ".")


TabOpTilg_fjor <- merge(
  x = timeTableMonth_fjor,
  y = AK %>%  
    janitor::tabyl(maaned, OperativTilgang) %>% 
    janitor::adorn_totals("col", name= "Totalt"), 
  by.x  = "maaned", 
  by.y = "maaned") %>% 
  janitor::adorn_totals("row", name = paste0("Totalt i ", periode_data$sisteHeleYear)) %>% 
  dplyr::mutate(aar = periode_data$sisteHeleYear) %>% 
  dplyr::relocate("aar", .before = "maaned") 

TabOpTilg_aar <- merge(
  x = timeTableMonth_aar,
  y = AK %>%  
    janitor::tabyl(maaned, OperativTilgang) %>% 
    janitor::adorn_totals("col", name= "Totalt"), 
  by.x  = "maaned", 
  by.y = "maaned") %>% 
  janitor::adorn_totals("row", name = paste0("Totalt hittil i ",
                                            periode_data$nyesteRegYear)) %>% 
  dplyr::mutate(aar = periode_data$nyesteRegYear) %>% 
  dplyr::relocate("aar", .before = "maaned") 


TabOpTilg <- rbind(
  TabOpTilg_fjor, 
  TabOpTilg_aar
)


TabOpTilg[TabOpTilg == 0] <- " - "
TabOpTilg[is.na(TabOpTilg)] <- " - "

align <- c("l", rep("c", dim(TabOpTilg)[2] - 1))
digs <-  rep(0, dim(TabOpTilg)[2] )


if (params$tableFormat == "html") {
  TabOpTilg %>% dplyr::select(-aar) %>% 
    knitr::kable(caption = cap, align = align) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped",
                                                    "hover",
                                                    "condensed"),
                              full_width = FALSE, 
                              font_size = 8) %>%
    kableExtra::column_spec(column = 1, width = "7em") %>% 
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=dim(TabOpTilg)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1, 
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabOpTilg)[1])

} else if (params$tableFormat == "latex") {
  TabOpTilg %>% dplyr::select(-aar) %>% 
    knitr::kable(format = params$tableFormat,
               caption = cap,
               booktabs = TRUE,
               align = "r") %>%
    kableExtra::kable_styling(latex_options = "HOLD_position", 
                             font_size = 8) %>% 
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE)%>%
    kableExtra::row_spec(row=dim(TabOpTilg)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1,
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabOpTilg)[1])


}
```

<br/>

```{r}
if (params$rendered_by_shiny == TRUE && params$tableFormat == "latex")
    shiny::setProgress(0.3)  # set progress to 30%
```


`r if(params$tableFormat !="latex") {"<!--"}`
\newpage
`r if(params$tableFormat !="latex") {"-->"}`





## Type klaffeprotese {#klaffeprotese}



```{r TabTypeKlaff, results='asis', eval=TRUE}
cap <- paste0("Fordeling av type klaffeprotese registrert i NORIC ",
              "ved ", params$hospitalName,
              " i perioden ", rangeProsDato, ".", 
              "Merk at dersom ingen type klaffeprotese er valgt, ", 
              "regnes prosedyren som 'uten innsetting av klaff'. ")


TabTypeKlaff_fjor <- merge(
  x = timeTableMonth_fjor,
  y = AK %>%  
    janitor::tabyl(maaned, TypeKlaffeprotese2) %>% 
    janitor::adorn_totals("col", name= "Totalt"), 
  by.x  = "maaned", 
  by.y = "maaned") %>% 
  janitor::adorn_totals("row", name = paste0("Totalt i ", periode_data$sisteHeleYear)) %>% 
  dplyr::mutate(aar = periode_data$sisteHeleYear) %>% 
  dplyr::relocate("aar", .before = "maaned") 

TabTypeKlaff_aar <- merge(
  x = timeTableMonth_aar,
  y = AK %>%  
    janitor::tabyl(maaned, TypeKlaffeprotese2) %>% 
    janitor::adorn_totals("col", name= "Totalt"), 
  by.x  = "maaned", 
  by.y = "maaned") %>% 
  janitor::adorn_totals("row", name = paste0("Totalt hittil i ",
                                            periode_data$nyesteRegYear)) %>% 
  dplyr::mutate(aar = periode_data$nyesteRegYear) %>% 
  dplyr::relocate("aar", .before = "maaned") 


TabTypeKlaff <- rbind(
  TabTypeKlaff_fjor, 
  TabTypeKlaff_aar
)


TabTypeKlaff[TabTypeKlaff == 0] <- " - "
TabTypeKlaff[is.na(TabTypeKlaff)] <- " - "

align <- c("l", rep("c", dim(TabTypeKlaff)[2] - 1))
digs <-  rep(0, dim(TabTypeKlaff)[2] )


if (params$tableFormat == "html") {
  TabTypeKlaff %>% dplyr::select(-aar) %>% 
    knitr::kable(caption = cap, align = align) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped",
                                                    "hover",
                                                    "condensed"),
                              full_width = FALSE, 
                              font_size = 8) %>%
    kableExtra::column_spec(column = 1, width = "7em") %>% 
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=dim(TabTypeKlaff)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1, 
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabTypeKlaff)[1])

} else if (params$tableFormat == "latex") {
  TabTypeKlaff %>% dplyr::select(-aar) %>% 
    knitr::kable(format = params$tableFormat,
               caption = cap,
               booktabs = TRUE,
               align = "r") %>%
    kableExtra::kable_styling(latex_options = "HOLD_position", 
                             font_size = 8) %>% 
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE)%>%
    kableExtra::row_spec(row=dim(TabTypeKlaff)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1,
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabTypeKlaff)[1])


}
```




```{r TabTypeKlaffAnnet, results='asis', eval=TRUE}
if (AK %>% dplyr::filter(TypeKlaffeprotese2 == "Annet") %>% nrow() > 0) {

cap <- paste0("Dette inneholder type klaffeprotese 'Annet'.")


TabAnnet <- AK %>% 
  dplyr::filter(TypeKlaffeprotese2 == "Annet") %>% 
  janitor::tabyl(aar, TypeKlaffeprotese) %>% 
  janitor::adorn_totals("col", name = "Totalt")



if (params$tableFormat == "html") {
  TabAnnet %>% 
    knitr::kable(format = params$tableFormat, 
                 caption = cap,  
                 booktabs = TRUE,
                 align = "r") %>%
    kableExtra::kable_styling(bootstrap_options = c("striped",
                                                    "hover",
                                                    "condensed"),
                              full_width = FALSE, 
                              font_size = 8) %>%
    kableExtra::column_spec(column = 1, width = "7em") 
} else if (params$tableFormat == "latex") {
  TabAnnet %>%
    knitr::kable(format = params$tableFormat,
                 caption = cap,
                 booktabs = TRUE,
                 align = "r") %>%
    kableExtra::kable_styling(latex_options = "HOLD_position", 
                             font_size = 8) 

}
}
```




## Klaff i klaff


```{r tabKlaffiKlaff, results='asis', eval=TRUE}
cap <- paste0("Antall prosedyrer med Klaff i Klaff registrert i NORIC ",
              "ved ", params$hospitalName,
              " i perioden ", rangeProsDato, ".")


klaffiklaff_fjor <- merge(
  x = timeTableMonth_fjor,
  y = AK %>%  
    janitor::tabyl(maaned, KlaffIKlaff) %>% 
    janitor::adorn_totals("col", name= "Totalt"), 
  by.x  = "maaned", 
  by.y = "maaned") %>% 
  janitor::adorn_totals("row", name = paste0("Totalt i ", periode_data$sisteHeleYear)) %>% 
  dplyr::mutate(aar = periode_data$sisteHeleYear) %>% 
  dplyr::relocate("aar", .before = "maaned") 

klaffiklaff_aar <- merge(
  x = timeTableMonth_aar,
  y = AK %>%  
    janitor::tabyl(maaned, KlaffIKlaff) %>% 
    janitor::adorn_totals("col", name= "Totalt"), 
  by.x  = "maaned", 
  by.y = "maaned") %>% 
  janitor::adorn_totals("row", name = paste0("Totalt hittil i ",
                                            periode_data$nyesteRegYear)) %>% 
  dplyr::mutate(aar = periode_data$nyesteRegYear) %>% 
  dplyr::relocate("aar", .before = "maaned") 


klaffiklaff <- rbind(
  klaffiklaff_fjor, 
  klaffiklaff_aar
)


klaffiklaff[klaffiklaff == 0] <- " - "
klaffiklaff[is.na(klaffiklaff)] <- " - "

align <- c("l", rep("c", dim(klaffiklaff)[2] - 1))
digs <-  rep(0, dim(klaffiklaff)[2] )


if (params$tableFormat == "html") {
  klaffiklaff %>% dplyr::select(-aar) %>% 
    knitr::kable(caption = cap, align = align) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped",
                                                    "hover",
                                                    "condensed"),
                              full_width = FALSE, 
                              font_size = 8) %>%
    kableExtra::column_spec(column = 1, width = "7em") %>% 
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=dim(klaffiklaff)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1, 
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(klaffiklaff)[1])

} else if (params$tableFormat == "latex") {
  klaffiklaff %>% dplyr::select(-aar) %>% 
    knitr::kable(format = params$tableFormat,
               caption = cap,
               booktabs = TRUE,
               align = "r") %>%
    kableExtra::kable_styling(latex_options = "HOLD_position", 
                             font_size = 8) %>% 
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE)%>%
    kableExtra::row_spec(row=dim(klaffiklaff)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1,
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(klaffiklaff)[1])


}
```



## Paravalvulær lekkasje


```{r tabParaLekk, results='asis', eval=TRUE}
cap <- paste0("Antall prosedyrer med ParavalvularLekkasje registrert i NORIC ",
              "ved ", params$hospitalName,
              " i perioden ", rangeProsDato, ".")


paraLekk_fjor <- merge(
  x = timeTableMonth_fjor,
  y = AK %>%  
    janitor::tabyl(maaned, ParavalvularLekkasje) %>% 
    janitor::adorn_totals("col", name= "Totalt"), 
  by.x  = "maaned", 
  by.y = "maaned") %>% 
  janitor::adorn_totals("row", name = paste0("Totalt i ", periode_data$sisteHeleYear)) %>% 
  dplyr::mutate(aar = periode_data$sisteHeleYear) %>% 
  dplyr::relocate("aar", .before = "maaned") 

paraLekk_aar <- merge(
  x = timeTableMonth_aar,
  y = AK %>%  
    janitor::tabyl(maaned, ParavalvularLekkasje) %>% 
    janitor::adorn_totals("col", name= "Totalt"), 
  by.x  = "maaned", 
  by.y = "maaned") %>% 
  janitor::adorn_totals("row", name = paste0("Totalt hittil i ",
                                            periode_data$nyesteRegYear)) %>% 
  dplyr::mutate(aar = periode_data$nyesteRegYear) %>% 
  dplyr::relocate("aar", .before = "maaned") 


paraLekk <- rbind(
  paraLekk_fjor, 
  paraLekk_aar
)


paraLekk[paraLekk == 0] <- " - "
paraLekk[is.na(paraLekk)] <- " - "

align <- c("l", rep("c", dim(paraLekk)[2] - 1))
digs <-  rep(0, dim(paraLekk)[2] )


if (params$tableFormat == "html") {
  paraLekk %>% dplyr::select(-aar) %>% 
    knitr::kable(caption = cap, align = align) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped",
                                                    "hover",
                                                    "condensed"),
                              full_width = FALSE, 
                              font_size = 8) %>%
    kableExtra::column_spec(column = 1, width = "7em") %>% 
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=dim(paraLekk)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1, 
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(paraLekk)[1])

} else if (params$tableFormat == "latex") {
  paraLekk %>% dplyr::select(-aar) %>% 
    knitr::kable(format = params$tableFormat,
               caption = cap,
               booktabs = TRUE,
               align = "r") %>%
    kableExtra::kable_styling(latex_options = "HOLD_position", 
                             font_size = 8) %>% 
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE)%>%
    kableExtra::row_spec(row=dim(paraLekk)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1,
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(paraLekk)[1])


}
```

# Ventetid TAVI, planlagt prosedyrer

```{r figVentetid, fig.cap = paste0("Ventetid for planlagte prosedyrer på aortaklaff er beregnet som antall dager mellom dato for screeningbeslutning og prosedyredatoen. Boxplotet viser fordelingen av ventetiden. De blå boksene er avgrenset av nedre og øvre kvartil og inneholder halvparten av registreringene. Medianen er markert av den tykke linjen midt i boksen. Bredden på boksen kalles intervartil bredde (IQR). De vertikale greinene viser minste (største) verdi i datasettet innenfor 1.5xIQR under nedre kvartil (1.5xIQR over øvre kvartil). Punktene utenfor greinene viser uteliggere, det vil si forløp med usedvanlig kort eller lang ventetid. Merk at registreringer for innneværende år ikke nødvendigvis er filvasket."),  fig.width = 8, fig.height = 5,  fig.pos = "H", fig.align = "center", out.width = "\\textwidth"}


AK %>% 
  dplyr::filter(ForlopsType2 == "Planlagt", 
                !is.na(ventetid_tavi)) %>% 
  dplyr::select(ventetid_tavi, Maaned, aar) %>% 
    ggplot2::ggplot(mapping= ggplot2::aes(x = Maaned, 
                                          y = ventetid_tavi)) +
    ggplot2::geom_boxplot(
        ggplot2::aes(alpha = aar, 
                     colour = aar), 
        na.rm = TRUE, 
        fill = colPrimary[4],
        position = ggplot2::position_dodge(preserve= "single")) +
  ggplot2::scale_alpha_manual("", values = c(0.5, 1)) +
  ggplot2::scale_color_manual("", values = c("gray40", "gray20")) +
  ggplot2::theme_minimal()  +
  ggplot2::xlab("") + 
  ggplot2::ylab("Ventetid (dager)") + 
  ggplot2::theme(
    legend.position = c(0.5, 0.9), 
    legend.direction = "horizontal",
    legend.text = ggplot2::element_text(size = 12),
    axis.text = ggplot2::element_text(size = 12), 
    axis.title = ggplot2::element_text(size = 12)
  )
```





<br/>

```{r}
if (params$rendered_by_shiny == TRUE && params$tableFormat == "latex")
    shiny::setProgress(0.6)  # set progress to 30%
```


`r if(params$tableFormat !="latex") {"<!--"}`
\newpage
`r if(params$tableFormat !="latex") {"-->"}`


# Utskrivelssested og liggetid



```{r tabUtskrevetTil, results='asis', eval=TRUE}
cap <- paste0("Fordeling av utskrivelsessted registrert i NORIC ",
              "ved ", params$hospitalName,
              " i perioden ", rangeProsDato, ".")


utskrTil_fjor <- merge(
  x = timeTableMonth_fjor,
  y = AK %>%  
    janitor::tabyl(maaned, UtskrevetTil) %>% 
    janitor::adorn_totals("col", name= "Totalt"), 
  by.x  = "maaned", 
  by.y = "maaned") %>% 
  janitor::adorn_totals("row", name = paste0("Totalt i ", periode_data$sisteHeleYear)) %>% 
  dplyr::mutate(aar = periode_data$sisteHeleYear) %>% 
  dplyr::relocate("aar", .before = "maaned") 

utskrTil_aar <- merge(
  x = timeTableMonth_aar,
  y = AK %>%  
    janitor::tabyl(maaned, UtskrevetTil) %>% 
    janitor::adorn_totals("col", name= "Totalt"), 
  by.x  = "maaned", 
  by.y = "maaned") %>% 
  janitor::adorn_totals("row", name = paste0("Totalt hittil i ",
                                            periode_data$nyesteRegYear)) %>% 
  dplyr::mutate(aar = periode_data$nyesteRegYear) %>% 
  dplyr::relocate("aar", .before = "maaned") 


utskrTil <- rbind(
  utskrTil_fjor, 
  utskrTil_aar
)


utskrTil[utskrTil == 0] <- " - "
utskrTil[is.na(utskrTil)] <- " - "

align <- c("l", rep("c", dim(utskrTil)[2] - 1))
digs <-  rep(0, dim(utskrTil)[2] )


if (params$tableFormat == "html") {
  utskrTil %>% dplyr::select(-aar) %>% 
    knitr::kable(caption = cap, align = align) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped",
                                                    "hover",
                                                    "condensed"),
                              full_width = FALSE, 
                              font_size = 8) %>%
    kableExtra::column_spec(column = 1, width = "7em") %>% 
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=dim(utskrTil)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1, 
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(utskrTil)[1])

} else if (params$tableFormat == "latex") {
  utskrTil %>% dplyr::select(-aar) %>% 
    knitr::kable(format = params$tableFormat,
               caption = cap,
               booktabs = TRUE,
               align = "r") %>%
    kableExtra::kable_styling(latex_options = "HOLD_position", 
                             font_size = 8) %>% 
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE)%>%
    kableExtra::row_spec(row=dim(utskrTil)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1,
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(utskrTil)[1])


}
```



```{r figLiggetid, fig.cap = paste0("Liggetid for prosedyrer på aortaklaff er beregnet som antall dager mellom prosedyredatoen og utskrivelsesdasto. Negative liggetider, eller liggetider over 30 dager er fjernet. Boxplotet viser fordelingen av liggetiden. Merk at antallet pasienter i de ulike kategoriene er svært ulikt.  De blå boksene er avgrenset av nedre og øvre kvartil og inneholder halvparten av registreringene. Medianen er markert av den tykke linjen midt i boksen. Bredden på boksen kalles intervartil bredde (IQR). De vertikale greinene viser minste (største) verdi i datasettet innenfor 1.5xIQR under nedre kvartil (1.5xIQR over øvre kvartil). Punktene utenfor greinene viser uteliggere, det vil si forløp med usedvanlig kort eller lang liggetiden Merk at registreringer for innneværende år ikke nødvendigvis er filvasket."),  fig.width = 8, fig.height = 5,  fig.pos = "H", fig.align = "center", out.width = "\\textwidth"}


AK %>% 
  dplyr::filter(!is.na(liggedogn_tavi), 
                liggedogn_tavi>= 0, 
                liggedogn_tavi <=30) %>% 
  dplyr::select(liggedogn_tavi, UtskrevetTil, aar) %>% 
    ggplot2::ggplot(mapping= ggplot2::aes(x = UtskrevetTil, 
                                          y = liggedogn_tavi)) +
    ggplot2::geom_boxplot(
        ggplot2::aes(alpha = aar, 
                     colour = aar), 
        na.rm = TRUE, 
        fill = colPrimary[4],
        position = ggplot2::position_dodge(preserve= "single")) +
  ggplot2::scale_alpha_manual("", values = c(0.5, 1)) +
  ggplot2::scale_color_manual("", values = c("gray40", "gray20")) +
  ggplot2::ylim(0, 30)+
  ggplot2::theme_minimal()  +
  ggplot2::xlab("") + 
  ggplot2::ylab("Liggetid (døgn)") + 
  ggplot2::theme(
    legend.position = c(0.5, 0.9), 
    legend.direction = "horizontal",
    legend.text = ggplot2::element_text(size = 12),
    axis.text = ggplot2::element_text(size = 12), 
    axis.title = ggplot2::element_text(size = 12)
  )
```







# Pacemakerbehov (Kvalitetsindikator)


```{r tabpmBeh, results='asis', eval=TRUE}
cap <- paste0("Antall prosedyrer med Pacemakerbehov etter innsetting av ", 
              " aortaklaff registrert i NORIC ",
              "ved ", params$hospitalName,
              " i perioden ", rangeProsDato, 
              ". Pasienter som allerede hadde pacemaker eller som er registrert ", 
              "som avdød ved utskrivelse er fjernet fra datagrunnlaget.")


pmBeh_fjor <- merge(
  x = timeTableMonth_fjor,
  y = AK %>%  
    dplyr::filter(indik_pacemakerbehov_data == "ja") %>% 
    janitor::tabyl(maaned, indik_pacemakerbehov) %>% 
    janitor::adorn_totals("col", name= "Totalt"), 
  by.x  = "maaned", 
  by.y = "maaned") %>% 
  janitor::adorn_totals("row", name = paste0("Totalt i ", periode_data$sisteHeleYear)) %>% 
  dplyr::mutate(aar = periode_data$sisteHeleYear) %>% 
  dplyr::relocate("aar", .before = "maaned") 

pmBeh_aar <- merge(
  x = timeTableMonth_aar,
  y = AK %>%  
    dplyr::filter(indik_pacemakerbehov_data == "ja") %>% 
    janitor::tabyl(maaned, indik_pacemakerbehov) %>% 
    janitor::adorn_totals("col", name= "Totalt"), 
  by.x  = "maaned", 
  by.y = "maaned") %>% 
  janitor::adorn_totals("row", name = paste0("Totalt hittil i ",
                                            periode_data$nyesteRegYear)) %>% 
  dplyr::mutate(aar = periode_data$nyesteRegYear) %>% 
  dplyr::relocate("aar", .before = "maaned") 


pmBeh <- rbind(
  pmBeh_fjor, 
  pmBeh_aar
)


pmBeh[pmBeh == 0] <- " - "
pmBeh[is.na(pmBeh)] <- " - "

align <- c("l", rep("c", dim(pmBeh)[2] - 1))
digs <-  rep(0, dim(pmBeh)[2] )


if (params$tableFormat == "html") {
  pmBeh %>% dplyr::select(-aar) %>% 
    knitr::kable(caption = cap, align = align) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped",
                                                    "hover",
                                                    "condensed"),
                              full_width = FALSE, 
                              font_size = 8) %>%
    kableExtra::column_spec(column = 1, width = "7em") %>% 
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=dim(pmBeh)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1, 
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(pmBeh)[1])

} else if (params$tableFormat == "latex") {
  pmBeh %>% dplyr::select(-aar) %>% 
    knitr::kable(format = params$tableFormat,
               caption = cap,
               booktabs = TRUE,
               align = "r") %>%
    kableExtra::kable_styling(latex_options = "HOLD_position", 
                             font_size = 8) %>% 
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE)%>%
    kableExtra::row_spec(row=dim(pmBeh)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1,
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(pmBeh)[1])


}
```




# TO DO 


## Komplikasjoner
hh

## Alder/ kjønn lenger tilbake i tid

