

```{r,include=FALSE}
# knitr::knit2html("NORIC_local_monthly_NSTEMI_treatment_delay.Rmd")

knitr::opts_chunk$set(
    fig.path = '' ,
    warnings = FALSE ,
    errors = FALSE ,
    messages = FALSE ,
    echo = FALSE ,
    dev="svg")

options(
    stringsAsFactors=FALSE ,
    width = "130")


## START to be deleted
# In future, rapbase will take care of the following:
# make sure processing takes place "here" (sessions getwd())
knitr::opts_knit$set(root.dir='./')
## END to be deleted


# load functions
require(mgcv)
require(ggplot2)
require(quantreg)
require(Hmisc)
require(htmlTable)


# SKDE colors
colPrimary <- c("#000059", "#084594", "#2171b5", "#4292c6", "#6baed6", "#c6dbef")
colNeutral <- c("#4D4D4D", "#737373", "#A6A6A6", "#DADADA")
colKontrast <- "#FF7260"


# assuming that if reshID does *not*exist
#  it is a testrun on localhost

if ( exists( "reshID" ) ) {
    baseName <- "noricStaging"
    registryName <- noric::NORICmakeRegistryName(baseName, reshID)
    AP <- rapbase::LoadRegData(
        registryName = registryName ,
        query = "SELECT * FROM AngioPCIVar" ,
        dbType = "mysql")
} else {
    load("../data/noric_staging.Rd")
    AP <- subset( AP , Sykehusnavn == "Haukeland" )
}


AP$HenvisningsStatus <- car::recode(
    var = AP$OverflyttetFra ,
    recodes = "
        'Annet sykehus'='Overflyttet';
        'Nei, direkte inn til dette sykehus' = 'Direkte';
        'Omdirigert ambulanse' = 'Direkte';
        else = NA
        ")

AP$Indikasjon2 <- factor(
    car::recode(
        var = AP$Indikasjon ,
        recodes = "
            'Stabil koronarsykdom '='SAP';
            'UAP'='UAP';
            'NSTEMI'='NSTEMI';
            'STEMI'='STEMI';
            'Hjertestans ved STEMI'='STEMI';
            'STEMI > 24h'='STEMI';
            'STEMI/Rescue PCI'='STEMI';
            ' Uklare brystsmerter'='Uklare brystsmerter';
            else='Annet';
            ") ,
    levels = c("Uklare brystsmerter","SAP","UAP","NSTEMI","STEMI","Annet") )


AP$ProsedyreDato <- as.Date( AP$ProsedyreDato)

AP$Year <- as.numeric(
    format(
        x = AP$ProsedyreDato ,
        format = "%Y"))

AP$nMonth <- as.numeric(
    as.factor(
        format(
            AP$ProsedyreDato ,
            format = "%m")))

AP$Day <- as.numeric(
         AP$ProsedyreDato - min( AP$ProsedyreDato , na.rm = TRUE ) )

AP$Month <- as.factor(
    format(
        x = AP$ProsedyreDato ,
        format = "%Y-%m"))

AP$Week <- format(
    x = AP$ProsedyreDato ,
    format = "%Y-%W")



AP$InnleggelseHenvisendeSykehusDato <- as.Date( AP$InnleggelseHenvisendeSykehusDato)

AP$AnkomstPCIDato <- as.Date( AP$AnkomstPCIDato)

i.direkte <- which(AP$HenvisningsStatus == "Direkte")
AP$InnleggelseHenvisendeSykehusDato[ i.direkte ] <- AP$AnkomstPCIDato[ i.direkte ]

AP$DaysFromIndexAdmissionToProcedure <- as.numeric( AP$ProsedyreDato - AP$InnleggelseHenvisendeSykehusDato )

# AP[ 1:10 , c("DaysFromIndexAdmissionToProcedure","ProsedyreDato","InnleggelseHenvisendeSykehusDato","AnkomstPCIDato","HenvisningsStatus")]

AP$DaysFromPCIcenterAdmissionToProcedure <- as.numeric( AP$ProsedyreDato - AP$AnkomstPCIDato )

AP$DaysFromIndexAdmissionToProcedure[ which( AP$DaysFromIndexAdmissionToProcedure < 0 ) ] <- NA
AP$DaysFromIndexAdmissionToProcedure[ which( AP$DaysFromIndexAdmissionToProcedure > 50 ) ] <- NA

AP$DelayFromIndexAdmissionToProcedure <- cut(
    x = AP$DaysFromIndexAdmissionToProcedure ,
    breaks = c(0,1,3,50) ,
    labels = c("0-24","25-72",">72") ,
    include.lowest = TRUE
    )

AP$DaysFromIndexAdmissionToPCIcenter <- as.numeric(AP$AnkomstPCIDato - AP$InnleggelseHenvisendeSykehusDato )



## Subsetting only NSTEMI
NSTEMI <- subset(
    x = AP ,
    subset = (Indikasjon == "NSTEMI"))

FromDate <- format( min(NSTEMI$ProsedyreDato,na.rm=TRUE) , format = "%d.%m.%Y")
ToDate <- format( max(NSTEMI$ProsedyreDato,na.rm=TRUE) , format = "%d.%m.%Y")

``` 




<div align="center" style="bold">
<h1>Ventetider ved NSTEMI</h1>
Norsk register for invasiv kardiologi
<br>
NORIC `r AP$Sykehusnavn[1]`
<br>
`r paste( FromDate , "-" , ToDate ) `
</div> 


<br><br><br>


## Innhold
- Oversikt over antall NSTEMI
- Alle NSTEMI prosedyrer
- Direkte innlagt i PCI sykehuset
- Henvist fra et annet sykehys


<br><br>


## Oversikt

<p>Tabell: Antall NSTEMI per måned og henvisnings status</p>

```{r,TabNNSTEMIHenvisningsStatus,results="as.is"}

TabNNSTEMIHenvisningsStatus <- addmargins(
    table(
        NSTEMI$Month ,
        NSTEMI$HenvisningsStatus
    )
)

htmlTable(TabNNSTEMIHenvisningsStatus)

```


<br><br>

<p align="center">Figur: Antall NSTEMI per måned og henvisnings status</p>

```{r,Fig-N-HenvisningsStatus,fig.width=16,fig.height=8}
pal <- colPrimary[c(1,3,5)]

op <- par(
    mfcol = c (1,1) ,
    xpd = NA ,
    mar = c(5.1,4.1,4.1,13.1) ,
    bg = "#EEEEEE")

barplot(
    xtabs(
        formula = ~ HenvisningsStatus + Month ,
        data = NSTEMI) ,
    las = 1 ,
    xlab = "Måned" ,
    ylab = "Antall" ,
    col = pal ,
    space = 0.2 ,
    border = FALSE)

legend(
    "right" ,
    inset = -.28 ,
    bty = "n" ,
    horiz = FALSE ,
    fill = pal[3:1],
    legend = sort(
        unique(AP$HenvisningsStatus) , 
        decreasing = T) ,
    cex = 1)

```



<br><br><br>
## Ventetid for NSTEMI

Ventetid i dager for all NSTEMI prosedyrer uansett henvisningsstatus.


<p align="center">Figur: Prosentandel NSTEMI i ventetidkategorier over tid</p>

```{r,Fig-R-NSTEMI-Delay,fig.width=16,fig.height=8}

pal <- c( "#A8A8A8" , RColorBrewer::brewer.pal(3,"RdYlGn") )[4:1]
DelayLevels <- c( levels(NSTEMI$DelayFromIndexAdmissionToProcedure ) , "Mangler")

TabNDelay <- xtabs(
    formula = ~ addNA(DelayFromIndexAdmissionToProcedure) + Month ,
    data = NSTEMI)

TabRDelay <- 100 * prop.table(
                        x = TabNDelay ,
                        margin = 2 )

par(
    mar = c(3,10,2,10) ,
    xpd = NA ,
    las = 1)

xBarplot <- barplot(
    TabRDelay ,
    beside = FALSE ,
    horiz = FALSE ,
    axisnames = TRUE ,
    xlab = "Måned" ,
    col = pal )

text(
    x = xBarplot ,
    y = TabRDelay[1,] ,
    pos = 1 ,
    col = "#000000AA" ,
    labels = TabNDelay[1,])

text(
    x = xBarplot ,
    y = colSums(TabRDelay[1:2,]) ,
    pos = 1 ,
    col = "#000000AA" ,
    labels = TabNDelay[2,])

text(
    x = xBarplot ,
    y = colSums(TabRDelay[1:3,]) ,
    pos = 1 ,
    col = "#000000AA" ,
    labels = TabNDelay[3,])

legend(
    x = par("usr")[2] ,
    y = par("usr")[4]*.7 ,
    bty = "n" ,
    title = "Timer" ,
    legend = DelayLevels[4:1],
    fill = pal[4:1] )

```


<br><br><br>


<p align="center">Figur: Boxplottet viser 25-, 50- (=median) og 75-persentilene av dager fra førstegangs innleggelse til prosdyre for alle NSTEMI pasienter fra `r FromDate` ved `r AP$Sykehusnavn[1]`.</p>

```{r,Fig-Boxplot-NSTEMI-Delay,fig.width=16,fig.height=8}

ggplot(
    data = NSTEMI ,
    mapping = aes(
        x = Month ,
        y = DaysFromIndexAdmissionToProcedure
    )
)+
    geom_boxplot(
        alpha = 0.7 ,
        varwidth = TRUE ,
        outlier.colour = NA ,
        coef = 0 ,
        na.rm = TRUE 
    )+
    scale_y_continuous( name = "Dager" , limits = c(0,7 ))+
    scale_x_discrete( name = "Måned" , labels = gsub( "20..-" , "" , levels(NSTEMI$Month)) )+
    geom_vline(xintercept = 0:3*12+.5)


```




<br><br><br>

<p align="center">Figur: Smoothing spline for 25-, 50- (=median) og 75-persentilene av dager fra førstegangs innleggelse til prosdyre for alle NSTEMI pasienter fra `r FromDate` til `r ToDate` som er direkte innlagt ved `r AP$Sykehusnavn[1]`. Viser litt det samme som boxplot, bare at måneder er ikke sammenslått, men prosedyredato er kontinuerlig på x-aksen.</p>

```{r}

fit.rqss <- function( tau , lambda )
    quantreg::rqss(
        DaysFromIndexAdmissionToProcedure ~ qss(
            x = Day ,
            lambda = lambda ) ,
        tau = tau ,
        data = na.exclude(
            NSTEMI[
                  ,
                   c(
                       "DaysFromIndexAdmissionToProcedure" ,
                       "Day" )]))


get.qss <- function(model){
    fit <- model$qss$Day$xyz
    fit[,2] <- fit[,2] + model$coef[1]
    return(fit)
}

par( mar = c(5,4,2,4) , las = 1)

NofMonth <- length(levels(NSTEMI$Month))
maxDays <- 8

 # create a monthly count of NSTEMI
NbyM <- data.frame(
    m = 365/NofMonth * ( 2*1:NofMonth - 1 ) ,
    n = as.numeric( table( NSTEMI$Month )))

 # rescale the counts to the [0,13] (ylim of main plot)
NbyM$nRescaled <- (NbyM$n)/6


plot(
    0 ,
    xlim = range( NSTEMI$Day) ,
    ylim = c(0,maxDays) ,
    type = "n" ,
    bty = "n" ,
    xlab = "Month of Procedure" ,
    ylab = "Days from Index Admission to Procedure" ,
    main = "" ,
    axes = FALSE)

axis(
    side = 1 ,
    tick = FALSE ,
    at = 30.5*(1:NofMonth-1) ,
    labels = gsub( "20..-" , "" , levels(NSTEMI$Month)))

axis(
    side = 2 )

segments(
    x0 = 365/12*0:NofMonth ,
    y0 = 0 ,
    x1 = 365/12*0:NofMonth ,
    y1 = maxDays ,
    lty = 3 ,
    lwd = 0.8 ,
    col = "#80808080")

abline(
    h = 0:maxDays ,
    lty = 3 ,
    lwd = 0.8 ,
    col = "#80808080")

abline(
    h = 3 ,
    v = 365*0:3 ,
    lty = 3 ,
    lwd = 2 ,
    col = "#80808080")


points(
    jitter(DaysFromIndexAdmissionToProcedure) ~ Day ,
    data = NSTEMI ,
    pch = 16 ,
    col = "#A0A0A030")


lines(pspline::sm.spline( NbyM$m , NbyM$nRescaled , df = 4) , lwd = 5 , col = "#FFFFFFAA")
lines( pspline::sm.spline(get.qss( fit.rqss( tau = 0.75 , lambda = 50)) , df = 8 ) , lwd = 5 , col = "#FFFFFFAA")
lines( pspline::sm.spline(get.qss( fit.rqss( tau = 0.50 , lambda = 50)) , df = 8 ) , lwd = 5 , col = "#FFFFFFAA")
lines( pspline::sm.spline(get.qss( fit.rqss( tau = 0.25 , lambda = 50)) , df = 8 ) , lwd = 5 , col = "#FFFFFFAA")


lines(pspline::sm.spline( NbyM$m , NbyM$nRescaled , df = 4) , lwd = 3 , col = "#A0C0F0AA")
lines( pspline::sm.spline(get.qss( fit.rqss( tau = 0.75 , lambda = 30 )) , df = 8 ) , lwd = 3 , col = "#A0A0A0AA")
lines( pspline::sm.spline(get.qss( fit.rqss( tau = 0.50 , lambda = 30 )) , df = 8 ) , lwd = 3 , col = "#A0A0A0AA")
lines( pspline::sm.spline(get.qss( fit.rqss( tau = 0.25 , lambda = 30 )) , df = 8 ) , lwd = 3 , col = "#A0A0A0AA")

```




<hline>
<br><br><br><br><br><br>

## Overflyttet til PCI sykehus

<p align="center">Figur: Prosentandel NSTEMI i ventetidkategorier over tid for overflyttede pasienter</p>

```{r,Fig-R-NSTEMI-Delay-Transferred,fig.width=16,fig.height=8}

pal <- c( "#A8A8A8" , RColorBrewer::brewer.pal(3,"RdYlGn") )[4:1]
DelayLevels <- c( levels(NSTEMI$DelayFromIndexAdmissionToProcedure ) , "Mangler")

TabNDelayTrans <- xtabs(
    formula = ~ addNA(DelayFromIndexAdmissionToProcedure) + Month ,
    subset = HenvisningsStatus == "Overflyttet" ,
    data = NSTEMI)

TabRDelayTrans <- 100 * prop.table(
                        x = TabNDelayTrans ,
                        margin = 2 )

par(
    mar = c(3,10,2,10) ,
    xpd = NA ,
    las = 1)

xBarplot <- barplot(
    TabRDelayTrans ,
    beside = FALSE ,
    horiz = FALSE ,
    axisnames = TRUE ,
    xlab = "Måned" ,
    col = pal )

text(
    x = xBarplot ,
    y = TabRDelayTrans[1,] ,
    pos = 1 ,
    col = "#000000AA" ,
    labels = TabNDelayTrans[1,])

text(
    x = xBarplot ,
    y = colSums(TabRDelayTrans[1:2,]) ,
    pos = 1 ,
    col = "#000000AA" ,
    labels = TabNDelayTrans[2,])

text(
    x = xBarplot ,
    y = colSums(TabRDelayTrans[1:3,]) ,
    pos = 1 ,
    col = "#000000AA" ,
    labels = TabNDelayTrans[3,])

legend(
    x = par("usr")[2] ,
    y = par("usr")[4]*.7 ,
    bty = "n" ,
    title = "Timer" ,
    legend = DelayLevels[4:1],
    fill = pal[4:1] )


```


<br><br><br>


## Direkte innlagt i PCI sykehus

<p align="center">Figur: Prosentandel NSTEMI i ventetidkategorier over tid for pasienter direkte innlagt i PCI sykehus</p>

```{r,Fig-R-NSTEMI-Delay-Direct,fig.width=16,fig.height=8}

pal <- c( "#A8A8A8" , RColorBrewer::brewer.pal(3,"RdYlGn") )[4:1]
DelayLevels <- c( levels(NSTEMI$DelayFromIndexAdmissionToProcedure ) , "Mangler")

TabNDelayDirect <- xtabs(
    formula = ~ addNA(DelayFromIndexAdmissionToProcedure) + Month ,
    subset = HenvisningsStatus == "Direkte" ,
    data = NSTEMI)

TabRDelayDirect <- 100 * prop.table(
                        x = TabNDelayDirect ,
                        margin = 2 )

par(
    mar = c(3,10,2,10) ,
    xpd = NA ,
    las = 1)

xBarplot <- barplot(
    TabRDelayDirect ,
    beside = FALSE ,
    horiz = FALSE ,
    axisnames = TRUE ,
    xlab = "Måned" ,
    col = pal )

text(
    x = xBarplot ,
    y = TabRDelayDirect[1,] ,
    pos = 1 ,
    col = "#000000AA" ,
    labels = TabNDelayDirect[1,])

text(
    x = xBarplot ,
    y = colSums(TabRDelayDirect[1:2,]) ,
    pos = 1 ,
    col = "#000000AA" ,
    labels = TabNDelayDirect[2,])

text(
    x = xBarplot ,
    y = colSums(TabRDelayDirect[1:3,]) ,
    pos = 1 ,
    col = "#000000AA" ,
    labels = TabNDelayDirect[3,])

legend(
    x = par("usr")[2] ,
    y = par("usr")[4]*.7 ,
    bty = "n" ,
    title = "Timer" ,
    legend = DelayLevels[4:1],
    fill = pal[4:1] )


```


<br><br><br>


<p align="center">Figur: Boxplottet viser 25-, 50- (=median) og 75-persentilene av dager fra førstegangs innleggelse til prosdyre for alle NSTEMI pasienter fra `r FromDate` til `r ToDate` som er direkte innlagt ved `r AP$Sykehusnavn[1]`.</p>

```{r,Fig-Boxplot-NSTEMI-Delay-Direct,fig.width=16,fig.height=8}

ggplot(
    data = subset(
        NSTEMI ,
        HenvisningsStatus = "Direkte") ,
    mapping = aes(
        x = Month ,
        y = DaysFromIndexAdmissionToProcedure
    )
)+
    geom_boxplot(
        alpha = 0.7 ,
        varwidth = TRUE ,
        outlier.colour = NA ,
        coef = 0 ,
        na.rm = TRUE 
    )+
    scale_y_continuous( name = "Dager" , limits = c(0,7 ))+
    scale_x_discrete( name = "Måned" , labels = gsub( "20..-" , "" , levels(NSTEMI$Month)) )+
    geom_vline(xintercept = 0:3*12+.5)


```

