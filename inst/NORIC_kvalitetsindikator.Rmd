---
title: Norsk register for invasiv kardiologi (NORIC)
subtitle: | 
  |
  | Rapport med resultater fra enkelte kvalitetsindikatorer
  |
  | __`r paste0(params$hospitalName)`__

author: ""
date: "`r format(Sys.time(), '%d. %B %Y')`"
output:
  pdf_document: default
  html_document:
    df_print: paged
linkcolor: darkblue
header-includes:
- \usepackage[english, norsk]{babel}
- \usepackage{booktabs}
- \usepackage{rotating}
- \usepackage{float}
params:
  hospitalName: hospital
  reshID: 999999
  author: Anon author
  userRole: Ukjent
  tableFormat: latex
  registryName: registry
---


```{r knitrOptions, include=FALSE}
library(magrittr)
library(knitr)
library(kableExtra)
library(dplyr)
library(tidyr)
library(ggplot2)
library(noric)
# library(gridExtra) Sjekk om rapporten fungerer uten denne pakken


# make sure to use a temporary directory AND absolute paths, e.g. that figs
# can be found also when deployed at a server. See below link for explanation
# https://rgriff23.github.io/2017/04/25/how-to-knit-for-mysite.html
# Also make sure we use tempdir() as working directory so we do not clutter
# the package of the hosting shiny app
# workDir <- tempdir()
# knitr::opts_knit$set(base.dir=workDir, base.url=file.path(paste0(tempdir(), "/")), root.dir = workDir)

# Handle both html and latex (pdf) output. Actually to avoid setting 'format'
# for each kable call
# inspired by https://stackoverflow.com/questions/46080853/why-does-rendering-a-pdf-from-rmarkdown-require-closing-rstudio-between-renders
options(knitr.table.format = params$tableFormat)

knitr::opts_chunk$set(warnings = FALSE, echo = FALSE)
options(stringsAsFactors = FALSE)
``` 


```{r SKDEcol, include=FALSE}
colPrimary <- c("#000059", "#084594", "#2171b5", 
                "#4292c6", "#6baed6", "#c6dbef")
colNeutral <- c("#4D4D4D", "#737373", "#A6A6A6", "#DADADA")
colKontrast <- "#FF7260"
``` 



```{r latest_entry, include=FALSE, eval=TRUE}
# DATAGRUNNLAG: PERIODE FOR SQL SPØRRING

# NYESTE DATO: 
# Finne nyeste prosedyredato (=nyeste registrering). Vi ønsker ikke at 
# forhåndsregisrerte planlagte forløp kommer med i rapporten. Derfor brukes
# gårsdagens dato som referanse, ingen forløp etter denne kommer med .  
# Vi vil dermed også kunne se dersom ingen nye registreringer gjøres eller om
# overføringer har stoppet opp

# ELDSTE DATO: 
# Januar fra i fjor (hele foregående år skal vise i rapporten)
nyeste_reg <- noric::getLatestEntry(registryName = params$registryName)

periode_data <- data.frame(
  siste_dato = min((as.Date(Sys.time()) - 1), 
                   nyeste_reg)) 

periode_data %<>% 
  dplyr::mutate(
    
    # Inneværende år: 
    nyesteRegYear = as.numeric(format(.data$siste_dato, format = "%Y")),
    
    # Fjoråret
    sisteHeleYear = .data$nyesteRegYear -1, 
    
    # Første dato for SQL -spørring : 01. januar fjoråret
    forste_dato  = as.Date(paste0(sisteHeleYear, "-01-01"), format = "%Y-%m-%d"))
```









```{r GetData, include=FALSE, cache=FALSE}

sS_nasjonalt <- noric::getPrepSsData(registryName = params$registryName, 
                                     fromDate  = periode_data$forste_dato, 
                                     toDate = periode_data$siste_dato, 
                                     singleRow = FALSE)

# Hardkodet 2018- dags dato pga figur 4,5 og 6
aP_nasjonalt <- noric::getPrepApData(
  params$registryName, 
  fromDate  = as.Date("2018-01-01", format = "%Y-%m-%d"),  
  toDate = periode_data$siste_dato, 
  singleRow = FALSE)

aK_nasjonalt <- noric::getPrepAkData(registryName = params$registryName, 
                                     fromDate  = periode_data$forste_dato, 
                                     toDate = periode_data$siste_dato, 
                                     singleRow = FALSE)

anD_nasjonalt <- noric::getPrepAnDData(registryName = params$registryName, 
                                       fromDate  = periode_data$forste_dato, 
                                       toDate = periode_data$siste_dato, 
                                       singleRow = FALSE)
```



```{r yearTabPrepare, include=FALSE, eval=TRUE}
timeTableYear <- data.frame(
  Year = 2018:periode_data$sisteHeleYear)
```


```{r kvartalTabPrepare, include=FALSE, eval=TRUE}
# 5 siste ferdige kvartal
forsteDatoKvartal <- lubridate::floor_date(periode_data$siste_dato, 
                                           "quarter") 
timeTableQuarter <- data.frame(
  KvartalDatoStart = rev(seq(forsteDatoKvartal, 
                             by = "-1 quarter",
                             length.out = 6)[2:6])) %>% 
  dplyr::transmute(
    kvartal = paste0(lubridate::year(.data$KvartalDatoStart), 
                     " Q", 
                     lubridate::quarter(.data$KvartalDatoStart, 
                                        with_year = FALSE)))
```

```{r monthTabPrepare, include=FALSE, eval=TRUE}
# Hele forrige år og alle påbegynte måneder hittil i år
forsteDatoSisteMonth <- lubridate::floor_date(periode_data$siste_dato, 
                                              "month") 
timeTableMonth <- data.frame(
  monthDato = seq(as.Date(paste0(periode_data$sisteHeleYear, 
                                 "-01-01")), 
                  forsteDatoSisteMonth,
                  by = "month")) %>% 
  dplyr::transmute(maaned = as.factor(format(x = .data$monthDato, 
                                             format = "%Y-%m")))
```


```{r sSPrepare,include=FALSE, eval=TRUE}
sS_nasjonalt %<>% 
  dplyr::select(.data$ProsedyreDato,
                .data$StentType, 
                .data$Segment, 
                .data$Graft,
                .data$ForlopsID,
                .data$Sykehusnavn, 
                .data$AvdRESH, 
                .data$aar, 
                .data$maaned, 
                .data$kvartal) 
```


```{r aPPrepare,include=FALSE, eval=TRUE}

aP_nasjonalt %<>% 
  dplyr::select(
    .data$AvdRESH,
    .data$Sykehusnavn,
    .data$Regtype, 
    .data$PrimaerForlopsID,
    .data$ProsedyreDato,
    .data$ProsedyreTid,
    .data$ProsedyreType,
    .data$OverflyttetFra, 
    .data$AnkomstPCIDato,
    .data$AnkomstPCITid, 
    .data$InnleggelseHenvisendeSykehusDato,
    .data$InnleggelseHenvisendeSykehusTid,
    .data$Innkomstarsak,
    .data$Indikasjon, 
    .data$Hastegrad,
    .data$BesUtlEKGDato, 
    .data$BesUtlEKGTid,
    .data$BeslutningsutlosendeEKG,
    .data$GittTrombolyse, 
    .data$HLRForSykehus,
    .data$KobletForlopsID,
    .data$ForlopsType2, 
    .data$IFR, 
    .data$FFR, 
    .data$IVUS, 
    .data$OCT, 
    .data$ForlopsID, 
    .data$ASA, 
    .data$AndrePlatehemmere,
    .data$AndrePlatehemmere,
    .data$Antikoagulantia,
    .data$UtskrStatiner, 
    .data$TidlABC, 
    .data$UtskrevetDod, 
    .data$SkjemaStatusStart, 
    .data$SkjemastatusHovedskjema, 
    .data$SkjemaStatusUtskrivelse, 
    .data$SkjemaStatusKomplikasjoner
  ) %>% 
  
  noric::utlede_OppholdsID(.) %>% 
  
  noric::utlede_ferdigstilt(df = .,
                            var = .data$SkjemaStatusStart,
                            suffix = "StartSkjema") %>%
  noric::utlede_ferdigstilt(df = .,
                            var = .data$SkjemastatusHovedskjema,
                            suffix = "HovedSkjema") %>%
  noric::utlede_ferdigstilt(df = .,
                            var = .data$SkjemaStatusUtskrivelse,
                            suffix = "UtskrSkjema") %>%
  noric::utlede_ferdigstilt(df = .,
                            var = .data$SkjemaStatusKomplikasjoner,
                            suffix = "KomplikSkjema") %>% 
  
  noric::legg_til_antall_stent(df_ap = ., df_ss = sS_nasjonalt) %>% 
  noric::legg_til_antall_stent_opphold(df_ap = .) %>% 
  noric::satt_inn_stent_i_lms(df_ap = ., df_ss = sS_nasjonalt) %>% 
  
  #  Legge til utledete variabler fra annen Diagnostikk. Hjelpevariabler for
  # trykkmåling. Disse fjernes før tabellen legges i utforsker
  noric::legg_til_trykkmaalinger(df_ap = .,
                                 df_ad = anD_nasjonalt) %>% 
  
  # LEgg til hjelpevariabler for ventetider
  noric::legg_til_ventetid_nstemi_timer(.) %>% 
  noric::legg_til_ventetid_stemi_min(.) %>% 
  
  # Legge til kvalitetsindikatorene:
  noric::ki_ferdigstilt_komplikasjoner(df_ap = .) %>% 
  noric::ki_trykkmaaling_utfoert(df_ap = .) %>% 
  noric::ki_ivus_oct_ved_stenting_lms(df_ap = .) %>% 
  noric::ki_foreskr_blodfortynnende(df_ap = .) %>% 
  noric::ki_foreskr_kolesterolsenkende(df_ap = .) %>%
  noric::ki_nstemi_utredet_innen24t() %>% 
  noric::ki_nstemi_utredet_innen72t() %>% 
  noric::ki_stemi_pci_innen120min() %>% 
  
  dplyr::mutate(
    maaned = as.factor(format(x = .data$ProsedyreDato, format = "%Y-%m")), 
    aar = lubridate::year(.data$ProsedyreDato), 
    kvartal = paste0(lubridate::year(.data$ProsedyreDato), 
                     " Q", 
                     lubridate::quarter(.data$ProsedyreDato, 
                                        with_year = FALSE))) %>% 
  dplyr::mutate(admissionType = dplyr::case_when(
    .data$OverflyttetFra == "Annet sykehus" ~ "Overflyttet", 
    .data$OverflyttetFra %in% c("Nei, direkte inn til dette sykehus", 
                                "Omdirigert ambulanse") ~ "Direkte",
    TRUE ~ NA_character_
  ))

```


```{r aKPrepare,include=FALSE, eval=TRUE}

aK_nasjonalt %<>% 
  dplyr::select(
    .data$ProsedyreDato,
    .data$AvdKompPacemaker, 
    .data$LabKompDod, 
    .data$TypeKlaffeprotese,
    .data$ScreeningBeslutning, 
    .data$Sykehusnavn, 
    .data$AvdRESH, 
    .data$ForlopsID, 
    .data$Pacemaker,
    .data$SkjemaStatusHovedskjema,
    .data$aar)

aK_nasjonalt %<>%
  dplyr::filter(.data$aar >= 2019) %>% 
  dplyr::mutate(
    
    kvartal = paste0(
      lubridate::year(.data$ProsedyreDato),
      " Q",
      lubridate::quarter(.data$ProsedyreDato, with_year = FALSE)), 
    
    ProsedyreType = factor(
      x = dplyr::case_when(
        
        .data$ScreeningBeslutning %in% c("TAVI + PCI", "TAVI") &
          !is.na(.data$TypeKlaffeprotese) ~ "TAVI med klaff", 
        
        .data$ScreeningBeslutning %in% c("TAVI + PCI", "TAVI") &
          is.na(.data$TypeKlaffeprotese) ~ "TAVI uten klaff", 
        
        ScreeningBeslutning %in% c("BAV") &
          !is.na(TypeKlaffeprotese) ~ "BAV med klaff", 
        
        
        .data$ScreeningBeslutning %in% c("BAV") &
          is.na(.data$TypeKlaffeprotese) ~ "BAV uten klaff",
        
        TRUE ~ NA_character_), 
      levels = c("TAVI med klaff", 
                 "TAVI uten klaff", 
                 "BAV med klaff", 
                 "BAV uten klaff"), 
      ordered =TRUE), 
    
    indik_ak_pacemakerbehov_data = dplyr::if_else(
      
      # Ekskluderer de som døde grunnet komplikasjon på lab siden det ikke går an
      # å registrere AvdKomplikasjon hvis det forekom en komplikasjon på lab:
      !.data$LabKompDod %in% "Ja" &
        
        # Alle som har fått satt inn klaff, uansett ScreeningBeslutning
        .data$ProsedyreType %in% c("TAVI med klaff", "BAV med klaff") &
        
        # Ekskluder de som allerede hadde PM:
        # Pacemaker %in% c("Nei", NA, "Ukjent),
        !.data$Pacemaker %in% "Ja",
      
      true = "ja", 
      false = "nei", 
      missing = "nei"), 
    
    # Pacemakerbehov etter kateterbasert innsetting av aortaklaff
    indik_ak_pacemakerbehov = dplyr::case_when(
      
      .data$indik_ak_pacemakerbehov_data == "ja" & 
        .data$SkjemaStatusHovedskjema == 1 & 
        .data$AvdKompPacemaker == "Ja" ~ "ja", 
      
      .data$indik_ak_pacemakerbehov_data == "ja" &
        .data$SkjemaStatusHovedskjema == 1 & 
        ! .data$AvdKompPacemaker %in% "Ja" ~ "nei", 
      
      .data$indik_ak_pacemakerbehov_data == "ja" &
        .data$SkjemaStatusHovedskjema %in% c(-1, 0) ~ "ikke ferdigstilt", 
      
      TRUE ~ NA_character_))

```

```{r nyesteRegistrering_ak, include=FALSE, eval=TRUE}
nyeste_registrering_ak <- aK_nasjonalt %>% 
  summarise(nyesteReg_max = max(.data$ProsedyreDato)) %>% 
  # Bruke gårsdagens dato som referanse. Dersom ingen nye registreringer 
  # (eller overføringer har stoppet opp), brukes nyeste registrering som ref.
  # Unngår at forhåndsregisrerte planlagte forløp kommer med i rapporten.
  mutate(nyesteReg = min((as.Date(Sys.time())-1), 
                         .data$nyesteReg_max))
```



```{r dimAK_lokalt, include=FALSE, eval=TRUE}
dim_ak_lokalt <- aK_nasjonalt %>% 
  dplyr::filter(.data$AvdRESH == params$reshID) %>% 
  dim(.)
```


```{r kvartalTabPrepare_AK, include=FALSE, eval=TRUE}
if (dim_ak_lokalt[1] > 10) {
  
   # 5 siste ferdige kvartal
  forsteDatoKvartalAK <- lubridate::floor_date(nyeste_registrering_ak$nyesteReg, 
                                               "quarter") 
  timeTableQuarterAK <- data.frame(
    KvartalDatoStart = rev(seq(forsteDatoKvartalAK, 
                               by = "-1 quarter",
                               length.out = 6)[2:6])) %>% 
    dplyr::transmute(
      kvartal = paste0(lubridate::year(.data$KvartalDatoStart), 
                       " Q", 
                       lubridate::quarter(.data$KvartalDatoStart, 
                                          with_year = FALSE)))
}
```

\
Denne rapporten er generert ved hjelp av NORIC sin resultatløsning 
_Rapporteket_ og sendes ut per e-post til personer i fagmiljøet som på forhånd 
har bestilt denne tjenesten. Rapporten er kun ment til internt bruk!

\
Rapporten inneholder tabeller og figurer med resultater basert på forløp 
registrert ved `r paste0(params$hospitalName)`, samt nasjonale data for 
bedre sammenligningsgrunnlag. Opptellinger og statistikker er gjort per 
forløp/prosedyre, og ikke per individ. 

\
De fleste tabellene presenteres per måned hittil i år, samt
det siste hele året, mens figurene inneholder resultater bare til og med
foregående måned. Siste
innregistrering som teller med i datagrunnlaget for denne rapporten er 
`r format(nyeste_registrering_ap$nyesteReg, '%d. %B %Y')`. 

\
Eventuelle spørsmål knyttet til rapporten kan rettes til 
[noric@helse-bergen.no](mailto:noric@helse-bergen.no)


```{r pagebreakForside, results = "asis", eval = (params$tableFormat == "latex")}
cat("\n\n\\pagebreak\n")
```



## Grad av ferdigstilt komplikasjonsskjema

Opplysninger om komplikasjoner er viktig for å kunne vurdere behandlingskvalitet
og risiko. Dersom de aktuelle registreringsskjemaene ikke er ferdigutfylt, blir 
datagrunnlaget for videre analysearbeid for dårlig. Indikatoren måler andel
ferdigstilte registreringsskjema for komplikasjoner oppstått på sykehus etter
prosedyre. Alle pasientforløp er inkludert. (Mål $\geq$ 95 %)

```{r TabNFerdigstiltKompl, results='asis', warning=FALSE}

#Lokalt
ferdigstilt_lokalt <- aP_nasjonalt %>% 
  dplyr::filter(.data$AvdRESH == params$reshID) %>% 
  dplyr::filter(.data$indik_komplik_ferdig_data == "ja") %>% 
  janitor::tabyl(.data$maaned, 
                 .data$indik_komplik_ferdig, 
                 show_missing_levels = TRUE) %>% 
  janitor::adorn_totals("col", name = "Totalt") %>% 
  dplyr::mutate(
    
    Prosent = paste0(round(.data$ja / .data$Totalt * 100, 1), 
                     " %"),
    
    Totalt = ifelse(.data$Totalt < 5,
                    yes = "N",
                    no = .data$Totalt),
    
    Ferdigstilt = ifelse(.data$Totalt == "N",
                         yes = NA,
                         no = .data$ja),
    
    Prosent = ifelse(.data$Totalt == "N",
                     yes = NA,
                     no = .data$Prosent)) %>% 
  dplyr::select(.data$maaned, .data$Totalt, .data$Ferdigstilt, .data$Prosent)


#Nasjonalt
ferdigstilt_nasjonalt <- aP_nasjonalt %>% 
  dplyr::filter(.data$indik_komplik_ferdig_data == "ja") %>% 
  janitor::tabyl(.data$maaned,
                 indik_komplik_ferdig,
                 show_missing_levels = TRUE) %>% 
  janitor::adorn_totals("col", name = "Totalt") %>% 
  dplyr::transmute(
    maaned = as.factor(.data$maaned), 
    Nasjonalt = paste0(round(.data$ja / .data$Totalt * 100, 1), " %")) 



#Tabell
tabFerdigtiltKompl <- timeTableMonth %>% 
  dplyr::left_join(., ferdigstilt_lokalt, by = c("maaned")) %>% 
  dplyr::left_join(., ferdigstilt_nasjonalt, by = "maaned") %>% 
  dplyr::rename("Måned" = .data$maaned) %>% 
  replace(is.na(.), "-")


cap <- "Antall og andel ferdigstilte komplikasjonsskjemaer etter måned. Måneder med mindre enn 5 observasjoner er markert med N."

noric::mst(tab = tabFerdigtiltKompl, 
           type = params$tableFormat,
           cap = cap,
           digs = c(0, 0, 1, 1), 
           align = rep("c", 4), 
           label = "tabFerdigtiltKompl")
```


```{r pagebreakFerdigstilt, results = "asis", eval = (params$tableFormat == "latex")}
cat("\n\n\\pagebreak\n")
```

## Invasiv utredning ved NSTEMI

Ved hjerteinfarkt uten ST-elevasjon i EKG (NSTEMI) er blodåren ofte ikke helt 
tett, men det er risiko for at den kan bli det. Europeiske retningslinjer
anbefaler derfor at pasienter med NSTEMI får utført invasiv koronar utredning 
innen 24 timer, mens en norsk nasjonal kvalitetsindikator anbefaler at dette 
skjer innen 72 timer. Registeret presenterer data for begge disse indikatorene
som andel pasienter med indikasjon NSTEMI der koronar angiografi har blitt
utført innen 24 og 72 timer etter innleggelse i sykehus. Det er således to 
ulike kvalitetsindikatorer som gjelder for ventetid på utredning ved NSTEMI
med målnivå på henholdsvis 50 % og 80 %.


### Invasiv utredning ved NSTEMI innen 24 timer

```{r ventetid24t_NSTEMI, results='asis', warning=FALSE}
cap <- "Antall og andel pasienter med indikasjon NSTEMI som innen 24 timer etter innleggelse i sykehus har blitt utredet med invasiv koronar angiografi. Tabellen inkluderer både pasienter innlagt direkte på PCI-sykehus og pasienter overflyttet fra annet sykehus. Pasienter overflyttet fra annen avdeling på samme sykehus er ekskludert.
Komplett data ved direkte innleggelse er der både tid for ankomst PCI-sykehus og tid for arteriepunksjon er registrert. For forløp der pasienten har blitt overført fra et annet sykehus, er komplett data der både tid for innleggelse i henvisende sykehus og tid for arteriepunksjon er registrert. Måneder med mindre enn 50\\% komplett data eller færre enn 5 forløp blir markert med stjerne og prosent forløp med ventetid under 24 timer regnes ikke ut for disse. (Målnivå: 50 \\%)"


nstemi_24t_lokalt <- aP_nasjonalt %>% 
  dplyr::filter(.data$AvdRESH == params$reshID) %>% 
  dplyr::filter(.data$indik_nstemi_angio_innen24t_data == "ja") %>% 
  janitor::tabyl(.data$maaned, 
                 .data$indik_nstemi_angio_innen24t,
                 show_missing_levels = TRUE ) %>% 
  janitor::adorn_totals("col", name = "Total") %>% 
  dplyr::mutate(
    # Komplette er alle som er ja/nei, men ikkje ugyldig/manglende
    komplette_antall = .data$ja + .data$nei, 
    komplette_prosent =  .data$komplette_antall / .data$Total, 
    komplette_tekst = dplyr::if_else(
      .data$komplette_prosent < 0.50 | .data$komplette_antall < 5,
      true = paste0(.data$komplette_antall, " av ", .data$Total, "*"),
      false = paste0(.data$komplette_antall, " av ", .data$Total), 
      missing = NA_character_), 
    
    # Blandt komplette: Antall NTSTEMI innen 24 t , 
    nstemi_24t_tekst = dplyr::if_else(
      .data$komplette_prosent < 0.50 | .data$komplette_antall < 5,
      true = paste0(.data$ja, " av ", .data$komplette_antall, " (-%)"), 
      false = paste0(.data$ja, " av ", .data$komplette_antall, " (",
                     round(100 * .data$ja / .data$komplette_antall, 1), "%)"), 
      missing = NA_character_)) %>% 
  dplyr::select(.data$maaned, 
                .data$komplette_tekst, 
                .data$nstemi_24t_tekst)


nstemi_24t_nasjonalt <- aP_nasjonalt %>% 
  dplyr::filter(.data$indik_nstemi_angio_innen24t_data == "ja", 
                .data$indik_nstemi_angio_innen24t %in% c("ja", "nei")) %>% 
  janitor::tabyl(.data$maaned, 
                 .data$indik_nstemi_angio_innen24t,
                 show_missing_levels = TRUE) %>% 
  dplyr::mutate(
    # Komplette er alle som er ja/nei, men ikkje ugyldig/manglende
    komplette_antall = .data$ja + .data$nei, 
    
    # Blandt komplette: Antall NTSTEMI innen 24 t , 
    Nasjonalt = paste0(.data$ja, " av ", .data$komplette_antall, " (",
                       round(100 * .data$ja / .data$komplette_antall, 1), 
                       "%)")) %>% 
  dplyr::select(.data$maaned, 
                .data$Nasjonalt)


# Forberede tabell, bruke kompletthet og ventetid
tabVentetid24t <- timeTableMonth %>% 
  dplyr::left_join(., nstemi_24t_lokalt, by = c("maaned")) %>% 
  dplyr::left_join(., nstemi_24t_nasjonalt, by = c("maaned")) %>% 
  dplyr::rename(
    "Måned" = .data$maaned,
    "Antall komplette data av totale antall data" = .data$komplette_tekst,
    "Antall NSTEMI innen 24t av komplett data" = .data$nstemi_24t_tekst) %>%
  replace(is.na(.), "-")




noric::mst(tab = tabVentetid24t, 
           type = params$tableFormat, 
           cap = cap,
           digs = c(0, 0, 0, 1, 1), 
           align = rep("c", 5), 
           label = "tabVentetid24t")
```


```{r pagebreakVentetidNSTEMIfigLinje, results = "asis", eval = (params$tableFormat == "latex")}
cat("\n\n\\pagebreak\n")
```

### Figurer - Invasiv utredning ved NSTEMI innen 24 timer

```{r nstemi_komplette, results='asis', warning=FALSE}
# Lokalt: Andel komplette under 50% per måned? 
nstemi_komplette <- aP_nasjonalt %>% 
  dplyr::filter(.data$AvdRESH == params$reshID,
                .data$indik_nstemi_angio_innen24t_data == "ja") %>% 
  janitor::tabyl(.data$maaned, 
                 .data$indik_nstemi_angio_innen24t,
                 show_missing_levels = TRUE) %>% 
  janitor::adorn_totals("col", name  = "Totalt") %>% 
  transmute(
    maaned = .data$maaned, 
    komplette_antall = (.data$ja + .data$nei),
    komplette_andel = .data$komplette_antall / .data$Totalt)


```



```{r hittilIAar_24t_lokalt, results='asis', warning=FALSE}

# Hele siste år + alle fullførte måneder i dette året.
forsteDagFigur_ventetid <- paste0(periode_data$sisteHeleYear, "-01-01")
sisteDagFigur_ventetid <- lubridate::floor_date(x = periode_data$siste_dato,
                                                unit = "month")


# LOKALT : For NSTEMI med komplette forløp
prep_figVentetid24t_lokalt <- aP_nasjonalt %>% 
  dplyr::filter(.data$AvdRESH == params$reshID) %>% 
  dplyr::filter(.data$indik_nstemi_angio_innen24t_data == "ja", 
                .data$indik_nstemi_angio_innen24t %in% c("ja", "nei")) %>% 
  dplyr::filter(.data$ProsedyreDato >= forsteDagFigur_ventetid,
                .data$ProsedyreDato < sisteDagFigur_ventetid) %>% 
  
  #Samlet *(Direkte og overflyttet)
  dplyr::group_by(.data$maaned) %>% 
  dplyr::mutate(
    innen_24t_samlet = sum(.data$indik_nstemi_angio_innen24t == "ja", 
                           na.rm = TRUE)/n(),
    n_samlet = n()) %>% 
  dplyr::ungroup() %>% 
  
  # per admission type (Direkte / OVerflyttet)
  dplyr::group_by(.data$maaned, .data$admissionType) %>% 
  dplyr::mutate(
    innen_24t_type = sum(.data$indik_nstemi_angio_innen24t == "ja",
                         na.rm = TRUE)/n()) %>% 
  dplyr::ungroup() %>% 
  
  # Beholde en rad per Samlet, Direkte, OVerflyttet : 
  dplyr::count(.data$maaned, 
               .data$admissionType,
               .data$innen_24t_type, 
               .data$innen_24t_samlet, 
               .data$n_samlet) %>% 
  tidyr::pivot_longer(cols = starts_with("innen_24t_"), names_to = "Type") %>% 
  dplyr::mutate(name = dplyr::case_when(
    
    .data$admissionType == "Direkte" & 
      .data$Type == "innen_24t_type" ~ "Direkte", 
    
    .data$admissionType == "Overflyttet" & 
      .data$Type == "innen_24t_type" ~ "Overflyttet", 
    
    .data$admissionType == "Direkte" & 
      .data$Type == "innen_24t_samlet" ~ "Samlet", 
    
    .data$admissionType == "Overflyttet" & 
      .data$Type == "innen_24t_samlet" ~ "Samlet"    
  ), 
  
  # antall forløp per type, brukes for å fjerne måneder med <5 forløp i figur
  antall_komplette = dplyr::case_when(
    .data$Type == "innen_24t_type" ~ n, 
    .data$Type == "innen_24t_samlet" ~ n_samlet
  )) %>% 
  dplyr::select(.data$maaned, 
                .data$name, 
                .data$value, 
                .data$antall_komplette) %>% 
  dplyr::group_by(.data$maaned, .data$name) %>% 
  dplyr::distinct()

# Dersom data ikke komplett, bytte ut verdiene med NA
prep_figVentetid24t_lokalt %<>% 
  dplyr::left_join(., 
                   nstemi_komplette %>%
                     select(.data$maaned, .data$komplette_andel), 
                   by = "maaned") %>% 
  dplyr::mutate(
    value = ifelse(.data$komplette_andel < 0.5 | .data$antall_komplette < 5, 
                   yes = NA_real_, 
                   no = .data$value),
    Sykehus = params$hospitalName) %>% 
  dplyr::select(.data$maaned, .data$name, .data$value, .data$Sykehus)


```

```{r hittilIAar_24T_nasj, results='asis', warning=FALSE}
# NASJONALT
prep_figVentetid24t_nasjonalt <- aP_nasjonalt %>% 
  dplyr::filter(.data$indik_nstemi_angio_innen24t_data == "ja", 
                .data$indik_nstemi_angio_innen24t %in% c("ja", "nei"))  %>% 
  dplyr::filter(.data$ProsedyreDato >= forsteDagFigur_ventetid,
                .data$ProsedyreDato < sisteDagFigur_ventetid) %>% 
  
  #Samlet (Direkte og overflyttet)
  dplyr::group_by(.data$maaned) %>% 
  dplyr::mutate(
    innen_24t_samlet = sum(.data$indik_nstemi_angio_innen24t == "ja", 
                           na.rm = TRUE)/n()) %>% 
  dplyr::ungroup() %>% 
  
  # per admission type (Direkte / OVerflyttet)
  dplyr::group_by(.data$maaned, .data$admissionType) %>% 
  dplyr::mutate(
    innen_24t_type = sum(.data$indik_nstemi_angio_innen24t == "ja",
                         na.rm = TRUE)/n()) %>% 
  dplyr::ungroup() %>% 
  
  # Beholde en rad per Samlet, Direkte, OVerflyttet : 
  dplyr::count(.data$maaned, 
               .data$admissionType, 
               .data$innen_24t_type,
               .data$innen_24t_samlet) %>% 
  tidyr::pivot_longer(cols = starts_with("innen_24t_"), names_to = "Type") %>% 
  dplyr::mutate(name = dplyr::case_when(
    
    .data$admissionType == "Direkte" & 
      .data$Type == "innen_24t_type" ~ "Direkte", 
    
    .data$admissionType == "Overflyttet" & 
      .data$Type == "innen_24t_type" ~ "Overflyttet", 
    
    .data$admissionType == "Direkte" & 
      .data$Type == "innen_24t_samlet" ~ "Samlet", 
    
    .data$admissionType == "Overflyttet" & 
      .data$Type == "innen_24t_samlet" ~ "Samlet"  )) %>% 
  dplyr::select(.data$maaned, .data$name, .data$value) %>% 
  dplyr::group_by(.data$maaned, .data$name) %>% 
  dplyr::distinct() %>% 
  dplyr::mutate(Sykehus = "Nasjonalt")




prep_fig_ventetid24t <- rbind(prep_figVentetid24t_nasjonalt,
                              prep_figVentetid24t_lokalt) %>% 
  dplyr::select(.data$Sykehus, 
                .data$maaned, 
                .data$name, 
                .data$value) %>% 
  dplyr::mutate(Sykehus = factor(.data$Sykehus,
                                 levels = c(params$hospitalName,
                                            "Nasjonalt")))

```


```{r fig_ventetid24T_iAar_samlet, warning=FALSE, fig.width = 8, fig.height = 4, fig.pos = "H", fig.align = "center", out.width = "\\textwidth", fig.cap="Andel forløp per måned med maks 24 timer ventetid fra hele siste året til og med siste hele måned. Analysene inkluderer både pasienter innlagt direkte på PCI-sykehus og pasienter overflyttet fra annet sykehus. Vannrett rød stiplet linje markerer forventet måloppnåelse. Måneder der sykehuset har færre enn 50\\% komplette data eller færre enn 5 forløp vises ikke i diagrammet."}

cap <- paste0("Andel forløp per måned med maks 24 timer ventetid fra hele siste året til og med siste hele måned. Analysene inkluderer både pasienter innlagt direkte på PCI-sykehus og pasienter overflyttet fra annet sykehus. Vannrett rød stiplet linje markerer forventet måloppnåelse. Måneder der sykehuset har færre enn 50\\% komplette data eller færre enn 5 forløp vises ikke i diagrammet.")

fig1 <- prep_fig_ventetid24t %>%
  dplyr::filter(name == "Samlet") 

fig1 %>%
  ggplot2::ggplot(aes(x = .data$maaned,
                      y = .data$value,
                      group = .data$Sykehus)) +
  ggplot2::ggtitle("Direkte og overflyttet") +
  ggplot2::geom_line(aes(colour = .data$Sykehus)) +
  ggplot2::geom_point(aes(colour = .data$Sykehus))  +
  ggplot2::theme(axis.title = ggplot2::element_blank(),
                 legend.title = ggplot2::element_blank()) +
  ggplot2::scale_color_manual(values=c(colPrimary[5], colPrimary[2])) +
  ggplot2::scale_y_continuous(labels = scales::percent_format(accuracy = 1),
                              limits = c(0, 1)) +
  ggplot2::geom_hline(yintercept = 0.5, colour = "red", linetype = "dashed") +
  ggplot2::scale_x_discrete(guide = guide_axis(angle = 45))

```



```{r fig_ventetid24T_iAar_direkte, warning=FALSE, fig.width = 8, fig.height = 4, fig.pos = "H", fig.align = "center", out.width = "\\textwidth", fig.cap="Andel forløp per måned med maks 24 timer ventetid fra hele siste året til og med siste hele måned. Analysene inkluderer pasienter innlagt direkte på PCI-sykehus. Vannrett rød stiplet linje markerer forventet måloppnåelse. Måneder der sykehuset har færre enn 50\\% komplette data eller færre enn 5 forløp vises ikke i diagrammet."}


prep_fig_ventetid24t %>%
  dplyr::filter(name == "Direkte") %>%
  ggplot2::ggplot(aes(x = .data$maaned,
                      y = .data$value,
                      group = .data$Sykehus)) +
  ggplot2::ggtitle("Direkte") +
  ggplot2::geom_line(aes(colour = .data$Sykehus)) +
  ggplot2::geom_point(aes(colour = .data$Sykehus))  +
  ggplot2::theme(axis.title = ggplot2::element_blank(),
                 legend.title = ggplot2::element_blank()) +
  ggplot2::scale_color_manual(values=c(colPrimary[5], colPrimary[2])) +
  ggplot2::scale_y_continuous(labels = scales::percent_format(accuracy = 1),
                              limits = c(0, 1)) +
  ggplot2::geom_hline(yintercept = 0.5, colour = "red", linetype = "dashed") +
  ggplot2::scale_x_discrete(guide = guide_axis(angle = 45))

```

```{r fig_ventetid24T_iAar_overflyttet, warning=FALSE, fig.width = 8, fig.height = 4, fig.pos = "H", fig.align = "center", out.width = "\\textwidth", fig.cap="Andel forløp per måned med maks 24 timer ventetid fra hele siste året til og med siste hele måned. Analysene inkluderer pasienter overflyttet fra annet sykehus. Vannrett rød stiplet linje markerer forventet måloppnåelse. Måneder der sykehuset har færre enn 50\\% komplette data eller færre enn 5 forløp vises ikke i diagrammet."}


prep_fig_ventetid24t %>%
  dplyr::filter(name == "Overflyttet") %>%
  ggplot2::ggplot(aes(x = .data$maaned,
                      y = .data$value,
                      group = .data$Sykehus)) +
  ggplot2::ggtitle("Overflyttet") +
  ggplot2::geom_line(aes(colour = .data$Sykehus)) +
  ggplot2::geom_point(aes(colour =.data$ Sykehus))  +
  ggplot2::theme(axis.title = ggplot2::element_blank(),
                 legend.title = ggplot2::element_blank()) +
  ggplot2::scale_color_manual(values=c(colPrimary[5], colPrimary[2])) +
  ggplot2::scale_y_continuous(labels = scales::percent_format(accuracy = 1),
                              limits = c(0, 1)) +
  ggplot2::geom_hline(yintercept = 0.5, colour = "red", linetype = "dashed") +
  ggplot2::scale_x_discrete(guide = guide_axis(angle = 45))

```


```{r pagebreakVentetidNSTEMIfigSoyle, results = "asis", eval = (params$tableFormat == "latex")}
cat("\n\n\\pagebreak\n")
```

```{r komplettYear_24timerNSTEMI, results='asis', warning=FALSE}


# Per ÅR: Blant alle NSTEMI, antall komplette forløp (med gyldig tid)
nstemi_komplett_year_lokalt <- aP_nasjonalt %>%
  dplyr::filter(.data$AvdRESH == params$reshID) %>%
  dplyr::filter(.data$indik_nstemi_angio_innen24t_data == "ja") %>%
  janitor::tabyl(.data$aar,
                 .data$indik_nstemi_angio_innen24t,
                 show_missing_levels = TRUE) %>%
  janitor::adorn_totals("col", name = "Totalt") %>%
  dplyr::transmute(
    aar = as.numeric(.data$aar),
    komplette_antall =  .data$ja + .data$nei,
    komplette_andel = .data$komplette_antall / .data$Totalt)

```

```{r prep_nstemi_year_lokalt, results='asis', warning=FALSE}

nstemiAP_fra2018_lokalt <- aP_nasjonalt %>%
  dplyr::filter(.data$AvdRESH == params$reshID) %>%
  dplyr::filter(.data$indik_nstemi_angio_innen24t_data == "ja",
                .data$indik_nstemi_angio_innen24t %in% c("ja", "nei")) %>%
  dplyr::filter(.data$aar %in% 2018:periode_data$sisteHeleYear) %>%
  
  
  #Samlet *(Direkte og overflyttet)
  dplyr::group_by(.data$aar) %>%
  dplyr::mutate(
    innen_24t_samlet = sum(.data$indik_nstemi_angio_innen24t == "ja",
                           na.rm = TRUE)/n()) %>%
  dplyr::ungroup() %>%
  
  # per admission type (Direkte / OVerflyttet)
  dplyr::group_by(.data$aar, .data$admissionType) %>%
  dplyr::mutate(
    innen_24t_type = sum(.data$indik_nstemi_angio_innen24t == "ja",
                         na.rm = TRUE)/n()) %>%
  dplyr::ungroup() %>%
  
  # Beholde en rad per Samlet, Direkte, OVerflyttet :
  dplyr::count(.data$aar,
               .data$admissionType,
               .data$innen_24t_type,
               .data$innen_24t_samlet) %>%
  tidyr::pivot_longer(cols = starts_with("innen_24t_"), names_to = "Type") %>%
  dplyr::mutate(name = dplyr::case_when(
    
    .data$admissionType == "Direkte" &
      .data$Type == "innen_24t_type" ~ "Direkte",
    
    .data$admissionType == "Overflyttet" &
      .data$Type == "innen_24t_type" ~ "Overflyttet",
    
    .data$admissionType == "Direkte" &
      .data$Type == "innen_24t_samlet" ~ "Samlet",
    
    .data$admissionType == "Overflyttet" &
      .data$Type == "innen_24t_samlet" ~ "Samlet"  )) %>%
  
  
  dplyr::select(.data$aar, .data$name, .data$value) %>%
  dplyr::group_by(.data$aar, .data$name) %>%
  dplyr::distinct()

# Dersom data ikke komplett, bytte ut verdiene med NA
nstemiAP_fra2018_lokalt %<>%
  mutate(aar = as.numeric(.data$aar)) %>%
  dplyr::left_join(.,
                   nstemi_komplett_year_lokalt %>%
                     dplyr::select(.data$aar,
                                   .data$komplette_andel),
                   by = "aar") %>%
  dplyr::transmute(
    aar = as.numeric(.data$aar),
    name = .data$name,
    value = ifelse(.data$komplette_andel < 0.5,
                   yes = NA_real_,
                   no = .data$value),
    Sykehus = params$hospitalName)
```



```{r prep_nstemi_year_nasjonalt, results='asis', warning=FALSE}

# #Nasjonalt
nstemiAP_fra2018_nasjonalt <- aP_nasjonalt %>%
  dplyr::filter(.data$indik_nstemi_angio_innen24t_data == "ja",
                .data$indik_nstemi_angio_innen24t %in% c("ja", "nei")) %>%
  dplyr::filter(.data$aar %in% 2018:periode_data$sisteHeleYear) %>%
  
  
  #Samlet *(Direkte og overflyttet)
  dplyr::group_by(.data$aar) %>%
  dplyr::mutate(
    innen_24t_samlet = sum(.data$indik_nstemi_angio_innen24t == "ja",
                           na.rm = TRUE)/n()) %>%
  dplyr::ungroup() %>%
  
  # per admission type (Direkte / OVerflyttet)
  dplyr::group_by(.data$aar, .data$admissionType) %>%
  dplyr::mutate(
    innen_24t_type = sum(.data$indik_nstemi_angio_innen24t == "ja",
                         na.rm = TRUE)/n()) %>%
  dplyr::ungroup() %>%
  
  # Beholde en rad per Samlet, Direkte, OVerflyttet :
  dplyr::count(.data$aar,
               .data$admissionType,
               .data$innen_24t_type,
               .data$innen_24t_samlet) %>%
  tidyr::pivot_longer(cols = starts_with("innen_24t_"), names_to = "Type") %>%
  dplyr::mutate(name = dplyr::case_when(
    
    .data$admissionType == "Direkte" &
      .data$Type == "innen_24t_type" ~ "Direkte",
    
    .data$admissionType == "Overflyttet" &
      .data$Type == "innen_24t_type" ~ "Overflyttet",
    
    .data$admissionType == "Direkte" &
      .data$Type == "innen_24t_samlet" ~ "Samlet",
    
    .data$admissionType == "Overflyttet" &
      .data$Type == "innen_24t_samlet" ~ "Samlet"  )) %>%
  
  dplyr::select(.data$aar, .data$name, .data$value) %>%
  dplyr::group_by(.data$aar, .data$name) %>%
  dplyr::distinct() %>%
  dplyr::transmute(
    aar = as.numeric(.data$aar),
    name = .data$name,
    value = .data$value,
    Sykehus = "Nasjonalt")

```


```{r prep_nstemi_year_nasjonalt_lokalt, results='asis', warning=FALSE}
timeTableYear_Samlet <- cbind(timeTableYear, name = "Samlet")
timeTableYear_Direkte <- cbind(timeTableYear, name = "Direkte")
timeTableYear_Overflyttet <- cbind(timeTableYear, name = "Overflyttet")

timeTableYear_SDO <- rbind(timeTableYear_Samlet,
                           timeTableYear_Direkte,
                           timeTableYear_Overflyttet)
nstemiAP_fra2018_lokalt %<>%
  dplyr::left_join(timeTableYear_SDO,
                   .,
                   by = c("aar", "name")) %>%
  dplyr::select(.data$aar, .data$name, .data$value, .data$Sykehus)


prep_figVentetid24t_year <-
  rbind(as.data.frame(nstemiAP_fra2018_nasjonalt),
        nstemiAP_fra2018_lokalt) %>%
  dplyr::mutate(Sykehus = factor(.data$Sykehus,
                                 levels = c(params$hospitalName,
                                            "Nasjonalt")),
                value_tekst = ifelse(
                  !is.na(.data$value),
                  yes = paste0(sprintf("%.1f", .data$value*100 ), "%"),
                  no = NA_character_))
```



```{r fig_ventetid24T_samlet, warning=FALSE, fig.width = 8, fig.height = 4, fig.pos = "H", fig.align = "center", out.width = "\\textwidth", fig.cap="Andel forløp med maks 24 timer ventetid fra 2018 til siste hele år. Analysene inkluderer både pasienter innlagt direkte på PCI-sykehus og pasienter overflyttet fra annet sykehus. Vannrett rød stiplet linje markerer forventet måloppnåelse. Søylen vises ikke for sykehuset for år med færre enn 50\\% komplette data eller færre enn 5 forløp."}


fig_samlet <- prep_figVentetid24t_year %>%
  dplyr::filter(.data$name == "Samlet")

fig_samlet  %>% ggplot2::ggplot(
  ggplot2::aes(x = .data$aar,
               y = .data$value,
               fill = .data$Sykehus)) +
  
  ggplot2::ggtitle("Direkte og overflyttet") +
  ggplot2::geom_bar(stat = "identity", position = "dodge") +
  ggplot2::theme(axis.title = ggplot2::element_blank(),
                 legend.title = ggplot2::element_blank()) +
  ggplot2::scale_fill_manual(values = c(colPrimary[5], colPrimary[2])) +
  ggplot2::scale_y_continuous(labels = scales::percent_format(accuracy = 1),
                              limits = c(0, 1)) +
  ggplot2::geom_text(
    ggplot2::aes(label = .data$value_tekst),
    position = position_dodge(width = 1),
    vjust = 1.2,
    size = 3,
    colour =  ifelse(fig_samlet$Sykehus == "Nasjonalt",
                     "white", "black")) +
  ggplot2::geom_hline(yintercept = 0.5, colour = "red", linetype = "dashed")

```

```{r fig_ventetid24T_direkte, warning=FALSE, fig.width = 8, fig.height = 4, fig.pos = "H", fig.align = "center", out.width = "\\textwidth", fig.cap=paste0("Andel forløp med maks 24 timer ventetid fra 2018 til siste hele år. Analysene inkluderer pasienter innlagt direkte på PCI-sykehus. Vannrett rød stiplet linje markerer forventet måloppnåelse. Søylen vises ikke for sykehuset for år med færre enn 50\\% komplette data eller færre enn 5 direkte forløp.")}

fig_direkte <- prep_figVentetid24t_year %>%
  dplyr::filter(.data$name == "Direkte")

fig_direkte %>% ggplot2::ggplot(
  ggplot2::aes(x = .data$aar,
               y = .data$value,
               fill = .data$Sykehus)) +
  ggplot2::ggtitle("Direkte") +
  ggplot2::geom_bar(stat = "identity", position = "dodge") +
  ggplot2::theme(axis.title = ggplot2::element_blank(),
                 legend.title = ggplot2::element_blank()) +
  ggplot2::scale_fill_manual(values = c(colPrimary[5], colPrimary[2])) +
  ggplot2::scale_y_continuous(labels = scales::percent_format(accuracy = 1),
                              limits = c(0, 1)) +
  ggplot2::geom_text(
    ggplot2::aes(label = .data$value_tekst),
    position = position_dodge(width = 1),
    vjust = 1.2,
    size = 3,
    colour =  ifelse(fig_samlet$Sykehus == "Nasjonalt",
                     "white", "black")) +
  ggplot2::geom_hline(yintercept = 0.5, colour = "red", linetype = "dashed")


```


```{r fig_ventetid24T_overflyttet, warning=FALSE, fig.width = 8, fig.height = 4, fig.pos = "H", fig.align = "center", out.width = "\\textwidth", fig.cap=paste0("Andel forløp med maks 24 timer ventetid fra 2018 til siste hele år. Analysene inkluderer pasienter overflyttet fra annet sykehus. Vannrett rød stiplet linje markerer forventet måloppnåelse. Søylen vises ikke for sykehuset for år med færre enn 50\\% komplette data eller færre enn 5 overflyttede forløp.")}

fig_overflyttet <- prep_figVentetid24t_year %>%
  dplyr::filter(.data$name == "Overflyttet")

fig_overflyttet %>% ggplot2::ggplot(
  ggplot2::aes(x = .data$aar,
               y = .data$value,
               fill = .data$Sykehus)) +
  ggplot2::ggtitle("Overflyttet") +
  ggplot2::geom_bar(stat = "identity", position = "dodge") +
  ggplot2::theme(axis.title = ggplot2::element_blank(),
                 legend.title = ggplot2::element_blank()) +
  ggplot2::scale_fill_manual(values = c(colPrimary[5], colPrimary[2])) +
  ggplot2::scale_y_continuous(labels = scales::percent_format(accuracy = 1),
                              limits = c(0, 1)) +
  ggplot2::geom_text(
    ggplot2::aes(label = .data$value_tekst),
    position = position_dodge(width = 1),
    vjust = 1.2,
    size = 3,
    colour =  ifelse(fig_samlet$Sykehus == "Nasjonalt",
                     "white", "black")) +
  ggplot2::geom_hline(yintercept = 0.5, colour = "red", linetype = "dashed")

```



### Invasiv utredning ved NSTEMI innen 72 timer

```{r ventetid72t_NSTEMI, results='asis', warning=FALSE}
cap <- "Antall og andel pasienter med indikasjon NSTEMI som innen 72 timer etter innleggelse i sykehus har blitt utredet med invasiv koronar angiografi. Tabellen inkluderer både pasienter innlagt direkte på PCI-sykehus og pasienter overflyttet fra annet sykehus. Pasienter overflyttet fra annen avdeling på samme sykehus er ekskludert.
Komplett data ved direkte innleggelse er der både tid for ankomst PCI-sykehus og tid for arteriepunksjon er registrert. For forløp der pasienten har blitt overført fra et annet sykehus, er komplett data der både tid for innleggelse i henvisende sykehus og tid for arteriepunksjon er registrert. Måneder med mindre enn 50\\% komplett data eller færre enn 5 forløp blir markert med stjerne og prosent forløp med ventetid under 72 timer regnes ikke ut for disse. (Målnivå: 80 \\%)"


nstemi_72t_lokalt <- aP_nasjonalt %>% 
  dplyr::filter(.data$AvdRESH == params$reshID) %>% 
  dplyr::filter(.data$indik_nstemi_angio_innen72t_data == "ja") %>% 
  janitor::tabyl(.data$maaned, 
                 .data$indik_nstemi_angio_innen72t,
                 show_missing_levels = TRUE ) %>% 
  janitor::adorn_totals("col", name = "Total") %>% 
  dplyr::mutate(
    # Komplette er alle som er ja/nei, men ikkje ugyldig/manglende
    komplette_antall = .data$ja + .data$nei, 
    komplette_prosent =  .data$komplette_antall / .data$Total, 
    komplette_tekst = dplyr::if_else(
      .data$komplette_prosent < 0.50 | .data$komplette_antall < 5,
      true = paste0(.data$komplette_antall, " av ", .data$Total, "*"),
      false = paste0(.data$komplette_antall, " av ", .data$Total), 
      missing = NA_character_), 
    
    # Blandt komplette: Antall NTSTEMI innen 72 t , 
    nstemi_72t_tekst = dplyr::if_else(
      .data$komplette_prosent < 0.50 | .data$komplette_antall < 5,
      true = paste0(.data$ja, " av ", .data$komplette_antall, " (-%)"), 
      false = paste0(.data$ja, " av ", .data$komplette_antall, " (",
                     round(100 * .data$ja / .data$komplette_antall, 1), "%)"), 
      missing = NA_character_)) %>% 
  dplyr::select(.data$maaned, 
                .data$komplette_tekst, 
                .data$nstemi_72t_tekst)


nstemi_72t_nasjonalt <- aP_nasjonalt %>% 
  dplyr::filter(.data$indik_nstemi_angio_innen72t_data == "ja", 
                .data$indik_nstemi_angio_innen72t %in% c("ja", "nei")) %>% 
  janitor::tabyl(.data$maaned, 
                 .data$indik_nstemi_angio_innen72t,
                 show_missing_levels = TRUE) %>% 
  dplyr::mutate(
    # Komplette er alle som er ja/nei, men ikkje ugyldig/manglende
    komplette_antall = .data$ja + .data$nei, 
    
    # Blandt komplette: Antall NTSTEMI innen 72 t , 
    Nasjonalt = paste0(.data$ja, " av ", .data$komplette_antall, " (",
                       round(100 * .data$ja / .data$komplette_antall, 1), 
                       "%)")) %>% 
  dplyr::select(.data$maaned, 
                .data$Nasjonalt)


# Forberede tabell, bruke kompletthet og ventetid
tabVentetid72t <- timeTableMonth %>% 
  dplyr::left_join(., nstemi_72t_lokalt, by = c("maaned")) %>% 
  dplyr::left_join(., nstemi_72t_nasjonalt, by = c("maaned")) %>% 
  dplyr::rename(
    "Måned" = .data$maaned,
    "Antall komplette data av totale antall data" = .data$komplette_tekst,
    "Antall NSTEMI innen 72t av komplett data" = .data$nstemi_72t_tekst) %>%
  replace(is.na(.), "-")




noric::mst(tab = tabVentetid72t, 
           type = params$tableFormat, 
           cap = cap,
           digs = c(0, 0, 0, 1, 1), 
           align = rep("c", 5), 
           label = "tabVentetid72t")
```

```{r pagebreakVentetidNSTEMI72, results = "asis", eval = (params$tableFormat == "latex")}
cat("\n\n\\pagebreak\n")
```


## Trykkmåling ved innsnevringer i kransårene

Bruk av trykkmålinger (FFR, iFR, IMR, Pd, Pa og Pd/Pa) i kransårer med 
innsnevringer har vist seg 
å gi nyttig informasjon for å bedømme om en innsnevring er av betydning eller 
ikke og hvorvidt det bør utføres utblokking av åren eller ei. Europeiske 
retningslinjer har en sterk anbefaling om bruk av nevnte metoder. Indikatoren 
viser antall og andel prosedyrer der det har blitt utført trykkmåling ved 
kransårerøntgen hos pasienter med stabil angina pectoris.  (Mål $\geq$ 30 %)


```{r TabNtrykkmaaling, results='asis', warning=FALSE}

cap <- paste0(
  "Antall og andel prosedyrer der det ved indikasjon stabil ", 
  "koronarsykdom har blitt utført trykkmåling i form av enten", 
  "fractional flow reserve (FFR), ", 
  "instantaneous wave-free ratio (iFR), ", 
  "index of microvascular resistance (IMR), ",
  "resting distal coronary pressure to aortic pressure ratio (Pd/Pa), ", 
  "coronary artery aortic pressure (Pa-hyperemi) eller ",
  "coronary artery distal pressure (Pd-hyperemi). ", 
  "Måneder med mindre enn 5 observasjoner er markert med N.")


#Lokal
nTrykkmaalingAP <- aP_nasjonalt %>% 
  dplyr::filter(.data$AvdRESH == params$reshID) %>% 
  dplyr::filter(.data$indik_trykkmaaling_data == "ja") %>% 
  dplyr::select(.data$maaned,
                .data$indik_trykkmaaling) %>%
  janitor::tabyl(.data$maaned, 
                 .data$indik_trykkmaaling,
                 show_missing_levels = TRUE) %>% 
  janitor::adorn_totals("col", name = "Totalt") %>% 
  dplyr::mutate(
    
    Prosent = paste0(round(.data$ja / .data$Totalt * 100, 1)," %"),
    
    Totalt = ifelse(.data$Totalt < 5,
                    yes = "N",
                    no = .data$Totalt),
    
    utfortTrykkmaaling = ifelse(.data$Totalt == "N",
                                yes = NA,
                                no = .data$ja),
    
    Prosent = ifelse(.data$Totalt == "N",
                     yes = NA,
                     no = .data$Prosent)) %>% 
  
  dplyr::select(.data$maaned, 
                .data$Totalt, 
                .data$utfortTrykkmaaling, 
                .data$Prosent)

#Nasjonal
nTrykkmaalingAP_nasj <- aP_nasjonalt %>% 
  dplyr::filter(.data$indik_trykkmaaling_data == "ja") %>% 
  dplyr::select(.data$maaned,
                .data$indik_trykkmaaling) %>%
  janitor::tabyl(.data$maaned, 
                 .data$indik_trykkmaaling, 
                 show_missing_levels = TRUE) %>% 
  janitor::adorn_totals("col", name = "Totalt") %>% 
  dplyr::transmute(
    maaned = .data$maaned,
    Nasjonalt = paste0(round(.data$ja / .data$Totalt * 100, 1)," %")) 

#Tabell
tabTrykkmaalingAP <- timeTableMonth %>% 
  dplyr::left_join(., nTrykkmaalingAP, by = c("maaned")) %>% 
  dplyr::left_join(., nTrykkmaalingAP_nasj, by = c("maaned")) %>% 
  dplyr::rename("Måned" = .data$maaned,
                "Utført trykkmåling" = .data$utfortTrykkmaaling) %>% 
  replace(is.na(.), "-")

noric::mst(tab = tabTrykkmaalingAP, 
           type = params$tableFormat, 
           cap = cap,
           digs = c(0,0,1,1), 
           align = rep("c", 4), 
           label = "tabTrykkmaalingAP")
```


```{r pagebreakTrykkmaaling, results = "asis", eval = (params$tableFormat == "latex")}
cat("\n\n\\pagebreak\n")
```

## Billeddiagnostikk ved stenting av venstre hovedstamme

Europeiske retningslinjer anbefaler bruk av tilleggsundersøkelser for å gi
supplerende bildeframstilling i tilknytning til PCI av venstre hovedstamme.
Intrakoronar ultralyd (IVUS) og optical coherence tomography (OCT) er metoder 
som brukes til dette formål. Metodebruken gir viktig informasjon om grad av
innsnevring og vurdering av resultat etter PCI. Indikatoren angir andel 
pasienter der det er utført supplerende billeddiagnostikk under prosedyren. 
Pasienter som tidligere har fått utført ACB-operasjon og pasienter som blir 
behandlet for akutt hjerteinfarkt av typen STEMI er ikke medregnet i analysene.
(Mål $\geq$ 60 %)

```{r TabNstentingVH, results='asis', warning=FALSE}
cap <- paste0("Antall og andel prosedyrer der det er brukt supplerende ", 
              "billeddiagnostike metoder (IVUS og/eller OCT). ", 
              "Kvartaler med mindre enn 5 observasjoner er markert med N.")



#Lokalt
nStentVH <- aP_nasjonalt %>% 
  dplyr::filter(.data$AvdRESH == params$reshID) %>% 
  dplyr::filter(.data$indik_ivus_oct_v_stent_lms_data == "ja") %>% 
  dplyr::select(.data$kvartal,
                .data$indik_ivus_oct_v_stent_lms) %>% 
  janitor::tabyl(.data$kvartal,
                 .data$indik_ivus_oct_v_stent_lms,
                 show_missing_levels = TRUE) %>%
  janitor::adorn_totals("col", name = "Totalt") %>%
  dplyr::mutate(
    
    Prosent = paste0(round(.data$ja / .data$Totalt * 100, 1), " %"),
    Totalt = ifelse(.data$Totalt < 5,
                    yes = "N",
                    no = .data$Totalt),
    
    utfortIvusOct = ifelse(.data$Totalt == "N",
                           yes = NA,
                           no = .data$ja),
    
    Prosent = ifelse(Totalt == "N",
                     yes = NA,
                     no = .data$Prosent)) %>%
  dplyr::select(.data$kvartal, 
                .data$Totalt, 
                .data$utfortIvusOct, 
                .data$Prosent) 

#Nasjonalt
nStentVH_nasjonalt <- aP_nasjonalt %>% 
  dplyr::filter(.data$indik_ivus_oct_v_stent_lms_data == "ja") %>% 
  dplyr::select(.data$kvartal,
                .data$indik_ivus_oct_v_stent_lms) %>% 
  janitor::tabyl(.data$kvartal,
                 .data$indik_ivus_oct_v_stent_lms,
                 show_missing_levels = TRUE) %>%
  janitor::adorn_totals("col", name = "Totalt") %>%
  dplyr::transmute(
    kvartal = .data$kvartal,
    Nasjonalt = paste0(round(.data$ja / .data$Totalt * 100, 1), " %"))

#Tabell
tabStentVH <- timeTableQuarter %>%
  dplyr::left_join(., nStentVH, by = c("kvartal")) %>%
  dplyr::left_join(., nStentVH_nasjonalt, by = c("kvartal")) %>% 
  dplyr::rename("Utført IVUS/OCT" = .data$utfortIvusOct) %>% 
  replace(is.na(.), "-")


noric::mst(tab = tabStentVH, 
           type = params$tableFormat,
           cap = cap,
           digs = c(0,0,1,1), 
           align = rep("c", 4), 
           label = "tabStentVH")
```

```{r pagebreakStentingVH, results = "asis", eval = (params$tableFormat == "latex")}
cat("\n\n\\pagebreak\n")
```

## Foreskriving av medisiner

Ufullstendige utskrivelsesskjema og pasienter utskrevet som død er ekskludert
fra datagrunnlaget.

```{r foreskrivingAvMedisiner, include=FALSE, eval=TRUE}

#Nasjonalt

medisinerSO_nasjonalt <- sO_nasjonalt %>% 
  dplyr::filter(.data$Skjemanavn == "Utskrivelse") %>% 
  dplyr::select(.data$Sykehusnavn, 
                .data$ForlopsID, 
                .data$SkjemaStatus,
                .data$AvdRESH)


medisinerSS_nasjonalt <- sS_nasjonalt %>%
  dplyr::select(.data$Sykehusnavn, 
                .data$ForlopsID, 
                .data$StentType,
                .data$AvdRESH) %>% 
  dplyr::group_by(.data$AvdRESH, .data$ForlopsID) %>%
  dplyr::mutate(antStent = sum(!is.na(.data$StentType), na.rm = TRUE)) %>% 
  dplyr::ungroup() %>% 
  dplyr::select(.data$Sykehusnavn, 
                .data$ForlopsID, 
                .data$antStent,
                .data$AvdRESH) %>% 
  dplyr::distinct()

medisinerAP_nasjonalt <- aP_nasjonalt %>% 
  dplyr::select(.data$Sykehusnavn,
                .data$ForlopsID,
                .data$primFID, 
                .data$regType,
                .data$Month,
                .data$UtskrevetDod, 
                .data$flereBlodFMed, 
                .data$ForskrStatiner,
                .data$AvdRESH) %>% 
  dplyr::left_join(., 
                   medisinerSO_nasjonalt, 
                   by = c("AvdRESH","ForlopsID")
  ) %>% 
  dplyr::left_join(.,
                   medisinerSS_nasjonalt, 
                   by = c("AvdRESH","ForlopsID")
  ) %>% 
  dplyr::group_by(.data$AvdRESH, .data$primFID) %>% 
  dplyr::mutate(antStentUnderOpphold = sum(.data$antStent > 0, 
                                           na.rm = TRUE)) %>% 
  dplyr::ungroup() %>% 
  dplyr::filter(.data$regType == "primaer",
                .data$SkjemaStatus == 1,
                .data$antStentUnderOpphold >= 1,
                .data$UtskrevetDod %in% "Nei")

#Lokalt
medisinerAP <- medisinerAP_nasjonalt %>% 
  dplyr::filter(.data$AvdRESH == params$reshID)

```


### Foreskriving av blodfortynnende medisiner

Blodfortynnende medisiner er viktig for å hindre blodproppdannelse etter 
innsetting av stent. Europeiske retningslinjer anbefaler samtidig bruk av to 
blodplatehemmere som hovedregel hos pasienter som har fått satt inn stenter. 
I visse tilfeller kan en av disse erstattes av andre blodfortynnende 
medikamenter. Indikatoren viser andel av pasienter som har dokumentert 
foreskrivning av anbefalte blodfortynnende medikamenter etter utblokking av 
hjertets kransårer med innsetting av stent. (Mål $\geq$ 95 %)

```{r TabNblodfortynnendeMedisiner, results='asis', warning=FALSE}

#Lokalt
nBlodfMedAP <- medisinerAP %>% 
  dplyr::count(.data$Month, .data$flereBlodFMed) %>% 
  tidyr::pivot_wider(names_from = .data$flereBlodFMed, 
                     values_from = .data$n, 
                     values_fill = list(n = 0)) %>%
  janitor::adorn_totals("col", name = "Totalt") %>% 
  dplyr::mutate(prosentJa = paste0(round(.data$`Ja`/.data$Totalt*100, 1), " %"),
                Totalt = ifelse(.data$Totalt < 5,
                                yes = "N",
                                no = .data$Totalt),
                JaBlodFMed = ifelse(.data$Totalt == "N",
                                    yes = NA,
                                    no = .data$`Ja`),
                prosentJa = ifelse(.data$Totalt == "N",
                                   yes = NA,
                                   no = .data$prosentJa)) %>% 
  dplyr::select(.data$Month, 
                .data$Totalt, 
                .data$JaBlodFMed, 
                .data$prosentJa) %>% 
  dplyr::rename("Blodfortynnende" = .data$JaBlodFMed,
                "Prosent" = .data$prosentJa)


#Nasjonalt
nBlodfMedAP_nasj <- medisinerAP_nasjonalt %>% 
  dplyr::count(.data$Month, .data$flereBlodFMed) %>% 
  tidyr::pivot_wider(names_from = .data$flereBlodFMed, 
                     values_from = .data$n, 
                     values_fill = list(n = 0)) %>%
  janitor::adorn_totals("col", name = "Totalt") %>% 
  dplyr::mutate(prosentJa = paste0(round(.data$`Ja`/.data$Totalt*100, 1), 
                                   " %")) %>% 
  dplyr::select(.data$Month, .data$prosentJa) %>% 
  dplyr::rename("Nasjonalt" = .data$prosentJa)


#Tabell
tabBlodfMedAP <- timeTableMonth %>% 
  dplyr::left_join(., nBlodfMedAP, by = c("Month")) %>% 
  dplyr::left_join(., nBlodfMedAP_nasj, by = c("Month")) %>% 
  dplyr::rename("Måned" = .data$Month) %>% 
  replace(is.na(.), "-")

cap <- "Antall og andel pasienter per opphold der det er dokumentert i journalen foreskrivning av blodfortynnende medisiner som omfatter enten dobbel blodplatehemmer, eller en blodplatehemmer i kombinasjon med Marevan eller NOAC. Måneder med mindre enn 5 ferdigstilte observasjoner er markert med N."

noric::mst(tab = tabBlodfMedAP, 
           type = params$tableFormat, 
           cap = cap,
           digs = c(0, 0, 1, 1), 
           align = rep("c", 4), 
           label = "tabBlodfMedAP")
```


```{r pagebreaKolesterolsenkendeMedisiner, results = "asis", eval = (params$tableFormat == "latex")}
cat("\n\n\\pagebreak\n")
```

### Foreskriving av kolesterolsenkende medisiner

Kolesterolsenkende behandling er viktig for å hindre progresjon av koronarsykdom
hos pasienter som har fått påvist dette. Europeiske retningslinjer har en sterk
anbefaling om kolesterolsenkende behandling, siden dette har vist seg å 
forhindre hjerteinfarkt og behov for ny PCI. Indikatoren viser andel pasienter 
som har fått foreskrevet anbefalt kolesterolsenkende behandling med statiner
etter utblokking av hjertets kransårer med innsetting av stent. Noen pasienter 
kan ikke bruke statiner på grunn av bivirkninger. (Mål $\geq$ 90 %)

```{r TabNkolesterolsenkendeMedisiner, results='asis', warning=FALSE}

#Lokalt
nKolestSenkMedAP <- medisinerAP %>% 
  dplyr::count(.data$Month, .data$ForskrStatiner) %>% 
  tidyr::pivot_wider(names_from = .data$ForskrStatiner, 
                     values_from = .data$n, 
                     values_fill = list(n = 0)) %>%
  janitor::adorn_totals("col", name = "Totalt") %>% 
  dplyr::mutate(
    prosentForskrSt = paste0(
      round(.data$`Forskrevet statiner`/.data$Totalt*100, 1), " %"),
    Totalt = ifelse(.data$Totalt < 5,
                    yes = "N",
                    no = .data$Totalt),
    forskrevetStatiner = ifelse(.data$Totalt == "N",
                                yes = NA,
                                no = .data$`Forskrevet statiner`),
    prosentForskrSt = ifelse(`Totalt` == "N",
                             yes = NA,
                             no = .data$prosentForskrSt)) %>% 
  dplyr::select(.data$Month, 
                .data$Totalt, 
                .data$forskrevetStatiner, 
                .data$prosentForskrSt) %>% 
  dplyr::rename("Kolesterolsenkende" = .data$forskrevetStatiner,
                "Prosent" = .data$prosentForskrSt)


#Nasjonalt
nKolestSenkMedAP_nasj <- medisinerAP_nasjonalt %>% 
  dplyr::count(.data$Month, .data$ForskrStatiner) %>% 
  tidyr::pivot_wider(names_from = .data$ForskrStatiner, 
                     values_from = .data$n, 
                     values_fill = list(n = 0)) %>%
  janitor::adorn_totals("col", name = "Totalt") %>% 
  dplyr::mutate(
    prosentForskrSt = paste0(
      round(.data$`Forskrevet statiner`/.data$Totalt*100, 1), " %")) %>% 
  dplyr::select(.data$Month, .data$prosentForskrSt) %>% 
  dplyr::rename("Nasjonalt" = .data$prosentForskrSt)


#Tabell
tabKolestSenkMedAP <- timeTableMonth %>% 
  dplyr::left_join(., nKolestSenkMedAP, by = c("Month")) %>% 
  dplyr::left_join(., nKolestSenkMedAP_nasj, by = c("Month")) %>% 
  dplyr::rename("Måned" = .data$Month) %>% 
  replace(is.na(.), "-")

cap <- "Antall og andel pasienter per opphold som har fått foreskrevet kolesterolsenkende medikamenter i form av statiner ved utskrivelse etter PCI med innsetting av stent. Måneder med mindre enn 5 ferdigstilte observasjoner er markert med N."

noric::mst(tab = tabKolestSenkMedAP, 
           type = params$tableFormat, 
           cap = cap,
           digs = c(0, 0, 1, 1), 
           align = rep("c", 4), 
           label = "tabKolestSenkMedAP")
```

```{r pagebreakForeskrivingAvMedisiner, results = "asis", eval = (params$tableFormat == "latex")}
cat("\n\n\\pagebreak\n")
```

`r if (dim_ak_lokalt[1] <= 10 | length(aK_nasjonalt$Pacemakerbehov) == 0) {"<!--"}`
## Pacemakerbehov etter kateterbasert innsetting av aortaklaff

Denne indikatoren 
viser andel pasienter som har fått implantert permanent pacemaker under 
sykehusoppholdet etter kateterbasert innsetting av aortaklaff. Ved noen sykehus 
blir pasientene raskt overflyttet til annet sykehus etter TAVI. Dersom behovet 
for pacemaker melder seg etter overflytting til annet sykehus, vil dette ikke
komme fram i datagrunnlaget til registeret og resultatene må tolkes med 
forsiktighet. Pasienter som allerede har implantert permanent pacemaker før 
prosedyre er ekskludert. Lav andel pacemakerbehov er ønskelig.
`r if (dim_ak_lokalt[1] <= 10 | length(aK_nasjonalt$Pacemakerbehov) == 0) {"-->"}`

```{r pacemakerbehovAK, include=FALSE, eval=TRUE}

if (dim_ak_lokalt[1] > 10 & length(aK_nasjonalt$Pacemakerbehov) > 0) {
  
  #Nasjonalt
  pacemakerbehovAK_nasjonalt <- aK_nasjonalt %>% 
    dplyr::filter(
      !.data$LabKompDod %in% "Ja" &
        !is.na(.data$TypeKlaffeprotese) &
        !.data$Pacemaker %in% "Ja" &
        (is.na(.data$ScreeningBeslutning) |
           .data$ScreeningBeslutning != "BAV")) %>% 
    dplyr::select(.data$Sykehusnavn, 
                  .data$ForlopsID, 
                  .data$Kvartal, 
                  .data$Pacemakerbehov, 
                  .data$AvdRESH)
  
  
  pacemakerbehovSO_nasjonalt <- sO_nasjonalt %>% 
    dplyr::filter(.data$SkjemaStatus == 1 &
                    .data$Skjemanavn == "Aorta") %>% 
    dplyr::select(.data$AvdRESH, 
                  .data$ForlopsID,
                  .data$SkjemaStatus)
  
  pacemakerbehovAK_ferdigstilt_nasj <- pacemakerbehovAK_nasjonalt %>% 
    dplyr::left_join(., 
                     pacemakerbehovSO_nasjonalt, 
                     by = c("AvdRESH", "ForlopsID")) %>% 
    dplyr::filter(.data$SkjemaStatus == 1)
  
  
  #Lokalt
  pacemakerbehovAK <- pacemakerbehovAK_nasjonalt %>% 
    dplyr::filter(.data$AvdRESH == params$reshID)
  
  pacemakerbehovAK_ferdigstilt <- pacemakerbehovAK_ferdigstilt_nasj %>% 
    dplyr::filter(.data$AvdRESH == params$reshID)
  
  #Sjekker andel ferdigstilte skjemaer
  sjekkTot <- pacemakerbehovAK %>% 
    dplyr::count(.data$Kvartal) %>% 
    dplyr::rename(AntallTot = .data$n)
  
  sjekkFerdigstilt <- pacemakerbehovAK_ferdigstilt %>% 
    dplyr::count(.data$Kvartal) %>% 
    dplyr::rename(AntallFerdig = .data$n)
  
  sjekkAndelFerdigstilt <- sjekkTot %>% 
    dplyr::left_join(., sjekkFerdigstilt, by = "Kvartal") %>% 
    dplyr::mutate(
      Andel = round(.data$AntallFerdig/.data$AntallTot, 3),
      antFerdigProsSkjema = paste0(.data$AntallFerdig,
                                   " av ", 
                                   .data$AntallTot, 
                                   " (", .data$Andel*100,
                                   " %)")) %>% 
    dplyr::select(.data$Kvartal, 
                  .data$Andel, 
                  .data$antFerdigProsSkjema)
  
}

```

```{r TabNPacemakerbehovAK, results='asis', warning=FALSE, eval=TRUE}

if (dim_ak_lokalt[1] > 10 &  length(aK_nasjonalt$Pacemakerbehov) > 0) {
  
  #Lokalt
  nPacemakerbehovAK <- pacemakerbehovAK_ferdigstilt %>% 
    dplyr::count(.data$Kvartal, .data$Pacemakerbehov) %>% 
    tidyr::pivot_wider(names_from = .data$Pacemakerbehov, 
                       values_from = .data$n, 
                       values_fill = list(n = 0)) %>%
    janitor::adorn_totals("col", name = "Totalt") %>% 
    dplyr::mutate(
      prosentImpPace = paste0(
        round(.data$`Implantert perm. pacemaker`/.data$Totalt*100, 1), 
        " %")) %>% 
    dplyr::select(.data$Kvartal, 
                  .data$Totalt, 
                  .data$`Implantert perm. pacemaker`,
                  .data$prosentImpPace) %>% 
    dplyr::rename(Prosent = .data$prosentImpPace)
  
  
  #Nasjonalt
  nPacemakerbehovAK_nasj <- pacemakerbehovAK_ferdigstilt_nasj %>% 
    dplyr::count(.data$Kvartal, .data$Pacemakerbehov) %>% 
    tidyr::pivot_wider(names_from = .data$Pacemakerbehov, 
                       values_from = .data$n, 
                       values_fill = list(n = 0)) %>%
    janitor::adorn_totals("col", name = "Totalt") %>% 
    dplyr::mutate(
      prosentImpPace = paste0(
        round(.data$`Implantert perm. pacemaker`/.data$Totalt*100, 1), 
        " %")) %>% 
    dplyr::select(.data$Kvartal, .data$prosentImpPace) %>% 
    dplyr::rename(Nasjonalt = .data$prosentImpPace)
  
  
  #Tabell
  tabPacemakerbehovAK_ferdigstilt <- timeTableQuarterAK %>% 
    dplyr::left_join(., sjekkAndelFerdigstilt, by = "Kvartal") %>% 
    dplyr::left_join(., nPacemakerbehovAK, by = "Kvartal") %>% 
    dplyr::left_join(., nPacemakerbehovAK_nasj, by = "Kvartal") %>% 
    dplyr::mutate(
      implPermPace = paste0(
        .data$`Implantert perm. pacemaker`, 
        " av ", 
        .data$Totalt),
      Prosent = ifelse(.data$Andel < 0.5,
                       yes = NA,
                       no = .data$Prosent)) %>% 
    dplyr::select(.data$Kvartal,
                  .data$antFerdigProsSkjema,
                  .data$implPermPace,
                  .data$Prosent,
                  .data$Nasjonalt)  %>% 
    dplyr::rename(
      "Antall/andel ferdigstilte prosedyreskjemaer" = .data$antFerdigProsSkjema,
      "Antall implanterte perm. pacemaker" = .data$implPermPace) %>% 
    replace(is.na(.), "-")
  
  cap <- "Antall og andel pasienter som har fått implantert permanent pacemaker under sykehusoppholdet etter kateterbasert innsetting av aortaklaff. Kun observasjoner der prosedyreskjemaet er ferdigstilt er tatt med. Hvis andel ferdigstilte prosedyreskjemaer er mindre enn 50\\%, vises ikke prosenten for andel implanterte permanente pacemaker."
  
  noric::mst(tab = tabPacemakerbehovAK_ferdigstilt, 
             type = params$tableFormat, cap = cap,
             digs = c(0, 0, 1, 1), 
             align = rep("c", 4), 
             label = "tabPacemakerbehovAK")
}
```




