---
date: '`r format(Sys.time(), "%d %B, %Y")`'
always_allow_html: yes
params:
  title: "Emty tite"
  author: "Anon author"
  hospitalName: "Ukjent sykehus"
  tableFormat: "html"
header-includes:
  - \usepackage[english, norsk]{babel}
  - \usepackage{booktabs}
  - \usepackage{rotating}
title: "`r paste('Norsk register for invasiv kardiologi (NORIC)', 'Månedsrapport Angio/PCI', params$hospitalName)`"
author: "`r params$author`"
---

```{r knitrOptions, include=FALSE}
library(magrittr)
library(knitr)
library(kableExtra)

# make sure to use a temporary directory AND absolute paths, e.g. that figs
# can be found also when deployed at a server. See below link for explanation
# https://rgriff23.github.io/2017/04/25/how-to-knit-for-mysite.html
# Also make sure we use tempdir() as working directory so we do not clutter
# the package of the hosting shiny app
#workDir <- tempdir()
#knitr::opts_knit$set(base.dir=workDir, base.url=file.path(paste0(tempdir(), "/")), root.dir = workDir)

# Handle both html and latex (pdf) output. Actually to avoid setting 'format'
# for each kable call
# inspired by https://stackoverflow.com/questions/46080853/why-does-rendering-a-pdf-from-rmarkdown-require-closing-rstudio-between-renders
options(knitr.table.format = params$tableFormat)

knitr::opts_chunk$set(warnings=FALSE,echo=FALSE)
options(stringsAsFactors=FALSE)

``` 


```{r SKDEcol, include=FALSE}

colPrimary <- c("#000059", "#084594", "#2171b5", "#4292c6", "#6baed6", "#c6dbef")
colNeutral <- c("#4D4D4D", "#737373", "#A6A6A6", "#DADADA")
colKontrast <- "#FF7260"

``` 


```{r GetData, include=FALSE, cache=TRUE}

baseName <- "noricStaging"

reshID <- rapbase::getShinyUserReshId(session, testCase = TRUE)

registryName <- if (exists( "reshID" )) {
                    noric::NORICmakeRegistryName(
                               baseName = baseName ,
                               reshID = reshID
                           )
                } else {
                    "rapbase"
                }

dbType <- "mysql"
SOQuery <- "SELECT * FROM SkjemaOversikt"
APQuery <- "SELECT * FROM AngioPCIVar"
AnPQuery <- "SELECT * FROM AndreProsedyrerVar"

SO <- rapbase::LoadRegData(registryName, SOQuery, dbType)
AP <- rapbase::LoadRegData(registryName, APQuery, dbType)
AnP <- rapbase::LoadRegData(registryName, AnPQuery, dbType)

showN <- 12 # how many months are displayed
```


```{r AnPPrepare,include=FALSE, eval=TRUE}

AnP$ProsedyreDato <- as.Date( AnP$ProsedyreDato)

AnP$Year <- as.numeric(
    format(
        x = AnP $ ProsedyreDato ,
        format = "%Y"))

AnP$nMonth <- as.numeric(
    as.factor(
        format(
            AnP$ProsedyreDato ,
            format = "%y-%m")))

AnP $ Day <- as.numeric(
    AnP $ ProsedyreDato - min( AnP $ ProsedyreDato , na.rm = TRUE ) )

AnP <- subset(
    x = AnP ,
    subset = nMonth >= max( nMonth , na.rm = TRUE ) - showN )

AnP $ Month <- as.factor(
    format(
        x = AnP $ ProsedyreDato ,
        format = "%y-%m"))

AnP$AnnenProsType <- factor(
    x = AnP$AnnenProsType ,
    levels = c(
        "Høyre hjertekateterisering" ,
        "Temporær pacemaker" ,
        "Perikardiocentese" ,
        "Ventilfilming" ,
        "Lukking av ASD/PFO" ,
        "Lukking av venstre aurikkel" ,
        "Impella") ,
    labels = c(
        "Høyre kat." ,
        "Temp. pm" ,
        "Perikardiocentese" ,
        "Ventilfilming" ,
        "Lukking ASD/PFO" ,
        "Lukking v. aurikkel" ,
        "Impella")
    )

```



```{r SOPrepare,include=FALSE, eval=TRUE}

SO$RegDate <- as.Date(
    SO$HovedDato)

SO$Year <- as.numeric(
    format(
        x = SO$RegDate ,
        format = "%Y"))

SO$nMonth <- as.numeric(
    as.factor(
        format(
            x = SO$RegDate ,
            format = "%y-%m")))

SO <- subset(
    x = SO ,
    subset =
        (nMonth > max( nMonth , na.rm = TRUE ) - showN) &
        (RegDate < Sys.Date()))


  # crude fix for Feiring and Rikshospitalet which have meaningless test data before 2015
if ( SO$Sykehusnavn[1] %in% c("Feiring","Rikshospitalet")) SO <- SO [ which( SO$Year >= 2015 ) , ]

SO$Month <- as.factor(
    format(
        SO$RegDate ,
        format = "%y-%m"))

```




```{r APprepare,include=FALSE, eval=TRUE}

AP$FodselsDato <- as.Date( AP$FodselsDato)

AP$InnleggelseHenvisendeSykehusDato <- as.Date( AP$InnleggelseHenvisendeSykehusDato)

AP$AnkomstPCIDato <- as.Date( AP$AnkomstPCIDato)

AP$ProsedyreDato <- as.Date( AP$ProsedyreDato)

AP$Sykehusnavn <- factor( AP$Sykehusnavn )

AP $ AdmissionType <- car::recode(
    var = AP $ OverflyttetFra ,
    recodes = "
        'Annet sykehus'='Referred';
        '' = NA;
        'Annen  avdeling på sykehuset' = NA;
        'Nei, direkte inn til dette sykehus' = 'Directly admitted';
        'Omdirigert ambulanse' = 'Directly admitted';
        ")

AP $ Indikasjon2 <- factor(
    car::recode(
        var = AP $ Indikasjon ,
        recodes = "
            'Stabil koronarsykdom'='SAP';
            'UAP'='UAP';
            'NSTEMI'='NSTEMI';
            'STEMI'='STEMI';
            'Hjertestans ved STEMI'='STEMI';
            'STEMI > 24h'='STEMI';
            'STEMI/Rescue PCI'='STEMI';
            'Uklare brystsmerter'='Uklare brystsmerter';
            else='Annet';
            ") ,
    levels = c("Uklare brystsmerter","SAP","UAP","NSTEMI","STEMI","Annet") )


AP$Funn[which(AP$Funn %in% c("","Ikke konklusiv undersøkelse"))] <- NA
AP$NormaleKar <- as.numeric(AP$Funn == "Normalt /Ateromatos")

```



```{r Daterecodes,include=FALSE, eval=TRUE}

AP$Year <- as.numeric(
    format(
        x = AP $ ProsedyreDato ,
        format = "%Y"))

AP$Week <- as.numeric(
    format(
        x = AP $ ProsedyreDato ,
        format = "%W"))


AP$nMonth <- as.numeric(
    as.factor(
        format(
            AP$ProsedyreDato ,
            format = "%y-%m")))

AP $ Day <- as.numeric(
    AP $ ProsedyreDato - min( AP $ ProsedyreDato , na.rm = TRUE ) )

```

```{r subsetting,include=FALSE, eval=TRUE}

NSTEMI <- subset(
    x = AP ,
    subset = (Indikasjon == "NSTEMI"))

NSTEMI $ Month <- as.factor(
    format(
        x = NSTEMI $ ProsedyreDato ,
        format = "%y-%m"))


AP <- subset(
    x = AP ,
    subset = nMonth >= max( nMonth , na.rm = TRUE ) - showN )

 # crude fix for Feiring and Rikshospitalet which have meaningless test data before 2015
if (AP$Sykehusnavn[1] %in% c("Feiring","Rikshospitalet")) AP <- AP [ which( AP$Year >= 2015 ) , ]

AP $ Month <- as.factor(
    format(
        x = AP $ ProsedyreDato ,
        format = "%y-%m"))

```

```{r makeStandardTableFunction, eval=TRUE}
mst <- function(tab, type, cap, digs, align = NULL, fs = 8) {
  if (type == "latex") {
    k <- kable(tab, caption = cap, digits = digs, align = align,
               booktabs = TRUE) %>% 
      kable_styling(latex_options = c("hold_position", "scale_down"),
                    font_size = fs)
  }
  
  if (type == "html") {
    k <- kable(tab, caption = cap, digits = digs, align = align) %>% 
      kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                    full_width = F)
  }
  print(k)
}
```

# Hastegrad

## Hastegrad

```{r FigNHastegrad,fig.cap="Antall prosedyrer etter hastegrad og måned",fig.width=10,fig.height=5,fig.pos='!h',out.width="\\textwidth"}
pal <- colPrimary[c(1,3,5)]

op <- par(
    mfcol = c (1,1) ,
    xpd = NA ,
    mar = c(5.1,4.1,4.1,13.1) ,
    bg = "#EEEEEE")

barplot(
    xtabs(
        formula = ~ Hastegrad + Month ,
        data = AP) ,
    las = 1 ,
    xlab = "Måned" ,
    ylab = "Antall" ,
    col = pal ,
    space = 0.2 ,
    border = FALSE)

legend(
    "right" ,
    inset = -.28 ,
    bty = "n" ,
    horiz = FALSE ,
    fill = pal[3:1],
    legend = sort(
        unique(AP$Hastegrad) ,
        decreasing = T) ,
    cex = 1)

```


## Hastegrad


```{r TabNHastegrad, results='asis', eval=TRUE}
cap <- "Antall registrerte prosedyrer etter hastegrad og måned"
tab <- xtabs(formula = ~ Month + Hastegrad, data = AP) %>% 
  addmargins()
if (params$tableFormat == "latex") {
  kable(tab, caption = cap, digits = 0, booktabs = TRUE) %>% 
  kable_styling(latex_options = c("hold_position"))
}

if (params$tableFormat == "html") {
  kable(tab, caption = cap, digits = 0) %>% 
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                  full_width = F)
}
```


## Hastegrad


```{r TabRHastegrad,  results = 'asis'}
cap <- "Prosentandel prosedyrer etter hastegrad og måned"
tab <- xtabs(formula = ~ Month + Hastegrad, data = AP) %>% 
  prop.table(., margin = 1) * 100
if (params$tableFormat == "latex") {
  kable(tab, caption = cap, digits = 1, booktabs = TRUE) %>% 
    kable_styling(latex_options = c("hold_position"))
}

if (params$tableFormat == "html") {
kable(tab, caption = cap, digits = 1) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F)
}
```




# Prosedyre type

## Prosedyre type

```{r FigNProsedyreType,fig.cap="Antall prosedyrer etter type og måned",fig.width=8,fig.height=4,out.width="\\textwidth"}
pal <- colPrimary[c(1,3,5)]

op <- par(
    mfcol = c (1,1) ,
    xpd = NA ,
    mar = c(5.1,4.1,4.1,13.1) ,
    bg = "#EEEEEE")

barplot(
    xtabs(
        formula = ~ ProsedyreType + Month ,
        data = AP) ,
    las = 1 ,
    xlab = "Måned" ,
    ylab = "Antall" ,
    col = pal ,
    space = 0.2 ,
    border = FALSE)

legend(
    "right" ,
    inset = -.28 ,
    bty = "n" ,
    horiz = FALSE ,
    fill = pal[3:1],
    legend = sort(
        unique(AP$ProsedyreType) ,
        decreasing = TRUE ),
    cex = 1)

```


## Prosedyre type


```{r TabNProsedyreType,  results = 'asis'}
cap <- "Antall prosedyrer etter prosedyretype og måned"
tab <- xtabs(formula = ~ Month + ProsedyreType, data = AP) %>% 
  addmargins()
mst(tab, params$tableFormat, cap, 0)
```


## Prosedyre type


```{r TabRProsedyreType,  results = 'asis'}
cap = "Prosentandel prosedyrer etter prosedyretype og måned"
tab <- xtabs(formula = ~ Month + ProsedyreType, data = AP) %>% 
  prop.table(., margin = 1) * 100

mst(tab, params$tableFormat, cap, 1)
```





# Indikasjon

## Indikasjon

```{r FigNIndikasjon,fig.cap="Antall prosedyrer etter indikasjon og måned",fig.width=12,fig.height=6,out.width="\\textwidth"}

op <- par(
    mfcol = c (1,1) ,
    xpd = NA ,
    mar = c(5.1,4.1,4.1,13.1) ,
    bg = "#EEEEEE")

barplot(
    xtabs(
        formula = ~ Indikasjon2 + Month ,
        data = AP) ,
    las = 1 ,
    xlab = "Måned" ,
    ylab = "Antall" ,
    col = colPrimary[6:1] ,
    space = 0.2 ,
    border = FALSE)

legend(
    "right" ,
    inset = -.28 ,
    bty = "n" ,
    horiz = FALSE ,
    fill = colPrimary ,
    legend = levels(AP$Indikasjon2)[6:1] ,
    cex = 1)

```


## Indikasjon


```{r TabNIndikasjon,  results = 'asis'}
cap = "Antall prosedyrer etter indikasjon og måned"
xtabs(formula = ~ Month + Indikasjon2, data = AP) %>% 
  addmargins() %>%
  mst(., params$tableFormat, cap, 0)
```


## Indikasjon


```{r TabRIndikasjon,  results = 'asis'}
cap = "Prosentandel prosedyrer etter indikasjon og måned"
tab <- xtabs(formula = ~ Month + Indikasjon2, data = AP) %>% 
  prop.table(., margin = 1) * 100
mst(tab, params$tableFormat, cap, 1)
```



# Annen diagnostikk


```{r TabTillegg,include=FALSE}

PrintTabTilleggCol <- function(VAR){

    nVAR <- addmargins(
        table(
            AP$Month ,
            addNA(
                factor(
                    AP[,VAR] ,
                    levels = c("Ja","Nei","")))) ,
        margin = 1 )

    nVARja <- sprintf(
        "%3.0f" ,
        nVAR[ ,
             which(colnames(nVAR)=="Ja")
             ] )

    rVAR <- round(
        100 * prop.table(
                  nVAR ,
                  margin = 1 ) ,
        digits = 1 )

    rVARja <- sprintf(
        "%4.1f" ,
        rVAR[ ,
             which(colnames(rVAR)=="Ja")
             ] )

    return(
        paste(
            nVARja ,
            " (",
            rVARja ,
            ")" ,
            sep = ""))

}

#  Rotablator,trombeaspirasjon, IABP ,

TilleggVars <- c(
    "FFR",
    "Doppler",
    "IVUS",
    "OCT",
    "IFR",
    "NIRS",
    "HoyreHjerteKat",
    "Perikardiocentese",
    "Pacemaker",
    "Aortaballongpumpe",
    "Impella",
    "Trombectomy",
    "ECMO",
    "AnnenDiag")

IndexMinEnTillegg <- unique(
    unlist(
        lapply(
            X = TilleggVars ,
            FUN = function(X) which( AP[,X] == "Ja" )
        )
    )
)

AP$IngenTillegg <- "Ja"
AP$IngenTillegg[IndexMinEnTillegg] <- "Nei"

TabTillegg <- cbind(
    PrintTabTilleggCol("FFR") ,
    PrintTabTilleggCol("Doppler" ) ,
    PrintTabTilleggCol("IVUS") ,
    PrintTabTilleggCol("OCT") ,
    PrintTabTilleggCol("IFR") ,
    PrintTabTilleggCol("NIRS") ,
    PrintTabTilleggCol("HoyreHjerteKat") ,
    PrintTabTilleggCol("Perikardiocentese") ,
    PrintTabTilleggCol("Pacemaker") ,
    PrintTabTilleggCol("Aortaballongpumpe") ,
    PrintTabTilleggCol("Impella") ,
    PrintTabTilleggCol("Trombectomy") ,
    PrintTabTilleggCol("ECMO") ,
    PrintTabTilleggCol("AnnenDiag") ,
    PrintTabTilleggCol("IngenTillegg")
    )

TilleggLabels <- c(
    "FFR",
    "Doppler" ,
    "IVUS",
    "OCT",
    "IFR",
    "NIRS",
    "Høyre kat.",
    "Perikardiocentese",
    "PM",
    "IABP",
    "Impella",
    "Trombectomy",
    "ECMO",
    "Annen",
    "Ingen")

# AdjuvantTerapi

rownames( TabTillegg ) <- c( levels( AP $ Month ) , "Totalt" )
colnames( TabTillegg ) <- c( TilleggLabels )

```



## Annen diagnostikk ved angiografi


```{r TabTilleggsProsedyre1,  results = 'asis'}
kable(TabTillegg[,1:6],
      caption = "Totalt antall (prosent) tilleggsprosedyrer etter måned",
      align = rep("r", 7)) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F)

# can the above be reproduced?
# xtable::print.xtable(
#     x = xtable::xtable(
#           TabTillegg[,1:6],
#         caption = "Totalt antall (prosent) tilleggsprosedyrer etter måned",
#         align = rep("r", 7)
#         ),
#     booktabs = TRUE,
#     type = 'html',
    # html.table.attributes = 'border=0')
```


## Tilleggsprosedyrer


```{r TabTilleggsProsedyre2,  results = 'asis'}
kable(TabTillegg[,7:8],
      caption = "Totalt antall (prosent) tilleggsprosedyrer etter måned",
      align = rep("r", 3)) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F)
```



## Adjuvant terapi


```{r TabTilleggsProsedyre3,  results = 'asis'}
kable(TabTillegg[,9:15],
      caption = "Totalt antall (prosent) tilleggsprosedyrer etter måned",
      align = rep("r", 8)) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F)
```


# Andre prosedyrer


## Andre prosedyrer


```{r TabNAndreProsedyrer,  results = 'asis', eval=TRUE}

TabNAndreProsedyrer <- addmargins(
  xtabs(formula = ~ Month + AnnenProsType, data = AnP)
)

if (params$tableFormat == 'html') {
kable(TabNAndreProsedyrer) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F) %>% 
  row_spec(row = 0, font_size = 8, angle = -90, align = "l") %>% 
  column_spec(column = 1:(dim(TabNAndreProsedyrer)[2]+1), width = "3em")
}

if (params$tableFormat == 'latex'){
  xtable::print.xtable(
    x = xtable::xtable(
      x = TabNAndreProsedyrer ,
      caption = "Antall andre prosedyrer (uten angio/PCI  etter prosedyretype og måned" ,
      digits = 0) ,
    rotate.colnames = TRUE ,
    #scalebox = 0.8 ,
    booktabs = TRUE
    )
}
```


# Komplikasjon

## Komplikasjon

### på lab `r paste0( range( AP$ProsedyreDato ) , collapse = ' -- ' )`

```{r TabLabKompl,results='asis'}

LabKomplikasjoner <- data.frame(
    VarName = c(
        "LabKomplikasjon" ,
        "LabKompAllergiskLettModerat" ,
        "LabKompAllergiskAlvorlig" ,
        "LabKompBehkrevendeArytmi" ,
        "LabKompHemodynamisk" ,
        "LabKompNeurologisk" ,
        "LabKompVaskulaerIkkeKoronar" ,
        "LabKompMistetStent" ,
        "LabKompVedvarSidegrensokkl" ,
        "LabKompPerforasjon" ,
        "LabKompTamponade" ,
        "LabKompAkuttACBOperasjon" ,
        "LabKompAnnenAlv" ,
        "LabKompDod"
    ) ,
    Komplikasjon = c(
        "Alle komplikasjoner" ,
        "Allergisk reaksjon lett/moderat" ,
        "Allergisk reaksjon alvorlig" ,
        "Behandlingskrevende arytmi" ,
        "Hemodynamisk" ,
        "Neurologisk" ,
        "Vaskulaer (men ikke koronar)" ,
        "Mistet stent" ,
        "Vedvarende sidegrensokklusjon" ,
        "Perforasjon" ,
        "Tamponade" ,
        "Akutt ACB-operasjon fra lab" ,
        "Annen alvorlig" ,
        "Død"
    )
)

LabKomplikasjoner$Antall <- unlist(
    lapply(
        X = LabKomplikasjoner$VarName ,
        FUN = function(X) try(
                              sum( AP[,X] == "Ja" , na.rm = TRUE )
                              )
        )
    )

LabKomplikasjoner$Prosent <- round(
    100 * LabKomplikasjoner$Antall / dim(AP)[1] ,
    digits = 1 )

i.labkomp <- order(LabKomplikasjoner$Prosent)

LabKomplikasjoner <- LabKomplikasjoner[i.labkomp,]

df <- LabKomplikasjoner[,-1]
kable(df, align = c("l","r","r", "r"), row.names = F) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F)
```



## Komplikasjon

### på lab `r paste0( range( AP$ProsedyreDato ) , collapse = ' -- ' )`


```{r FigLabKompl,fig.cap="Prosentandel komplikasjoner på laboratoriet",echo=FALSE,fig.pos='!h',fig.width=10,fig.height=5,out.width="\\textwidth"}

par(
    mar = c(4,15,2,2) ,
    xpd = NA ,
    las = 1)

lk <- LabKomplikasjoner[,4]; names(lk) <- LabKomplikasjoner[,2]

xBarplot <- barplot(
    lk ,
    xlab = "Andel (%)" ,
    horiz = TRUE ,
    border = FALSE )

text(
    x = LabKomplikasjoner[,4] ,
    y = xBarplot ,
    pos = 4 ,
    col = "#000000AA" ,
    labels = LabKomplikasjoner[,3])

```




## Komplikasjon

### på avdelingen `r paste0( range( AP$ProsedyreDato ) , collapse = ' -- ' )`

```{r TabAvdKompl,results='asis'}

AvdKomplikasjoner <- data.frame(
    VarName = c(
        "AvdKomp" ,
        "AvdKompAllergisk" ,
        "AvdKompBlodning" ,
        "AvdKompVaskulaer" ,
        "AvdKompNeurologiskKomp" ,
        "AvdKompNyNyreinsuffisiens" ,
        "AvdKompTamponade" ,
        "AvdKompPCI" ,
        "AvdKompACB" ,
        "AvdKompHjerteinfarkt" ,
        "AvdKompAnnenAlvorlig" ,
        "AvdKompDod"
    ) ,
    Komplikasjon = c(
        "Alle komplikasjoner" ,
        "Allergisk senkomplikasjon" ,
        "Noen form for blodning" ,
        "Vaskulaer (men ikke koronare kar)" ,
        "Neurologisk" ,
        "Nytilkommet nyreinsuffisiens" ,
        "Tamponade" ,
        "Re-PCI (behandlet segment)" ,
        "ACB-operasjon (ikke fra lab)" ,
        "Hjerteinfarkt" ,
        "Annen alvorlig" ,
        "Død"
    )
)

AvdKomplikasjoner$Antall <- unlist(
    lapply(
        X = AvdKomplikasjoner$VarName ,
        FUN = function(X) try(
                              sum( AP[,X] == "Ja" , na.rm = TRUE )
                              )
        )
    )

AvdKomplikasjoner$Prosent <- round(
    100 * AvdKomplikasjoner$Antall / dim(AP)[1] ,
    digits = 1 )

i.labkomp <- order(AvdKomplikasjoner$Prosent)

AvdKomplikasjoner <- AvdKomplikasjoner[i.labkomp,]

kable(AvdKomplikasjoner[,-1], row.names = F, align = c("l","r","r")) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F)
```




## Komplikasjon

### på avdelingen `r paste0( range( AP$ProsedyreDato ) , collapse = ' -- ' )`

```{r FigAvdKompl,fig.cap="Prosentandel komplikasjoner på avdelingen",echo=FALSE,fig.pos='!h',fig.width=10,fig.height=5,out.width="\\textwidth"}

par(
    mar = c(4,15,2,2) ,
    xpd = NA ,
    las = 1)

ak <- AvdKomplikasjoner[,4]; names(ak) <- AvdKomplikasjoner[,2]

xBarplot <- barplot(
    ak ,
    xlab = "Andel (%)" ,
    horiz = TRUE ,
    border = FALSE
    )

text(
    x = AvdKomplikasjoner[,4] ,
    y = xBarplot ,
    pos = 4 ,
    col = "#000000AA" ,
    labels = AvdKomplikasjoner[,3])

```




# Kompletthet


## Kompletthet angio/PCI skjemaer


```{r SOtab1,results='asis'}

nSOA <- with(
    SO[ which( SO$Skjemanavn == "AngioPCI" ) , ] ,
    table(
        Month ,
        factor(
            SkjemaStatus,
            levels=c(0,-1,1) ,
            labels = c("Tomt","Begynt","Ferdigstilt"))))

rSOA <- round(
    100 * prop.table(
              nSOA ,
              margin = 1 ) ,
    digits = 1 )

TABkompletthet <- cbind(
    rowSums(nSOA) ,
    nSOA[ , which( colnames(nSOA)=="Ferdigstilt" ) ] ,
    rSOA[ , which( colnames(rSOA)=="Ferdigstilt" ) ] )
colnames(TABkompletthet) <- c("Totalt","Ferdigstilt","Prosent")

kable(TABkompletthet,
      caption = "Antall hoved registreringsskjemaer etter måned",
      digits = c(0,0,0,1)) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F)
```



## Kompletthet utskrivelses skjemaer


```{r SOtab2,results='asis'}

nSOU <- with(
    SO[ which( SO$Skjemanavn == "Utskrivelse" ) , ] ,
    table(
        Month ,
        factor(
            SkjemaStatus,
            levels=c(0,-1,1) ,
            labels = c("Tomt","Begynt","Ferdigstilt"))))

rSOU <- round(
    100 * prop.table(
              nSOU ,
              margin = 1 ) ,
    digits = 1 )

TABkompletthet <- cbind(
    rowSums(nSOU) ,
    nSOU[ , which( colnames(nSOU)=="Ferdigstilt" ) ] ,
    rSOU[ , which( colnames(rSOU)=="Ferdigstilt" ) ] )
colnames(TABkompletthet) <- c("Totalt","Ferdigstilt","Prosent")

kable(TABkompletthet,
      caption = "Antall utskrivelsesskjemaer etter måned",
      digits = c(0,0,0,1)) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F)
```
