---
title: "`r paste('Norsk register for invasiv kardiologi (NORIC)', 'Månedsrapport: Prosedyrer og stentbruk for ', params$hospitalName) `"
author: ""
date: '`r format(Sys.time(), "%d. %B, %Y")`'
output: pdf_document
params:
  author: ukjent forfatter
  hospitalName: ukjent sykehus
  tableFormat: html
  reshID: 999999
  registryName: rapbase
  userFullName: Ukjent bruker
  userRole: ukjent rolle
  rendered_by_shiny: FALSE
header-includes:
- \usepackage[english, norsk]{babel}
- \usepackage{booktabs}
- \usepackage{rotating}
- \usepackage{float}
reglogo: '`r system.file("logoNORIC.png", package = "noric")`'
regtext: '`r readLines(system.file("registryShortDescription.txt", package = "noric"))`'
abstract: '`r paste0("Denne rapporten er generert ved hjelp av resultatløsningen _Rapporteket_ og er kun ment til internt bruk!", "\\newline ", "\\newline ", "Rapporten inneholder tabeller og figurer med resultater basert på forløp registrert ved ", params$hospitalName, ". Opptellinger og statistikker er gjort per forløp/prosedyre, og ikke per individ. Tabellene og figurene presenteres med data fra de siste 14 månedene." , "\\newline ", "\\newline ", "Eventuelle spørsmål knyttet til rapporten kan rettes til [noric@helse-bergen.no](mailto:noric@helse-bergen.no)") `'
---

```{r knitrOptions, include=FALSE}
library(magrittr)
library(knitr)
library(kableExtra)
library(dplyr)
library(janitor)

# make sure to use a temporary directory AND absolute paths, e.g. that figs
# can be found also when deployed at a server. See below link for explanation
# https://rgriff23.github.io/2017/04/25/how-to-knit-for-mysite.html
# Also make sure we use tempdir() as working directory so we do not clutter
# the package of the hosting shiny app
# workDir <- tempdir()
# knitr::opts_knit$set(base.dir = workDir,
#                      base.url = file.path(paste0(tempdir(), "/")),
#                      root.dir = workDir)

# Handle both html and latex (pdf) output. Actually to avoid setting 'format'
# for each kable call
# inspired by https://stackoverflow.com/questions/46080853/why-does-rendering-a-pdf-from-rmarkdown-require-closing-rstudio-between-renders
options(knitr.table.format = params$tableFormat)

knitr::opts_chunk$set(warnings = FALSE, echo = FALSE)
options(stringsAsFactors = FALSE)

# For some reason Shiny Server does not get the server locale settings right.
# To display dates correct, enforce locale here:
Sys.setlocale("LC_TIME", "nb_NO.UTF-8")
``` 


```{r SKDEcol, include=FALSE}

colPrimary <- c("#000059",
                "#084594",
                "#2171b5",
                "#4292c6",
                "#6baed6",
                "#c6dbef")
colNeutral <- c("#4D4D4D", "#737373", "#A6A6A6", "#DADADA")
colKontrast <- "#FF7260"

``` 

```{r parametre}
showN <- 14
```





```{r latest_entry, include=FALSE, eval=TRUE}
# DATAGRUNNLAG: PERIODE FOR SQL SPØRRING

# NYESTE DATO:
# Finne nyeste prosedyredato (=nyeste registrering). Vi ønsker ikke at
# forhåndsregisrerte planlagte forløp kommer med i rapporten. Derfor brukes
# gårsdagens dato som referanse, ingen forløp etter denne kommer med .
# Vi vil dermed også kunne se dersom ingen nye registreringer gjøres eller om
# overføringer har stoppet opp

# ELDSTE DATO:
# Januar fra i fjor (hele foregående år skal vise i rapporten)
nyeste_reg <- noric::getLatestEntry(registryName = params$registryName)

periode_data <- data.frame(
  siste_dato = min((as.Date(Sys.time()) - 1),
                   nyeste_reg))

periode_data %<>%
  dplyr::mutate(
    forste_dato  = lubridate::floor_date(.data$siste_dato,
                                         "month") - months(showN))
```




```{r GetData, include=FALSE, cache=FALSE}

SO <- noric::getPrepSoData(registryName = params$registryName,
                           fromDate  = periode_data$forste_dato,
                           toDate = periode_data$siste_dato,
                           singleRow = FALSE)


AP <- noric::getPrepApData(registryName = params$registryName,
                           fromDate  = periode_data$forste_dato,
                           toDate = periode_data$siste_dato,
                           singleRow = FALSE)

AnP <- noric::getPrepAnPData(registryName = params$registryName,
                             fromDate  = periode_data$forste_dato,
                             toDate = periode_data$siste_dato,
                             singleRow = FALSE)

evaluate_AnP <- nrow(AnP) > 0 # for conditional running of AnP-related chunks
# (TRUE when AnP contains data)


SS <- noric::getPrepSsData(registryName = params$registryName,
                           fromDate  = periode_data$forste_dato,
                           toDate = periode_data$siste_dato,
                           singleRow = FALSE)

```


```{r AnPPrepare,include=evaluate_AnP, eval=evaluate_AnP}

AnP$ProsedyreDato <- as.Date(AnP$ProsedyreDato)

AnP$Year <- as.numeric(
  format(
    x = AnP $ ProsedyreDato,
    format = "%Y"))

AnP$nMonth <- as.numeric(
  as.factor(
    format(
      AnP$ProsedyreDato,
      format = "%y-%m")))

AnP$Day <- as.numeric(
  AnP$ProsedyreDato - min(AnP$ProsedyreDato, na.rm = TRUE))

AnP <- subset(
  x = AnP,
  subset = nMonth >= max(nMonth, na.rm = TRUE) - showN)

AnP$Month <- as.factor(
  format(
    x = AnP$ProsedyreDato,
    format = "%y-%m"))

AnP$AnnenProsType <- factor(
  x = AnP$AnnenProsType,
  levels = c(
    "Høyre hjertekateterisering",
    "Temporær pacemaker",
    "Perikardiocentese",
    "Ventilfilming",
    "Lukking av ASD/PFO",
    "Lukking av venstre aurikkel",
    "Impella",
    "Plugging av PVL",
    "PTSMA",
    "Aortaballongpumpe",
    "ECMO"
    ),
  labels = c(
    "Høyre kat.",
    "Temp. pm",
    "Perikardiocentese",
    "Ventilfilming",
    "Lukking ASD/PFO",
    "Lukking v. aurikkel",
    "Impella",
    "Plugging av PVL",
    "PTSMA",
    "Aortaballongpumpe",
    "ECMO")
)
```


```{r SOPrepare,include=FALSE, eval=TRUE}

SO$RegDate <- as.Date(SO$HovedDato)

SO$Year <- as.numeric(
  format(
    x = SO$RegDate,
    format = "%Y"))

SO$nMonth <- as.numeric(
  as.factor(
    format(
      x = SO$RegDate,
      format = "%y-%m")))

SO <- subset(
  x = SO,
  subset =
    (nMonth >= max(nMonth, na.rm = TRUE) - showN) & (RegDate < Sys.Date())
)


SO$Month <- as.factor(
  format(
    SO$RegDate,
    format = "%y-%m"))

```


```{r SSprepare,include=FALSE, eval=TRUE}

SS %<>% dplyr::select(AvdRESH,
                      ForlopsID,
                      ProsedyreDato,
                      Indikasjon,
                      ProsedyreType,
                      Stentnavn,
                      StentType,
                      maaned)


SS %<>% dplyr::mutate(Indikasjon = factor(
  dplyr::case_when(Indikasjon == "Stabil koronarsykdom" ~ "SAP",
                   Indikasjon == "UAP" ~ "UAP",
                   Indikasjon == "NSTEMI" ~ "NSTEMI",
                   Indikasjon %in% c("STEMI",
                                     "STEMI > 24h",
                                     "STEMI/Rescue PCI")
                   ~ "STEMI",
                   is.na(Indikasjon) ~ NA_character_,
                   TRUE ~ "Annet"),
  levels = c("SAP", "UAP", "NSTEMI", "STEMI", "Annet", NA)))

SS %<>% dplyr::mutate(ProsedyreType2 = factor(
  dplyr::case_when(ProsedyreType %in%
                     c("Direktestent",
                       "Ballong + Stent",
                       "Medikamentell ballong + Stent") ~ "Stent",
                   ProsedyreType == "Ballongdilatasjon" ~ "POBA",
                   ProsedyreType == "Wireforsøk" ~ "Wireforsøk",
                   ProsedyreType == "Rotablator" ~ "Rotablator",
                   TRUE ~ "Annet"),
  levels = c("Stent", "POBA", "Wireforsøk", "Rotablator", "Annet")))

```



```{r APprepare, include=FALSE, eval=TRUE}

AP$FodselsDato <- as.Date(AP$FodselsDato)

AP$InnleggelseHenvisendeSykehusDato <- as.Date(
  AP$InnleggelseHenvisendeSykehusDato
  )

AP$AnkomstPCIDato <- as.Date(AP$AnkomstPCIDato)

AP$ProsedyreDato <- as.Date(AP$ProsedyreDato)

AP$Sykehusnavn <- factor(AP$Sykehusnavn)

AP %<>% dplyr::mutate(Indikasjon2 = factor(
  dplyr::case_when(Indikasjon == "Stabil koronarsykdom" ~ "SAP",
                   Indikasjon == "UAP" ~ "UAP",
                   Indikasjon %in% c("STEMI",
                                     "Hjertestans ved STEMI",
                                     "STEMI > 24h",
                                     "STEMI/Rescue PCI") ~ "STEMI",
                   Indikasjon == "Uklare brystsmerter" ~ "Uklare brystsmerter",
                   Indikasjon == "NSTEMI" ~ "NSTEMI",
                   TRUE ~ "Annet"),
  levels = c("Uklare brystsmerter", "SAP", "UAP", "NSTEMI", "STEMI", "Annet")
))

AP$Funn[which(AP$Funn %in% c("", "Ikke konklusiv undersøkelse"))] <- NA
AP$NormaleKar <- as.numeric(AP$Funn == "Normalt /Ateromatos")

AP %<>%
  dplyr::mutate(
    Hastegrad = factor(Hastegrad,
                       levels = c("Akutt",
                                  "Subakutt",
                                  "Planlagt",
                                  NA)))


AP %<>%
  noric::legg_til_antall_stent(df_ap =  ., df_ss = SS) %>%
  dplyr::mutate(
    Nstents = ifelse(is.na(.data$antall_stent),
                     0,
                     .data$antall_stent))

```



```{r Daterecodes,include=FALSE, eval=TRUE}

AP$Year <- as.numeric(
  format(
    x = AP $ ProsedyreDato,
    format = "%Y"))

AP$Week <- as.numeric(
  format(
    x = AP $ ProsedyreDato,
    format = "%W"))


AP$nMonth <- as.numeric(
  as.factor(
    format(
      AP$ProsedyreDato,
      format = "%y-%m")))

AP$Month <- as.numeric(
  format(
    x = AP$ProsedyreDato,
    format = "%m"))

AP$YearMonth <- factor(
  format(
    x = AP$ProsedyreDato,
    format = "%y-%m"))

AP$Day <- as.numeric(
  AP$ProsedyreDato - min(AP$ProsedyreDato, na.rm = TRUE))



SS$ProsedyreDato <- as.Date(
  x = SS$ProsedyreDato,
  format = "%Y-%m-%d")

SS$Month <- as.numeric(
  format(
    x = SS$ProsedyreDato,
    format = "%m"))

SS$Year <- as.numeric(
  format(
    x = SS$ProsedyreDato,
    format = "%y"))

SS$YearMonth <- factor(
  format(
    x = SS$ProsedyreDato,
    format = "%y-%m"))

```

```{r subsetting,include=FALSE, eval=TRUE}

NSTEMI <- subset(
  x = AP,
  subset = (Indikasjon == "NSTEMI"))

NSTEMI$Month <- as.factor(
  format(
    x = NSTEMI$ProsedyreDato,
    format = "%y-%m"))

PCImedStent <- subset(
  AP,
  Nstents > 0
)

rangePCImdStentProsDato <- format(
  range(PCImedStent$ProsedyreDato),
  format = "%d-%m-%Y")


AP <- subset(
  x = AP,
  subset = nMonth >= max(nMonth, na.rm = TRUE) - showN)


rangeProsDato <- format(range(AP$ProsedyreDato), 
                        format = "%d-%m-%Y")


AP$Month <- as.factor(
  format(
    x = AP$ProsedyreDato,
    format = "%y-%m"))

```

```{r }
if (params$rendered_by_shiny == TRUE && params$tableFormat == "latex")
    shiny::setProgress(0.1)  # set progress to 10%
```

`r if(params$tableFormat !="html") {"<!--"}`
# Månedsrapport: Prosedyrer og stentbruk {-}
Denne rapporten er generert ved hjelp av resultatløsningen *Rapporteket* og er kun ment til internt bruk! 
<br/> <br/>
Rapporten inneholder tabeller og figurer med resultater basert på forløp registrert ved `r params$hospitalName`. Opptellinger og statistikker er gjort per forløp/prosedyre, og ikke per individ. Tabellene og figurene presenteres med data fra perioden `r rangeProsDato[1]` til `r rangeProsDato[2]`.
<br/><br/>
Eventuelle spørsmål knyttet til rapporten kan rettes til [noric@helse-bergen.no](mailto:noric@helse-bergen.no)
`r if(params$tableFormat !="html") {"-->"}`


`r if(params$tableFormat !="latex") {"<!--"}`
\newpage
`r if(params$tableFormat !="latex") {"-->"}`

<br/><br/>

# Prosedyrer

## Hastegrad
```{r FigNHastegrad, fig.cap = paste0("Antall prosedyrer registrert i NORIC per måned og hastegrad ved ", params$hospitalName, " i perioden ", rangeProsDato[1], " til ", rangeProsDato[2], "."), fig.width = 10, fig.height = 4.5, fig.pos = "H", fig.align = "center", out.width = "\\textwidth"}

pal <- colPrimary[c(5, 3, 1)]

hastegradMaaned <- AP %>%
  dplyr::count(.data$maaned,
               .data$Hastegrad) %>%
  dplyr::group_by(.data$maaned, .data$Hastegrad)

hastegrad_levels <- c("Planlagt", "Subakutt", "Akutt")

hastegradMaaned %>% ggplot2::ggplot(
  ggplot2::aes(x = .data$maaned,
               y = .data$n,
               fill = factor(.data$Hastegrad,
                             levels = hastegrad_levels))
) +
  ggplot2::geom_bar(position = "stack", stat = "identity") +
  ggplot2::scale_fill_manual(values = pal) +
  ggplot2::theme_minimal() +
  ggplot2::xlab("Måned") +
  ggplot2::ylab("Antall") +
  ggplot2::theme(legend.title = ggplot2::element_blank(),
                 axis.text = ggplot2::element_text(size = 12),
                 axis.text.x = ggplot2::element_text(angle = 45, hjust = 1))

```

```{r TabNHastegrad, results='asis', eval=TRUE}
cap <- paste0("Antall (andel) prosedyrer registrert i NORIC per måned ",
              "og hastegrad ved ", params$hospitalName,
              " i perioden ", rangeProsDato[1], " til ",
              rangeProsDato[2], ".")
xtabs(formula = ~ maaned + Hastegrad, data = AP) %>%
  noric::prettyTab(., add_totals = TRUE) %>%
  noric::mst(.,
             type = params$tableFormat,
             cap = cap,
             digs = 0,
             align = rep("r", 5),
             label = "TabNHastegrad")
```

```{r}
if (params$rendered_by_shiny == TRUE && params$tableFormat == "latex")
    shiny::setProgress(0.2)  # set progress to 20%
```

<br/>

## Prosedyretype
```{r FigNProsedyreType, fig.cap =  paste0("Antall koronare angiografier og/eller PCI registrert i NORIC per måned ved ", params$hospitalName, " i perioden ", rangeProsDato[1], " til ", rangeProsDato[2], "."), fig.width = 8, fig.height = 5,  fig.pos = "H", fig.align = "center", out.width = "\\textwidth"}

pal <- colPrimary[c(5, 3, 1)]


prosedyreTypeMaaned <- AP %>%
  dplyr::count(.data$maaned,
               .data$ProsedyreType) %>%
  dplyr::group_by(.data$maaned, .data$ProsedyreType)

prosedyreType_levels <- c("Angio", "Angio + PCI", "PCI")

prosedyreTypeMaaned %>% ggplot2::ggplot(
  ggplot2::aes(x = .data$maaned,
               y = .data$n,
               fill = factor(.data$ProsedyreType,
                             levels = prosedyreType_levels))
) +
  ggplot2::geom_bar(position = "stack", stat = "identity") +
  ggplot2::scale_fill_manual(values = pal) +
  ggplot2::theme_minimal() +
  ggplot2::xlab("Måned") +
  ggplot2::ylab("Antall") +
  ggplot2::theme(legend.title = ggplot2::element_blank(),
                 axis.text = ggplot2::element_text(size = 12),
                 axis.text.x = ggplot2::element_text(angle = 45, hjust = 1))

```


```{r TabNProsedyreType,  results = 'asis'}
cap <- paste0("Antall (andel) koronare angiografier og/eller PCI registrert ",
              "i NORIC per måned ved ", params$hospitalName,
              " i perioden ", rangeProsDato[1], " til ",
              rangeProsDato[2], ".")
xtabs(formula = ~ maaned + ProsedyreType, data = AP) %>%
  noric::prettyTab(., add_totals = TRUE) %>%
  noric::mst(., type = params$tableFormat, cap = cap, digs = 0,
             label = "TabNProsedyreType")
```

```{r}
if (params$rendered_by_shiny == TRUE && params$tableFormat == "latex")
    shiny::setProgress(0.3)  # set progress to 30%
```

<br/>

## Indikasjon
```{r FigNIndikasjon, fig.cap = paste0("Antall prosedyrer registrert i NORIC per måned og indikasjon ved ", params$hospitalName, " i perioden ", rangeProsDato[1], " til ", rangeProsDato[2], "."), fig.width = 10, fig.height = 6, fig.pos = "H", fig.align = "center", out.width="\\textwidth"}


Indikasjon2Maaned <- AP %>%
  dplyr::count(.data$maaned,
               .data$Indikasjon2) %>%
  dplyr::group_by(.data$maaned, .data$Indikasjon2)

Indikasjon2_levels <- c("Annet",
                        "STEMI",
                        "NSTEMI",
                        "UAP",
                        "SAP",
                        "Uklare brystsmerter")

Indikasjon2Maaned %>% ggplot2::ggplot(
  ggplot2::aes(x = .data$maaned,
               y = .data$n,
               fill = factor(.data$Indikasjon2,
                             levels = Indikasjon2_levels))) +
  ggplot2::geom_bar(position = "stack", stat = "identity") +
  ggplot2::scale_fill_manual(values = colPrimary) +
  ggplot2::theme_minimal() +
  ggplot2::xlab("Måned") +
  ggplot2::ylab("Antall") +
  ggplot2::theme(legend.title = ggplot2::element_blank(),
                 axis.text = ggplot2::element_text(size = 12),
                 axis.text.x = ggplot2::element_text(angle = 45, hjust = 1))

```



```{r TabNIndikasjon,  results = 'asis'}
cap <- paste0("Antall (andel) prosedyrer registrert i NORIC per måned ",
              "og indikasjon ved ", params$hospitalName, " i perioden ",
              rangeProsDato[1], " til ", rangeProsDato[2], ".")
xtabs(formula = ~ maaned + Indikasjon2, data = AP) %>%
  noric::prettyTab(., add_totals = TRUE) %>%
  noric::mst(.,
             type = params$tableFormat,
             cap = cap,
             digs = 0,
             align = rep("r", 8),
             lsd = TRUE,
             label = "TabNIndikasjon")
```

```{r}
if (params$rendered_by_shiny == TRUE && params$tableFormat == "latex")
    shiny::setProgress(0.4)  # set progress to 40%
```

<br/>

## Annen diagnostikk og tilleggsprosedyrer
```{r TabTillegg,include=FALSE}
PrintTabTilleggCol <- function(VAR) {
  nVAR <- addmargins(
    table(
      AP$maaned,
      addNA(factor(
        AP[, VAR],
        levels = c("Ja", "Nei", "")))),
    margin = 1)

  nVARja <- sprintf(
    "%3.0f",
    nVAR[, which(colnames(nVAR) == "Ja")]
  )

  rVAR <- round(
    100 * prop.table(nVAR, margin = 1),
    digits = 1)

  rVARja <- sprintf(
    "%4.1f",
    rVAR[, which(colnames(rVAR) == "Ja")]
  )

  prosentJa <- paste0(nVARja, " (", rVARja, "%)")
  prosentJa[prosentJa == "  0 ( 0.0%)"] <- "    -    "

  return(prosentJa)
}

TilleggVars <- c(
  "FFR",
  "Doppler",
  "IVUS",
  "OCT",
  "IFR",
  "NIRS",
  "HoyreHjerteKat",
  "Perikardiocentese",
  "Pacemaker",
  "Aortaballongpumpe",
  "Impella",
  "Trombectomy",
  "ECMO",
  "AnnenDiag")

IndexMinEnTillegg <- unique(
  unlist(
    lapply(
      X = TilleggVars,
      FUN = function(X) which(AP[, X] == "Ja")
    )))

AP$IngenTillegg <- "Ja"
AP$IngenTillegg[IndexMinEnTillegg] <- "Nei"

TabTillegg <- cbind(
  PrintTabTilleggCol("FFR"),
  PrintTabTilleggCol("Doppler"),
  PrintTabTilleggCol("IVUS"),
  PrintTabTilleggCol("OCT"),
  PrintTabTilleggCol("IFR"),
  PrintTabTilleggCol("NIRS"),
  PrintTabTilleggCol("HoyreHjerteKat"),
  PrintTabTilleggCol("Perikardiocentese"),
  PrintTabTilleggCol("Pacemaker"),
  PrintTabTilleggCol("Aortaballongpumpe"),
  PrintTabTilleggCol("Impella"),
  PrintTabTilleggCol("Trombectomy"),
  PrintTabTilleggCol("ECMO"),
  PrintTabTilleggCol("AnnenDiag"),
  PrintTabTilleggCol("IngenTillegg")
)

TilleggLabels <- c(
  "FFR",
  "Doppler",
  "IVUS",
  "OCT",
  "IFR",
  "NIRS",
  "Høyre kat.",
  "Perikardiocentese",
  "PM",
  "IABP",
  "Impella",
  "Trombectomy",
  "ECMO",
  "Annen",
  "Ingen")


rownames(TabTillegg) <- c(levels(AP$maaned), "Totalt")
colnames(TabTillegg) <- c(TilleggLabels)


TabTillegg %<>%
  cbind(., AP %>%
          dplyr::count(maaned) %>%
          janitor::adorn_totals("row") %>%
          dplyr::transmute(Totalt = n))
```


### Annen diagnostikk ved angiografi
```{r TabTilleggsProsedyre1,  results = 'asis'}
cap <- paste0("Antall (andel) prosedyrer registrert i NORIC der det er utført ",
              "annen diagnostikk per måned ved ", params$hospitalName, " i perioden ", 
              rangeProsDato[1], " til ", rangeProsDato[2], ".")
noric::mst(TabTillegg[, c("FFR",
                         "IFR",
                         "OCT",
                         "IVUS",
                         "NIRS",
                         "Totalt")],
           type = params$tableFormat,
           cap = cap,
           digs = 0,
           align = rep("c", 8),
           label = "TabTilleggsProsedyre1")

```


### Tilleggsprosedyrer med direkte tilknytning til AngioPCI
```{r TabTilleggsProsedyre2,  results = 'asis'}
cap <- paste0("Antall (andel) tilleggsprosedyrer registrert i NORIC der det er ",
              "utført koronare angiografier og/eller PCI per måned ved ",
              params$hospitalName, " i perioden ", rangeProsDato[1], " til ",
              rangeProsDato[2], ".")
noric::mst(TabTillegg[, c("Høyre kat.",
                         "Perikardiocentese",
                         "Totalt")],
           type = params$tableFormat,
           cap = cap,
           digs = 0,
           align = rep("c", 4),
           label = "TabTilleggsProsedyre2")
```



### Adjuvant terapi
```{r TabTilleggsProsedyre3,  results = 'asis'}
cap <- paste0("Antall (andel) prosedyrer registrert i NORIC der det er utført ",
              "invasiv tilleggsbehandling per måned ved ", params$hospitalName,
              " i perioden ", rangeProsDato[1], " til ", rangeProsDato[2], ".")
noric::mst(TabTillegg[, c("PM",
                          "IABP",
                          "Impella",
                          "Trombectomy",
                          "ECMO",
                          "Annen",
                          "Ingen",
                          "Totalt")],
           type = params$tableFormat,
           cap = cap,
           digs = 0,
           align = rep("c", 9),
           lsd = TRUE,
           label = "TabTilleggsProsedyre3")
```


```{r}
if (params$rendered_by_shiny == TRUE && params$tableFormat == "latex")
    shiny::setProgress(0.5)  # set progress to 50%
```

`r if(params$tableFormat !="latex") {"<!--"}`
\newpage
`r if(params$tableFormat !="latex") {"-->"}`

<br/>

## Komplikasjoner
### Komplikasjoner på lab for `r params$hospitalName`  i perioden `r paste0(rangeProsDato, collapse = ' til ' )`

Datagrunnlaget for komplikasjoner på lab gjelder alle forløp.

```{r TabLabKompl,results='asis'}

LabKomplikasjoner <- data.frame(
  VarName = c(
    "LabKomplikasjon",
    "LabKompAllergiskLettModerat",
    "LabKompAllergiskAlvorlig",
    "LabKompBehkrevendeArytmi",
    "LabKompHemodynamisk",
    "LabKompNeurologisk",
    "LabKompVaskulaerIkkeKoronar",
    "LabKompMistetStent",
    "LabKompVedvarSidegrensokkl",
    "LabKompPerforasjon",
    "LabKompTamponade",
    "LabKompAkuttACBOperasjon",
    "LabKompAnnenAlv",
    "LabKompDod",
    "LabKompProsedyrerelatertDod"
  ),
  Komplikasjon = c(
    "Alle komplikasjoner",
    "Allergisk reaksjon lett/moderat",
    "Allergisk reaksjon alvorlig",
    "Behandlingskrevende arytmi",
    "Hemodynamisk",
    "Neurologisk",
    "Vaskulaer (men ikke koronar)",
    "Mistet stent",
    "Vedvarende sidegrensokklusjon",
    "Perforasjon",
    "Tamponade",
    "Akutt ACB-operasjon fra lab",
    "Annen alvorlig",
    "Død",
    "- Der av prosedyrerelatert død"
  )
)

LabKomplikasjoner$Antall <- unlist(
  lapply(
    X = LabKomplikasjoner$VarName,
    FUN = function(X) {
      try(sum(AP[, X] == "Ja", na.rm = TRUE))
    }
  ))

LabKomplikasjoner$Prosent <- round(
  100 * LabKomplikasjoner$Antall / dim(AP)[1],
  digits = 2)

prosRelatertDodLab <- LabKomplikasjoner[LabKomplikasjoner$VarName == "LabKompProsedyrerelatertDod",]

LabKomplikasjoner_uPRD <- LabKomplikasjoner[!LabKomplikasjoner$VarName == "LabKompProsedyrerelatertDod", ]

i.labkomp <- rev(order(LabKomplikasjoner_uPRD$Prosent))
LabKomplikasjoner_uPRD <- LabKomplikasjoner_uPRD[i.labkomp, ]

indeksDod <- which(LabKomplikasjoner_uPRD == "LabKompDod")

LabKomplikasjoner_sortert <- rbind(LabKomplikasjoner_uPRD[1:indeksDod,],
                               prosRelatertDodLab,
                               LabKomplikasjoner_uPRD[-(1:indeksDod),])

df <- LabKomplikasjoner_sortert[, -1]
rownames(df) <- NULL

noric::mst(df,
           type = params$tableFormat,
           cap = NULL,
           digs = 1,
           align = c("l", "r", "r", "r"),
           label = "TabLabKompl")
```




```{r FigLabKompl, fig.cap = paste0("Andel komplikasjoner på laboratoriet registrert i NORIC ved ", params$hospitalName, " i perioden ", rangeProsDato[1], " til ", rangeProsDato[2], "."), echo=FALSE, fig.pos="H", fig.width = 10, fig.height = 5, fig.align = "center", out.width = "\\textwidth"}

par(
  mar = c(4, 15, 2, 2),
  xpd = NA,
  las = 1)

i.labkomp <- order(LabKomplikasjoner_uPRD$Prosent)
LabKomplikasjoner_uPRD_fig <- LabKomplikasjoner_uPRD[i.labkomp, ]

indeksDod_fig <- which(LabKomplikasjoner_uPRD_fig == "LabKompDod")

if (indeksDod_fig == 1) {
  LabKomplikasjoner_sortert_fig <- rbind(prosRelatertDodLab,
                               LabKomplikasjoner_uPRD_fig)
} else {
  LabKomplikasjoner_sortert_fig <- rbind(LabKomplikasjoner_uPRD_fig[1:indeksDod_fig-1,],
                                         prosRelatertDodLab,
                                         LabKomplikasjoner_uPRD_fig[-(1:indeksDod_fig-1),])
}

lk <- LabKomplikasjoner_sortert_fig[, 4]
names(lk) <- LabKomplikasjoner_sortert_fig[, 2]

xBarplot <- barplot(
  lk,
  xlab = "Andel (%)",
  horiz = TRUE,
  border = FALSE,
  col = colPrimary[3]
  )

text(
  x = LabKomplikasjoner_sortert_fig[, 4],
  y = xBarplot,
  pos = 4,
  col = "#000000AA",
  labels = LabKomplikasjoner_sortert_fig[, 3])
```

`r if(params$tableFormat !="latex") {"<!--"}`
\newpage
`r if(params$tableFormat !="latex") {"-->"}`

### Komplikasjoner på avdelingen for `r params$hospitalName` i perioden `r paste0(rangeProsDato, collapse = ' til ' )`

Datagrunnlaget for komplikasjoner på avdelingen gjelder kun primære forløp.

[***Her***](#komplSkjema) er en oversikt over antall (andel) ferdigstilte komplikasjonsskjemaer.

```{r TabAvdKompl,results='asis'}

#Kun primærforløp og der SkjemaStatusKomplikasjoner er 1
AP_avdKomp <- AP %>% dplyr::filter(.data$Regtype %in% "Primær")

AvdKomplikasjoner <- data.frame(
  VarName = c(
    "AvdKomp",
    "AvdKompAllergisk",
    "AvdKompBlodning",
    "AvdKompVaskulaer",
    "AvdKompNeurologiskKomp",
    "AvdKompNyNyreinsuffisiens",
    "AvdKompTamponade",
    "AvdKompPCI",
    "AvdKompACB",
    "AvdKompHjerteinfarkt",
    "AvdKompAnnenAlvorlig",
    "AvdKompDod",
    "AvdKompProsedyrerelatertDod"
  ),
  Komplikasjon = c(
    "Alle komplikasjoner",
    "Allergisk senkomplikasjon",
    "Noen form for blodning",
    "Vaskulaer (men ikke koronare kar)",
    "Neurologisk",
    "Nytilkommet nyreinsuffisiens",
    "Tamponade",
    "Re-PCI (behandlet segment)",
    "ACB-operasjon (ikke fra lab)",
    "Hjerteinfarkt",
    "Annen alvorlig",
    "Død",
    "- Der av prosedyrerelatert død"
  )
)

AvdKomplikasjoner$Antall <- unlist(
  lapply(
    X = AvdKomplikasjoner$VarName,
    FUN = function(X) {
      try(sum(AP_avdKomp[, X] == "Ja", na.rm = TRUE))
    }
  ))

AvdKomplikasjoner$Prosent <- round(
  100 * AvdKomplikasjoner$Antall / dim(AP_avdKomp)[1],
  digits = 2)

prosRelatertDodAvd <- AvdKomplikasjoner[AvdKomplikasjoner$VarName == "AvdKompProsedyrerelatertDod",]

AvdKomplikasjoner_uPRD <- AvdKomplikasjoner[!AvdKomplikasjoner$VarName == "AvdKompProsedyrerelatertDod", ]

i.avdKomp <- rev(order(AvdKomplikasjoner_uPRD$Prosent))
AvdKomplikasjoner_uPRD <- AvdKomplikasjoner_uPRD[i.avdKomp, ]

indeksDod <- which(AvdKomplikasjoner_uPRD == "AvdKompDod")

AvdKomplikasjoner_sortert <- rbind(AvdKomplikasjoner_uPRD[1:indeksDod,],
                               prosRelatertDodAvd,
                               AvdKomplikasjoner_uPRD[-(1:indeksDod),])

df <- AvdKomplikasjoner_sortert[, -1]

rownames(df) <- NULL
noric::mst(df,
           type = params$tableFormat,
           cap = NULL,
           digs = 1,
           align = c("l", "r", "r"))
```


```{r FigAvdKompl, fig.cap = paste0("Andel komplikasjoner på avdelingen registrert i NORIC ved ", params$hospitalName, " i perioden ", rangeProsDato[1], " til ", rangeProsDato[2], "."), echo=FALSE, fig.pos = "H", fig.width = 10, fig.height = 5, fig.align = "center", out.width = "\\textwidth"}

par(
  mar = c(4, 15, 2, 2),
  xpd = NA,
  las = 1)

i.avdKomp <- order(AvdKomplikasjoner_uPRD$Prosent)
AvdKomplikasjoner_uPRD_fig <- AvdKomplikasjoner_uPRD[i.avdKomp, ]

indeksDod_fig <- which(AvdKomplikasjoner_uPRD_fig == "AvdKompDod")

if (indeksDod_fig == 1) {
  AvdKomplikasjoner_sortert_fig <- rbind(
    prosRelatertDodAvd,
    AvdKomplikasjoner_uPRD_fig)
} else {
  AvdKomplikasjoner_sortert_fig <- rbind(
    AvdKomplikasjoner_uPRD_fig[1:indeksDod_fig-1,],
    prosRelatertDodAvd,
    AvdKomplikasjoner_uPRD_fig[-(1:indeksDod_fig-1),])
}

ak <- AvdKomplikasjoner_sortert_fig[, 4]
names(ak) <- AvdKomplikasjoner_sortert_fig[, 2]

xBarplot <- barplot(
  ak,
  xlab = "Andel (%)",
  horiz = TRUE,
  border = FALSE,
  col = colPrimary[3]
)

text(
  x = AvdKomplikasjoner_sortert_fig[, 4],
  y = xBarplot,
  pos = 4,
  col = "#000000AA",
  labels = AvdKomplikasjoner_sortert_fig[, 3])
```

```{r}
if (params$rendered_by_shiny == TRUE && params$tableFormat == "latex")
    shiny::setProgress(0.6)  # set progress to 60%
```

`r if(params$tableFormat !="latex") {"<!--"}`
\newpage
`r if(params$tableFormat !="latex") {"-->"}`

## Kompletthet
### Kompletthet angio/PCI-skjemaer {-}

```{r SOtab1, results = "asis"}

nSOA <- with(
  SO[which(SO$Skjemanavn == "AngioPCI"), ],
  table(
    maaned,
    factor(
      SkjemaStatus,
      levels = c(0, -1, 1),
      labels = c("Tomt", "Begynt", "Ferdigstilt"))))

rSOA <- round(
  100 * prop.table(nSOA, margin = 1),
  digits = 1)

TABkompletthet <- cbind(
  rowSums(nSOA),
  nSOA[, which(colnames(nSOA) == "Ferdigstilt")],
  rSOA[, which(colnames(rSOA) == "Ferdigstilt")])
colnames(TABkompletthet) <- c("Totalt", "Ferdigstilt", "Prosent")

cap <- paste0("Antall registrerte hovedskjemaer i NORIC per måned ved ",
             params$hospitalName, " i perioden ", rangeProsDato[1],
             " til ", rangeProsDato[2], ".")
noric::mst(tab = TABkompletthet, type = params$tableFormat, cap = cap,
           digs = c(0, 0, 0, 1), align = rep("r", 4),
           label = "SOtab1")
```

### Kompletthet komplikasjonsskjemaer {- #komplSkjema}
```{r SOtab2, results = "asis"}

nSOU <- with(
  SO[which(SO$Skjemanavn == "Kompl"), ],
  table(
    maaned,
    factor(SkjemaStatus,
           levels = c(0, -1, 1),
           labels = c("Tomt", "Begynt", "Ferdigstilt"))))

rSOU <- round(
  100 * prop.table(
    nSOU,
    margin = 1),
  digits = 1)

TABkompletthet <- cbind(
  rowSums(nSOU),
  nSOU[, which(colnames(nSOU) == "Ferdigstilt")],
  rSOU[, which(colnames(rSOU) == "Ferdigstilt")])
colnames(TABkompletthet) <- c("Totalt", "Ferdigstilt", "Prosent")


cap <- paste0("Antall komplikasjonsskjemaer registrert i NORIC per måned ved ", params$hospitalName,
              " i perioden ", rangeProsDato[1], " til ", rangeProsDato[2], ".")
noric::mst(tab = TABkompletthet, type = params$tableFormat, cap = cap,
           digs = c(0, 0, 0, 1), align = rep("r", 4),
           label = "SOtab2")

```

### Kompletthet utskrivelsesskjemaer {-}
```{r SOtab3, results = "asis"}

nSOU <- with(
  SO[which(SO$Skjemanavn == "Utskrivelse"), ],
  table(
    maaned,
    factor(SkjemaStatus,
           levels = c(0, -1, 1),
           labels = c("Tomt", "Begynt", "Ferdigstilt"))))

rSOU <- round(
  100 * prop.table(
    nSOU,
    margin = 1),
  digits = 1)

TABkompletthet <- cbind(
  rowSums(nSOU),
  nSOU[, which(colnames(nSOU) == "Ferdigstilt")],
  rSOU[, which(colnames(rSOU) == "Ferdigstilt")])
colnames(TABkompletthet) <- c("Totalt", "Ferdigstilt", "Prosent")


cap <- paste0("Antall utskrivelsesskjemaer registrert i NORIC per måned ved ", params$hospitalName,
              " i perioden ", rangeProsDato[1], " til ", rangeProsDato[2], ".")
noric::mst(tab = TABkompletthet, type = params$tableFormat, cap = cap,
           digs = c(0, 0, 0, 1), align = rep("r", 4),
           label = "SOtab3")

```

`r if(params$tableFormat !="latex") {"<!--"}`
\newpage
`r if(params$tableFormat !="latex") {"-->"}`


```{r}
if (params$rendered_by_shiny == TRUE && params$tableFormat == "latex")
    shiny::setProgress(0.7)  # set progress to 70%
```

<br/><br/>

# Stentbruk

## Interventsjonstype
```{r TabNRProsedyreType, echo = FALSE, results = "asis"}
cap <- paste0("Antall (andel) utførte intervensjoner registrert i NORIC per ",
              "måned ved ", params$hospitalName, " i perioden ",
              rangeProsDato[1], " til ", rangeProsDato[2], ".")
tail(xtabs(formula = ~ maaned + ProsedyreType2, data = SS),
     n = showN + 1) %>%
  noric::prettyTab(., add_totals = TRUE) %>%
  noric::mst(.,
             type = params$tableFormat,
             cap = cap,
             digs = 0,
             align = rep("r", 7),
             label = "TabNRProsedyreType")
```

<br/>

## Stenter per prosedyre
Antall stenter per prosedyre ved `r params$hospitalName` registrert i NORIC i perioden `r paste0( range(PCImedStent$ProsedyreDato) , collapse = " til ")`. Antall prosedyrer med minst 1 stent er `r sum(PCImedStent$Nstents>0)`.

```{r BarplotNstentPerProsedyre, fig.width = 10, fig.height = 4.5, fig.align = "center", fig.pos = "H", out.width = "\\textwidth", fig.cap = paste0("Antall stenter per prosedyre for ", params$hospitalName, " i perioden ", rangePCImdStentProsDato[1], " til ", rangePCImdStentProsDato[2], ".")}

par(
  mfcol = c(1, 1),
  xpd = NA,
  mar = c(5.1, 4.1, 4.1, 13.1),
  las = 1
  )

TabNStent <- xtabs(
  formula = ~ Nstents,
  data = PCImedStent)

barplot(
  TabNStent,
  xlab = "Antall stenter per prosedyre",
  ylab = "Antall prosedyrer",
  border = FALSE,
  space = 0.3,
  col = colPrimary[3]
)

SumStat <- round(summary(PCImedStent$Nstents), 1)
legend(
  "right",
  inset = -.28,
  bty = "n",
  legend = paste(attr(SumStat, "names"), ": ", SumStat, sep = ""))

``` 


```{r}
if (params$rendered_by_shiny == TRUE && params$tableFormat == "latex")
    shiny::setProgress(0.8)  # set progress to 80%
```

<br/>

## Stent - merke
```{r prepare-data-SS-pci, include = FALSE}
# Siste showN måneder. Ikke vise historiske stenter
SS %<>% dplyr::mutate(nMonth =
                        as.numeric(
                          as.factor(
                            format(
                              ProsedyreDato,
                              format = "%Y-%m"))))
SSpci <-  SS %>%
  dplyr::filter(nMonth >= max(nMonth, na.rm = TRUE) - showN) %>%
  dplyr::filter(ProsedyreType2 == "Stent")
```


```{r TabNstentNameMonth, echo = FALSE, results = "asis", out.width = "\\textwidth"}
cap <- paste0("Antall stenter registrert i NORIC per måned og merke ved ",
              params$hospitalName, " i perioden ", rangePCImdStentProsDato[1],
              " til ", rangePCImdStentProsDato[2], ".")


tab_stent <- addmargins(xtabs(
  formula = ~ maaned + Stentnavn,
  data = SSpci,
  drop.unused.levels = TRUE))

align <- c("l", rep("c", dim(tab_stent)[2] - 1))

if (params$tableFormat == "html") {
  knitr::kable(x = tab_stent, caption = cap, align = align) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped",
                                                    "hover",
                                                    "condensed"),
                              full_width = FALSE) %>%
    kableExtra::row_spec(row = 0, font_size = 10, angle = -45) %>%
    kableExtra::column_spec(column = 1, width = "7em")
} else if (params$tableFormat == "latex") {
  knitr::kable(x = tab_stent,
               format = params$tableFormat,
               caption = cap,
               booktabs = TRUE,
               align = "l") %>%
    kableExtra::kable_styling(latex_options = "HOLD_position") %>%
    kableExtra::row_spec(row = 0, angle = 90)
}
```

`r if(params$tableFormat !="latex") {"<!--"}`
\newpage
`r if(params$tableFormat !="latex") {"-->"}`

```{r}
if (params$rendered_by_shiny == TRUE && params$tableFormat == "latex")
    shiny::setProgress(0.9)  # set progress to 90%
```

`r if(params$tableFormat !="latex" & evaluate_AnP == FALSE) {"<!--"}`
\newpage
`r if(params$tableFormat !="latex" & evaluate_AnP == FALSE) {"-->"}`

<br/><br/>

# Andre prosedyrer
`r if(evaluate_AnP == FALSE){"Dette lokale registeret har ingen registrerte forløp fra Andre Prosedyrer-modulen i datagrunnlaget på nåværende tidspunkt."}`

```{r TabNAndreProsedyrer,  results = 'asis', eval=evaluate_AnP}
cap <- paste0("Antall registrert andre prosedyrer i NORIC (utført uten direkte ",
             "tilknytning til Angio/PCI)  per måned og prosedyretype ved ",
             params$hospitalName, " i perioden ",
             rangeProsDato[1], " til ", rangeProsDato[2], ".")

TabNAndreProsedyrer <- AnP %>% 
  janitor::tabyl(maaned,
                 AnnenProsType,
                 show_missing_levels = FALSE) %>% 
  janitor::adorn_totals("col", name = "Totalt") %>% 
  janitor::adorn_totals("row", name = "Totalt") %>% 
  dplyr::rename(" " = "maaned")

align <- c("l", rep("c", dim(TabNAndreProsedyrer)[2] - 1))

if (params$tableFormat == "html") {
  knitr::kable(x = TabNAndreProsedyrer, caption = cap, align = align) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped",
                                                    "hover",
                                                    "condensed"),
                              full_width = FALSE) %>%
    kableExtra::row_spec(row = 0, font_size = 10, angle = -45) %>%
    kableExtra::column_spec(column = 1, width = "7em")
} else if (params$tableFormat == "latex") {
  knitr::kable(x = TabNAndreProsedyrer,
               format = params$tableFormat,
               caption = cap,
               booktabs = TRUE,
               align = "l") %>%
    kableExtra::kable_styling(latex_options = "HOLD_position") %>%
    kableExtra::row_spec(row = 0, angle = 90)
}
```



```{r}
if (params$rendered_by_shiny == TRUE && params$tableFormat == "latex")
    shiny::setProgress(1)  # set progress to 100%
```
