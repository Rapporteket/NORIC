---
title: "`r paste('Norsk register for invasiv kardiologi (NORIC)', 'Månedsrapport: Invasive prosedyrer for ', params$hospitalName) `"
params:
  author: ukjent forfatter
  hospitalName: ukjent sykehus
  tableFormat: html
  reshID: 999999
  registryName: rapbase
  userFullName: Ukjent bruker
  userRole: ukjent rolle
  rendered_by_shiny: FALSE
header-includes:
- \usepackage[english, norsk]{babel}
- \usepackage{booktabs}
- \usepackage{rotating}
- \usepackage{float}
abstract: '`r paste0("Denne rapporten er generert ved hjelp av resultatløsningen _Rapporteket_ og er kun ment til internt bruk!", "\\newline ", "\\newline ", "Rapporten inneholder tabeller og figurer med resultater basert på forløp registrert ved ", params$hospitalName, ". Opptellinger og statistikker er gjort per forløp/prosedyre, og ikke per individ. Tabellene og figurene presenteres med data fra hele fjoråret samt hittil i år." , "\\newline ", "\\newline ", "Eventuelle spørsmål knyttet til rapporten kan rettes til [noric@helse-bergen.no](mailto:noric@helse-bergen.no)") `'
date: '`r format(Sys.time(), "%d. %B, %Y")`'
registryName: NORIC
regtext: '`r readLines(system.file("registryShortDescription.txt", package = "noric"))`'
reglogo: '`r system.file("logoNORIC.png", package = "noric")`'
userFullName: '`r params$userFullName`'
linkcolor: darkblue
output:
  fig_caption: yes
---

```{r knitrOptions, include=FALSE}
library(magrittr)
library(knitr)
library(kableExtra)
library(dplyr)
library(janitor)

# make sure to use a temporary directory AND absolute paths, e.g. that figs
# can be found also when deployed at a server. See below link for explanation
# https://rgriff23.github.io/2017/04/25/how-to-knit-for-mysite.html
# Also make sure we use tempdir() as working directory so we do not clutter
# the package of the hosting shiny app
# workDir <- tempdir()
# knitr::opts_knit$set(base.dir = workDir,
#                      base.url = file.path(paste0(tempdir(), "/")),
#                      root.dir = workDir)

# Handle both html and latex (pdf) output. Actually to avoid setting 'format'
# for each kable call
# inspired by https://stackoverflow.com/questions/46080853/why-does-rendering-a-pdf-from-rmarkdown-require-closing-rstudio-between-renders
options(knitr.table.format = params$tableFormat)

knitr::opts_chunk$set(warnings = FALSE, echo = FALSE)
options(stringsAsFactors = FALSE)

# For some reason Shiny Server does not get the server locale settings right.
# To display dates correct, enforce locale here:
Sys.setlocale("LC_TIME", "nb_NO.UTF-8")
``` 


```{r SKDEcol, include=FALSE}

colPrimary <- c("#000059",
                "#084594",
                "#2171b5",
                "#4292c6",
                "#6baed6",
                "#c6dbef")
colNeutral <- c("#4D4D4D", "#737373", "#A6A6A6", "#DADADA")
colKontrast <- "#FF7260"

``` 

```{r parametre}
showN <- 14
```





```{r latest_entry, include=FALSE, eval=TRUE}
# DATAGRUNNLAG: PERIODE FOR SQL SPØRRING

# NYESTE DATO:
# Finne nyeste prosedyredato (=nyeste registrering). Vi ønsker ikke at
# forhåndsregisrerte planlagte forløp kommer med i rapporten. Derfor brukes
# gårsdagens dato som referanse, ingen forløp etter denne kommer med .
# Vi vil dermed også kunne se dersom ingen nye registreringer gjøres eller om
# overføringer har stoppet opp

# ELDSTE DATO:
# Januar fra i fjor (hele foregående år skal vise i rapporten)



# Nyeste registrering eller gårsdagen (ikke forhåndsregistreringer)
if (params$registryName %in% "noricStagingNasjonal") {
  nyeste_reg <- min(
      (as.Date(Sys.time()) - 1),
      
      noric::getLatestEntryHospital(registryName = params$registryName, 
                                    reshID = params$reshID)
  )
  
} else {
  nyeste_reg <- min(
      (as.Date(Sys.time()) - 1),
      noric::getLatestEntry(registryName = params$registryName)
  )
}



periode_data <- data.frame(nyeste_reg = nyeste_reg) %>% 
    dplyr::mutate(
      
      
      # SISTE DATO AVGJØR SISTE MÅNED: 
      siste_dato_innevarende_mnd = lubridate::ceiling_date(
        x = nyeste_reg, unit =  "month") - lubridate::days(1),
      
      siste_dato = dplyr::case_when(
        # siste dato er nyeste dato --> nyeste mnd er komlett
        siste_dato_innevarende_mnd == nyeste_reg ~ 
          nyeste_reg, 
        
        # siste dato er ikke nyeste --> nyest mnd er ikke komplett, ta forrige
        siste_dato_innevarende_mnd != nyeste_reg ~ 
          lubridate::floor_date(nyeste_reg, "month") - 
          lubridate::days(1), 
        
        TRUE ~ as.Date(NA_character_)),
      
      
      
      
      # SISTE DATO AVGJØR SISTE KVARTAL
      siste_dato_innevarende_kvartal = lubridate::ceiling_date(
        x = nyeste_reg, 
        unit =  "quarter") - lubridate::days(1),
      
      kvartal_komplett_start = dplyr::case_when(
        # siste dato i kvartalet er lik nyeste dato --> kvartalet er komplett
        siste_dato_innevarende_kvartal == nyeste_reg ~ 
          lubridate::floor_date(nyeste_reg, 
                                unit =  "quarter"), 
        
        # siste dato i kvartalet er ulik nyeste dato -->bruk forrige kvartal
        siste_dato_innevarende_kvartal != nyeste_reg ~ 
          lubridate::floor_date(nyeste_reg, 
                                unit =  "quarter") - months(3), 
        
        TRUE ~ as.Date(NA_character_)),
      
      
      
      # Inneværende år: 
      nyesteRegYear = as.numeric(format(siste_dato, format = "%Y")),
      
      # Fjoråret
      sisteHeleYear = nyesteRegYear - 1, 

      # Inneværende måned i år: 
      nyesteRegMnd = as.numeric(format(siste_dato, format = "%m")),
      
      # Første dato for SQL -spørring : 01. januar fjoråret
      forste_dato  = as.Date(paste0(sisteHeleYear, "-01-01"),
                             format = "%Y-%m-%d"), 
      
      # Aortaklaff + Segment stent (indikator per kvartal): 
      forste_dato_kvartal = as.Date(paste0(sisteHeleYear - 1, "-01-01"),
                                  format = "%Y-%m-%d")
    ) %>% 
    dplyr::select(-siste_dato_innevarende_mnd, 
                  -siste_dato_innevarende_kvartal)
  


```

```{r monthTabPrepare, include=FALSE, eval=TRUE}

timeTableMonth <- data.frame(
  monthDato = seq(periode_data$forste_dato, 
                  periode_data$siste_dato,
                  by = "month")) %>% 
  dplyr::transmute(maaned = as.factor(format(x = .data$monthDato, 
                                             format = "%Y-%m"))) %>% 
  dplyr::mutate(maaned = as.ordered(maaned))

timeTableMonth_fjor <- data.frame(
  monthDato = seq(periode_data$forste_dato, 
                  as.Date(paste("30-12-", periode_data$sisteHeleYear), 
                          format = "%d-%m-%Y"),
                  by = "month")) %>% 
  dplyr::transmute(maaned = as.factor(format(x = monthDato, 
                                             format = "%Y-%m"))) %>% 
  dplyr::transmute(
    maaned = as.ordered(maaned))

timeTableMonth_aar <- data.frame(
  monthDato = seq(as.Date(paste("01-01-", periode_data$nyesteRegYear), 
                          format = "%d-%m-%Y"),
                  periode_data$siste_dato,
                  by = "month")) %>% 
  dplyr::transmute(maaned = as.factor(format(x = monthDato, 
                                             format = "%Y-%m"))) %>% 
    dplyr::transmute(
      maaned = as.ordered(maaned))


rangeProsDato <- paste(format(periode_data$forste_dato, 
                              "%d/%m-%Y"), 
                       "til", 
                       format(periode_data$siste_dato, 
                              "%d/%m-%Y"))
```


```{r GetData, include=FALSE, cache=FALSE}

if(params$registryName %in% "noricStagingNasjonal"){

# SPørring til NASJONAL database. Kun utvalgt sykehus
    AP <- noric::getPrepApData(registryName = params$registryName,
                             fromDate  = periode_data$forste_dato,
                             toDate = periode_data$siste_dato,
                             singleRow = FALSE, 
                             singleHospital = params$reshID)
  
  AnP <- noric::getPrepAnPData(registryName = params$registryName,
                               fromDate  = periode_data$forste_dato,
                               toDate = periode_data$siste_dato,
                               singleRow = FALSE, 
                             singleHospital = params$reshID)
  
  evaluate_AnP <- nrow(AnP) > 0 # for conditional running of AnP-related chunks
  # (TRUE when AnP contains data)
  
  
  SS <- noric::getPrepSsData(registryName = params$registryName,
                             fromDate  = periode_data$forste_dato,
                             toDate = periode_data$siste_dato,
                             singleRow = FALSE, 
                             singleHospital = params$reshID)
  
  AnD <- noric::getPrepAnDData(registryName = params$registryName,
                             fromDate  = periode_data$forste_dato,
                             toDate = periode_data$siste_dato,
                             singleRow = FALSE, 
                             singleHospital = params$reshID)
  
  
  } else{
    # SPørring til LOKAL database. 
    # Kun et sykehus, som er registry name

  AP <- noric::getPrepApData(registryName = params$registryName,
                             fromDate  = periode_data$forste_dato,
                             toDate = periode_data$siste_dato,
                             singleRow = FALSE, 
                             singleHospital = NULL)
  
  AnP <- noric::getPrepAnPData(registryName = params$registryName,
                               fromDate  = periode_data$forste_dato,
                               toDate = periode_data$siste_dato,
                               singleRow = FALSE, 
                             singleHospital = NULL)
  
  evaluate_AnP <- nrow(AnP) > 0 # for conditional running of AnP-related chunks
  # (TRUE when AnP contains data)
  
  
  SS <- noric::getPrepSsData(registryName = params$registryName,
                             fromDate  = periode_data$forste_dato,
                             toDate = periode_data$siste_dato,
                             singleRow = FALSE, 
                             singleHospital = NULL)
  
  AnD <- noric::getPrepAnDData(registryName = params$registryName,
                             fromDate  = periode_data$forste_dato,
                             toDate = periode_data$siste_dato,
                             singleRow = FALSE, 
                             singleHospital = NULL)
}


```


```{r AnPPrepare,include=evaluate_AnP, eval=evaluate_AnP}

AnP %<>% 
  dplyr::mutate(
    AnnenProsType = factor(x = AnnenProsType,
                           levels = c("Høyre hjertekateterisering",
                                      "Temporær pacemaker",
                                      "Perikardiocentese",
                                      "Ventilfilming",
                                      "Lukking av ASD/PFO",
                                      "Lukking av venstre aurikkel",
                                      "Impella",
                                      "Plugging av PVL",
                                      "PTSMA",
                                      "Aortaballongpumpe",
                                      "ECMO", 
                                      "Myokardiell biopsi", 
                                      "Tricuspidal klaff TEER"),
                           labels = c("Høyre kat.",
                                      "Temp. PM",
                                      "Perikardiocentese",
                                      "Ventilfilming",
                                      "Lukking ASD/PFO",
                                      "Lukking v. aurikkel",
                                      "Impella",
                                      "Plugging av PVL",
                                      "PTSMA",
                                      "Aortaballongpumpe",
                                      "ECMO", 
                                      "Myokardiell biopsi", 
                                      "Tricuspidal klaff TEER")))

```


```{r SSprepare,include=FALSE, eval=TRUE}

SS %<>% dplyr::select(AvdRESH,
                      ForlopsID,
                      ProsedyreDato,
                      Indikasjon,
                      ProsedyreType,
                      Stentnavn,
                      StentType,
                      maaned)


SS %<>% dplyr::mutate(
  
  Indikasjon = factor(
    dplyr::case_when(Indikasjon == "Stabil koronarsykdom" ~ "SAP",
                     Indikasjon == "UAP" ~ "UAP",
                     Indikasjon == "NSTEMI" ~ "NSTEMI",
                     Indikasjon %in% c("STEMI",
                                       "STEMI > 24h",
                                       "STEMI/Rescue PCI")
                     ~ "STEMI",
                     is.na(Indikasjon) ~ NA_character_,
                     TRUE ~ "Annet"),
    levels = c("SAP", "UAP", "NSTEMI", "STEMI", "Annet", NA)),
  
  ProsedyreType2 = factor(
    dplyr::case_when(
      ProsedyreType %in% c("Direktestent",
                           "Ballong + Stent",
                           "Medikamentell ballong + Stent") ~ "Stent",
      ProsedyreType == "Ballongdilatasjon" ~ "POBA",
      ProsedyreType == "Wireforsøk" ~ "Wireforsøk",
      ProsedyreType == "Rotablator" ~ "Rotablator",
      TRUE ~ "Annet"),
    levels = c("Stent", "POBA", "Wireforsøk", "Rotablator", "Annet")))

```



```{r APprepare, include=FALSE, eval=TRUE}

AP %<>% 
  dplyr::mutate(
    
    ProsedyreDato = as.factor(ProsedyreDato), 
    Sykehusnavn = as.factor(Sykehusnavn),
    
    Indikasjon2 = factor(
      dplyr::case_when(
        Indikasjon == "Stabil koronarsykdom" ~ "SAP",
        Indikasjon == "UAP" ~ "UAP",
        Indikasjon %in% c("STEMI",
                          "Hjertestans ved STEMI",
                          "STEMI > 24h",
                          "STEMI/Rescue PCI") ~ "STEMI",
        Indikasjon == "Uklare brystsmerter" ~ "Uklare brystsmerter",
        Indikasjon == "NSTEMI" ~ "NSTEMI",
        TRUE ~ "Annet"),
      levels = c("Uklare brystsmerter", 
                 "SAP", 
                 "UAP", 
                 "NSTEMI", 
                 "STEMI", 
                 "Annet")), 
    
    Hastegrad = factor(Hastegrad,
                       levels = c("Akutt",
                                  "Subakutt",
                                  "Planlagt",
                                  NA)), 
    SkjemaStatusKomplikasjoner = factor(SkjemaStatusKomplikasjoner, 
                                        levels = c(-1, 0, 1, NA)),
    SkjemastatusHovedskjema = factor(SkjemastatusHovedskjema, 
                                        levels = c(-1, 0, 1, NA)),
    SkjemaStatusUtskrivelse = factor(SkjemaStatusUtskrivelse, 
                                        levels = c(-1, 0, 1, NA)),
    
    
    # Noen form for alvorlig blødning på avdeling
    komplik_avd_alvorligBlodning =  ifelse(
      (AvdKompBlodningMajor  %in% "Ja" |
        AvdKompHbFallStor %in% "Ja" |
        AvdKompForlengetOppholdStor %in% "Ja" |
        AvdKompBlodtransfusjon %in% "Ja" |
        AvdKompKirurgiskBeh %in% "Ja" |
        AvdKompPseudoaneurysme %in% "Ja"), 
      "Ja", 
      NA_character_), 

    
    # Noen form for alvorlig blødning på avdeling
    komplik_avd_ovrigBlodning =  ifelse(
      (AvdKompBlodningMinor  %in% "Ja" |
        AvdKompHematomStor %in% "Ja" |
        AvdKompForlengetTidStor %in% "Ja" ), 
      "Ja", 
      NA_character_))


AP %<>%
  noric::legg_til_antall_stent(df_ap =  ., df_ss = SS) %>%
  dplyr::mutate(
    Nstents = ifelse(is.na(.data$antall_stent),
                     0,
                     .data$antall_stent))


```

```{r }
if (params$rendered_by_shiny == TRUE && params$tableFormat == "latex")
    shiny::setProgress(0.1)  # set progress to 10%
```

`r if(params$tableFormat !="html") {"<!--"}`
# Månedsrapport: Invasive prosedyrer {-}
Denne rapporten er generert ved hjelp av resultatløsningen *Rapporteket* og er kun ment til internt bruk! 
<br/> <br/>
Rapporten inneholder tabeller og figurer med resultater basert på forløp registrert ved `r params$hospitalName`. Opptellinger og statistikker er gjort per forløp/prosedyre, og ikke per individ. Tabellene og figurene presenteres med data fra perioden `r rangeProsDato`.
<br/><br/>
Eventuelle spørsmål knyttet til rapporten kan rettes til [noric@helse-bergen.no](mailto:noric@helse-bergen.no)
`r if(params$tableFormat !="html") {"-->"}`


`r if(params$tableFormat !="latex") {"<!--"}`
\newpage
`r if(params$tableFormat !="latex") {"-->"}`

# Datagrunnlag

## Antall prosedyrer
Rapporten er generert med utgangspunkt i NORIC's database for
`r params$hospitalName`. Det presenteres månedlige resultater for hele 
fjorårets registreringer på aortaklaff,
samt alle fullførte måndeder hittil i år.
Den siste prosedyredatoen som er med i tabellene og 
figurene er `r format(periode_data$siste_dato, '%d. %B %Y')`. 

Totalt `r AP %>% nrow()` invasive prosedyrer ligger til grunn for rapporten, 
`r AP %>% dplyr::filter(aar == periode_data$sisteHeleYear) %>% nrow()` fra 
`r periode_data$sisteHeleYear ` og 
`r AP %>% dplyr::filter(aar == periode_data$nyesteRegYear) %>% nrow()` fra 
`r periode_data$nyesteRegYear `. 


\bigskip \bigskip \bigskip


# Invasive koronare prosedyrer

## Prosedyretype {#prosedyretype}
```{r FigNProsedyreType, fig.cap =  paste0("Antall koronare angiografier og/eller PCI registrert i NORIC per måned ved ", params$hospitalName, " i perioden ", rangeProsDato ,  "."), fig.width = 8, fig.height = 5,  fig.pos = "H", fig.align = "center", out.width = "\\textwidth"}

pal <- colPrimary[c(5, 3, 1)]

prosedyreTypeMaaned <- AP %>%
   dplyr::count(.data$maaned,
               .data$ProsedyreType,
               .data$aar) %>%
  dplyr::group_by(.data$maaned, .data$ProsedyreType, .data$aar)

prosedyreType_levels <- c("Angio", "Angio + PCI", "PCI")

prosedyreTypeMaaned %>% ggplot2::ggplot(
  ggplot2::aes(x = .data$maaned,
               y = .data$n,
               fill = factor(.data$ProsedyreType,
                             levels = prosedyreType_levels))
) +
  ggplot2::geom_bar(position = "stack", stat = "identity") +
  ggplot2::facet_grid(~ .data$aar, scales = "free_x", space = "free_x") +
  ggplot2::scale_fill_manual(values = pal) +
  ggplot2::theme_minimal() +
  ggplot2::xlab("") +
  ggplot2::ylab("Antall prosedyrer") +
  ggplot2::theme(legend.title = ggplot2::element_blank(),
                 strip.text = ggplot2::element_text(size=12),
                 axis.text = ggplot2::element_text(size = 12),
                 axis.text.x = ggplot2::element_text(angle = 45, hjust = 1), 
                 axis.title = ggplot2::element_text(size = 12), 
                 legend.text = ggplot2::element_text(size = 12))


```


```{r TabNProsedyreType,  results = 'asis'}
cap <- paste0("Antall koronare angiografier og/eller PCI registrert ",
              "i NORIC per måned ved ", params$hospitalName,
              " i perioden ", 
              rangeProsDato, ".")

TabPros_fjor <- merge(
  x = timeTableMonth_fjor,
  y = AP %>% 
    janitor::tabyl(maaned,
                   ProsedyreType) %>% 
    janitor::adorn_totals("col", name = "Totalt"), 
  by.x  = "maaned", 
  by.y = "maaned", 
  all.x = TRUE) %>% 
  janitor::adorn_totals("row", name = paste0("Totalt i ",
                                             periode_data$sisteHeleYear)) %>% 
  dplyr::mutate(aar = periode_data$sisteHeleYear) %>% 
  dplyr::relocate("aar", .before = "maaned") 

TabPros_aar <- merge(
  x = timeTableMonth_aar,
  y = AP %>% 
    janitor::tabyl(maaned,
                   ProsedyreType) %>% 
    janitor::adorn_totals("col", name = "Totalt"), 
  by.x  = "maaned", 
  by.y = "maaned", 
  all.x = TRUE) %>% 
  janitor::adorn_totals("row", name = paste0("Totalt hittil i ",
                                             periode_data$nyesteRegYear)) %>% 
  dplyr::mutate(aar = periode_data$nyesteRegYear) %>% 
  dplyr::relocate("aar", .before = "maaned") 


TabPros <- rbind(
  TabPros_fjor, 
  TabPros_aar
)


TabPros[TabPros == 0] <- " - "
TabPros[is.na(TabPros)] <- " - "

align <- c("l", rep("c", dim(TabPros)[2] - 1))
digs <-  rep(0, dim(TabPros)[2] )


if (params$tableFormat == "html") {
  TabPros %>% dplyr::select(-aar) %>% rename(" " = "maaned") %>% 
    knitr::kable(caption = cap, align = align) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped",
                                                    "hover",
                                                    "condensed"),
                              full_width = FALSE, 
                              font_size = 12) %>%
    kableExtra::column_spec(column = 1, width = "7em") %>% 
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=dim(TabPros)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1, 
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabPros)[1])

} else if (params$tableFormat == "latex") {
  TabPros %>% dplyr::select(-aar) %>% rename(" " = "maaned") %>% 
    knitr::kable(format = params$tableFormat,
               caption = cap,
               booktabs = TRUE,
               align = "r") %>%
    kableExtra::kable_styling(latex_options = "HOLD_position", 
                             font_size = 8) %>% 
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE)%>%
    kableExtra::row_spec(row=dim(TabPros)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1,
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabPros)[1])


}
```


```{r}
if (params$rendered_by_shiny == TRUE && params$tableFormat == "latex")
    shiny::setProgress(0.2)  # set progress to 20%
```

<br/>

`r if(params$tableFormat !="latex") {"<!--"}`
\newpage
`r if(params$tableFormat !="latex") {"-->"}`

## Hastegrad
```{r FigNHastegrad, fig.cap = paste0("Antall prosedyrer registrert i NORIC per måned og hastegrad ved ", params$hospitalName, " i perioden ", rangeProsDato, "."), fig.width =8 , fig.height = 5, fig.pos = "H", fig.align = "center", out.width = "\\textwidth"}

pal <- colPrimary[c(5, 3, 1)]

hastegradMaaned <- AP %>%
  dplyr::count(.data$maaned,
               .data$Hastegrad,
               .data$aar) %>%
  dplyr::group_by(.data$maaned, .data$Hastegrad, .data$aar)

hastegrad_levels <- c("Planlagt", "Subakutt", "Akutt")

hastegradMaaned %>% ggplot2::ggplot(
  ggplot2::aes(x = .data$maaned,
               y = .data$n,
               fill = factor(.data$Hastegrad,
                             levels = hastegrad_levels))) +
  ggplot2::geom_bar(position = "stack", stat = "identity") +
  ggplot2::facet_grid(~ .data$aar, scales = "free_x", space = "free_x") +
  ggplot2::scale_fill_manual(values = pal) +
  ggplot2::theme_minimal() +
  ggplot2::xlab("") +
  ggplot2::ylab("Antall prosedyrer") +
  ggplot2::theme(legend.title = ggplot2::element_blank(),
                 strip.text = ggplot2::element_text(size=12),
                 axis.text = ggplot2::element_text(size = 12),
                 axis.text.x = ggplot2::element_text(angle = 45, hjust = 1), 
                 axis.title = ggplot2::element_text(size = 12), 
                 legend.text = ggplot2::element_text(size = 12))
```

```{r TabNHastegrad, results='asis', eval=TRUE}
cap <- paste0("Antall prosedyrer registrert i NORIC per måned ",
              "og hastegrad ved ", params$hospitalName,
              " i perioden ", rangeProsDato, ".")

TabHast_fjor <- merge(
  x = timeTableMonth_fjor,
  y = AP %>% 
    janitor::tabyl(maaned,
                   Hastegrad) %>%
    janitor::adorn_totals("col", name = "Totalt"), 
  by.x  = "maaned", 
  by.y = "maaned", 
  all.x = TRUE) %>% 
  janitor::adorn_totals("row", name = paste0("Totalt i ",
                                             periode_data$sisteHeleYear)) %>% 
  dplyr::mutate(aar = periode_data$sisteHeleYear) %>% 
  dplyr::relocate("aar", .before = "maaned") 

TabHast_aar <- merge(
  x = timeTableMonth_aar,
  y = AP %>% 
    janitor::tabyl(maaned,
                   Hastegrad) %>%
    janitor::adorn_totals("col", name = "Totalt"), 
  by.x  = "maaned", 
  by.y = "maaned", 
  all.x = TRUE) %>% 
  janitor::adorn_totals("row", name = paste0("Totalt hittil i ",
                                             periode_data$nyesteRegYear)) %>% 
  dplyr::mutate(aar = periode_data$nyesteRegYear) %>% 
  dplyr::relocate("aar", .before = "maaned") 


TabHast <- rbind(
  TabHast_fjor, 
  TabHast_aar
)


TabHast[TabHast == 0] <- " - "
TabHast[is.na(TabHast)] <- " - "

align <- c("l", rep("c", dim(TabHast)[2] - 1))
digs <-  rep(0, dim(TabHast)[2] )


if (params$tableFormat == "html") {
  TabHast %>% dplyr::select(-aar) %>% rename(" " = "maaned") %>% 
    knitr::kable(caption = cap, align = align) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped",
                                                    "hover",
                                                    "condensed"),
                              full_width = FALSE, 
                              font_size = 11) %>%
    kableExtra::column_spec(column = 1, width = "7em") %>% 
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=dim(TabHast)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1, 
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabHast)[1])

} else if (params$tableFormat == "latex") {
  TabHast %>% dplyr::select(-aar) %>% rename(" " = "maaned") %>% 
    knitr::kable(format = params$tableFormat,
               caption = cap,
               booktabs = TRUE,
               align = "r") %>%
    kableExtra::kable_styling(latex_options = "HOLD_position", 
                             font_size = 8) %>% 
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE)%>%
    kableExtra::row_spec(row=dim(TabHast)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1,
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabHast)[1])


}


```

<br/>

```{r}
if (params$rendered_by_shiny == TRUE && params$tableFormat == "latex")
    shiny::setProgress(0.3)  # set progress to 30%
```

`r if(params$tableFormat !="latex") {"<!--"}`
\newpage
`r if(params$tableFormat !="latex") {"-->"}`

## Indikasjon

I denne figuren er indikasjonene *Hjertestans ved STEMI*, *STEMI > 24h* og 
*STEMI/Rescue PCI* slått sammen med *STEMI*. 

Indikasjonen *Annet* inkluderer blant annet 
prosedyrer utført som ledd i utredning av hjerteklaffsykdom
eller hjerterytmeforstyrrelser. 

```{r FigNIndikasjon, fig.cap = paste0("Antall prosedyrer registrert i NORIC per måned og indikasjon ved ", params$hospitalName, " i perioden ", rangeProsDato, "."), fig.width = 8, fig.height = 5, fig.pos = "H", fig.align = "center", out.width="\\textwidth"}


Indikasjon2Maaned <- AP %>%
  dplyr::count(.data$maaned,
               .data$Indikasjon2,
               .data$aar) %>%
  dplyr::group_by(.data$maaned, .data$Indikasjon2, .data$aar)

indikasjon2_levels <- c("Annet",
                        "STEMI",
                        "NSTEMI",
                        "UAP",
                        "SAP",
                        "Uklare brystsmerter")

Indikasjon2Maaned %>% ggplot2::ggplot(
  ggplot2::aes(x = .data$maaned,
               y = .data$n,
               fill = factor(.data$Indikasjon2,
                             levels = indikasjon2_levels))) +
  ggplot2::geom_bar(position = "stack", stat = "identity") +
  ggplot2::facet_grid(~ .data$aar, scales = "free_x", space = "free_x") +
  ggplot2::scale_fill_manual(values = rev(colPrimary)) +
  ggplot2::theme_minimal() +
  ggplot2::xlab("") +
  ggplot2::ylab("Antall prosedyrer") +
  ggplot2::theme(legend.title = ggplot2::element_blank(),
                 strip.text = ggplot2::element_text(size=12),
                 axis.text = ggplot2::element_text(size = 12),
                 axis.text.x = ggplot2::element_text(angle = 45, hjust = 1), 
                 axis.title = ggplot2::element_text(size = 12), 
                 legend.text = ggplot2::element_text(size = 12))

```



```{r TabNIndikasjon,  results = 'asis'}
cap <- paste0("Antall prosedyrer registrert i NORIC per måned ",
              "og indikasjon ved ", params$hospitalName, " i perioden ",
              rangeProsDato, ".")

TabIndik_fjor <- merge(
  x = timeTableMonth_fjor,
  y = AP %>% 
  janitor::tabyl(maaned,
                 Indikasjon2) %>% 
  janitor::adorn_totals("col", name = "Totalt"), 
  by.x  = "maaned", 
  by.y = "maaned", 
  all.x = TRUE) %>% 
  janitor::adorn_totals("row", name = paste0("Totalt i ",
                                             periode_data$sisteHeleYear)) %>% 
  dplyr::mutate(aar = periode_data$sisteHeleYear) %>% 
  dplyr::relocate("aar", .before = "maaned") 

TabIndik_aar <- merge(
  x = timeTableMonth_aar,
  y = AP %>% 
  janitor::tabyl(maaned,
                 Indikasjon2) %>% 
  janitor::adorn_totals("col", name = "Totalt"), 
  by.x  = "maaned", 
  by.y = "maaned", 
  all.x = TRUE) %>% 
  janitor::adorn_totals("row", name = paste0("Totalt hittil i ",
                                             periode_data$nyesteRegYear)) %>% 
  dplyr::mutate(aar = periode_data$nyesteRegYear) %>% 
  dplyr::relocate("aar", .before = "maaned") 


TabIndik <- rbind(
  TabIndik_fjor, 
  TabIndik_aar
)


TabIndik[TabIndik == 0] <- " - "
TabIndik[is.na(TabIndik)] <- " - "

align <- c("l", rep("c", dim(TabIndik)[2] - 1))
digs <-  rep(0, dim(TabIndik)[2] )


if (params$tableFormat == "html") {
  TabIndik %>% dplyr::select(-aar) %>% rename(" " = "maaned") %>% 
    knitr::kable(caption = cap, align = align) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped",
                                                    "hover",
                                                    "condensed"),
                              full_width = FALSE, 
                              font_size = 11) %>%
    kableExtra::column_spec(column = 1, width = "7em") %>% 
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=dim(TabIndik)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1, 
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabIndik)[1])

} else if (params$tableFormat == "latex") {
  TabIndik %>% dplyr::select(-aar) %>% rename(" " = "maaned") %>% 
    knitr::kable(format = params$tableFormat,
               caption = cap,
               booktabs = TRUE,
               align = "r") %>%
    kableExtra::kable_styling(latex_options = "HOLD_position", 
                             font_size = 8) %>% 
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE)%>%
    kableExtra::row_spec(row=dim(TabIndik)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1,
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabIndik)[1])


}

```

```{r}
if (params$rendered_by_shiny == TRUE && params$tableFormat == "latex")
    shiny::setProgress(0.4)  # set progress to 40%
```

<br/>

## Annen diagnostikk og tilleggsprosedyrer
```{r TabTillegg,include=FALSE}
PrintTabTilleggCol <- function(VAR) {
  nVAR <- addmargins(
    table(
      AP$maaned,
      addNA(factor(
        AP[, VAR],
        levels = c("Ja", "Nei", "")))),
    margin = 1)

  nVARja <- sprintf(
    "%3.0f",
    nVAR[, which(colnames(nVAR) == "Ja")]
  )

  rVAR <- round(
    100 * prop.table(nVAR, margin = 1),
    digits = 1)

  rVARja <- sprintf(
    "%4.1f",
    rVAR[, which(colnames(rVAR) == "Ja")]
  )

  # prosentJa <- paste0(nVARja, " (", rVARja, "%)")
  # prosentJa[prosentJa == "  0 ( 0.0%)"] <- "    -    "

  return(nVARja)
}

TilleggVars <- c(
  "FFR",
  "Doppler",
  "IVUS",
  "OCT",
  "IFR",
  "PA_Hyperemi",
  "PD_Hyperemi",
  "PDPA",
  "IMR",
  "NIRS",
  "HoyreHjerteKat",
  "Perikardiocentese",
  "Ventilfilming",
  "Pacemaker",
  "Aortaballongpumpe",
  "Impella",
  "Trombectomy",
  "ECMO",
  "AnnenDiag")

IndexMinEnTillegg <- unique(
  unlist(
    lapply(
      X = TilleggVars,
      FUN = function(X) which(AP[, X] == "Ja")
    )))

AP$IngenTillegg <- "Ja"
AP$IngenTillegg[IndexMinEnTillegg] <- "Nei"

TabTillegg <- cbind(
  PrintTabTilleggCol("FFR"),
  PrintTabTilleggCol("Doppler"),
  PrintTabTilleggCol("IVUS"),
  PrintTabTilleggCol("OCT"),
  PrintTabTilleggCol("IFR"),
  PrintTabTilleggCol("PA_Hyperemi"),
  PrintTabTilleggCol("PD_Hyperemi"),
  PrintTabTilleggCol("PDPA"),
  PrintTabTilleggCol("IMR"),
  PrintTabTilleggCol("NIRS"),
  PrintTabTilleggCol("HoyreHjerteKat"),
  PrintTabTilleggCol("Perikardiocentese"),
  PrintTabTilleggCol("Ventilfilming"),
  PrintTabTilleggCol("Pacemaker"),
  PrintTabTilleggCol("Aortaballongpumpe"),
  PrintTabTilleggCol("Impella"),
  PrintTabTilleggCol("Trombectomy"),
  PrintTabTilleggCol("ECMO"),
  PrintTabTilleggCol("AnnenDiag"),
  PrintTabTilleggCol("IngenTillegg")
)

TilleggLabels <- c(
  "FFR",
  "Doppler",
  "IVUS",
  "OCT",
  "IFR",
  "Pa",
  "Pd",
  "PdPa",
  "IMR",
  "NIRS",
  "Høyre kat.",
  "Perikardiocentese",
  "Ventilfilming",
  "PM",
  "IABP",
  "Impella",
  "Trombectomy",
  "ECMO",
  "Annen",
  "Ingen")


rownames(TabTillegg) <- c(levels(AP$maaned), "Totalt")
colnames(TabTillegg) <- c(TilleggLabels)


TabTillegg %<>%
  cbind(., AP %>%
          dplyr::count(maaned) %>%
          janitor::adorn_totals("row") %>%
          dplyr::transmute(Totalt = n))

  
```
<br/>

### Annen diagnostikk i direkte tilknytning til Angio/PCI
```{r TabTilleggsProsedyre1,  results = 'asis'}
cap <- paste0("Antall (andel) prosedyrer registrert i NORIC der det er utført ",
              "annen diagnostikk per måned ved ", params$hospitalName, " i perioden ", 
              rangeProsDato, ".")

TabAnnenDiag_var <- TabTillegg[, c("FFR",
                                    "IFR",
                                    "OCT",
                                    "IVUS",
                                    "Pa",
                                    "Pd",
                                    "PdPa",
                                    "IMR",
                                    "Totalt")]

TabAnnenDiag_fiks <- data.frame(maaned = rownames(TabAnnenDiag_var),
                      TabAnnenDiag_var,
                      row.names = NULL) %>%
  filter(row_number() <= n()-1) %>% 
  mutate_at(vars(-maaned), as.numeric)
         
TabAnnenDiag_fjor <- merge(
  x = timeTableMonth_fjor,
  y = TabAnnenDiag_fiks,
  by.x  = "maaned",
  by.y = "maaned",
  all.x = TRUE) %>%
  janitor::adorn_totals("row", name = paste0("Totalt i ",
                                             periode_data$sisteHeleYear)) %>% 
  dplyr::mutate(aar = periode_data$sisteHeleYear) %>%
  dplyr::relocate("aar", .before = "maaned")


TabAnnenDiag_aar <- merge(
  x = timeTableMonth_aar,
  y = TabAnnenDiag_fiks,
  by.x  = "maaned",
  by.y = "maaned",
  all.x = TRUE) %>% 
  janitor::adorn_totals("row", name = paste0("Totalt hittil i ",
                                             periode_data$nyesteRegYear)) %>% 
  dplyr::mutate(aar = periode_data$nyesteRegYear) %>%
  dplyr::relocate("aar", .before = "maaned")


TabAnnenDiag <- rbind(
  TabAnnenDiag_fjor,
  TabAnnenDiag_aar)

TabAnnenDiag[TabAnnenDiag == 0] <- " - "
TabAnnenDiag[is.na(TabAnnenDiag)] <- " - "

align <- c("l", rep("c", dim(TabAnnenDiag)[2] - 1))
digs <-  rep(0, dim(TabAnnenDiag)[2] )

if (params$tableFormat == "html") {
  TabAnnenDiag %>% dplyr::select(-aar) %>% rename(" " = "maaned") %>% 
    knitr::kable(caption = cap, align = align) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped",
                                                    "hover",
                                                    "condensed"),
                              full_width = FALSE, 
                              font_size = 11) %>%
    kableExtra::column_spec(column = 1, width = "7em") %>% 
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=dim(TabAnnenDiag)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1, 
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabAnnenDiag)[1])

} else if (params$tableFormat == "latex") {
  TabAnnenDiag %>% dplyr::select(-aar) %>% rename(" " = "maaned") %>% 
    knitr::kable(format = params$tableFormat,
               caption = cap,
               booktabs = TRUE,
               align = "r") %>%
    kableExtra::kable_styling(latex_options = "HOLD_position", 
                             font_size = 8) %>% 
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE)%>%
    kableExtra::row_spec(row=dim(TabAnnenDiag)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1,
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabAnnenDiag)[1])
}
```

<br/>

### Tilleggsprosedyrer i direkte tilknytning til Angio/PCI
```{r TabTilleggsProsedyre2,  results = 'asis'}
cap <- paste0("Antall (andel) tilleggsprosedyrer registrert i NORIC der det er ",
              "utført koronare angiografi og/eller PCI per måned ved ",
              params$hospitalName, " i perioden ", rangeProsDato, ".")


TabTilleggspros_var <- TabTillegg[, c("Høyre kat.",
                                      "Perikardiocentese",
                                      "Ventilfilming",
                                      "Totalt")]

TabTilleggspros_fiks <- data.frame(maaned = rownames(TabTilleggspros_var),
                      TabTilleggspros_var,
                      row.names = NULL) %>%
  filter(row_number() <= n()-1) %>% 
  mutate_at(vars(-maaned), as.numeric)
         
TabTilleggspros_fjor <- merge(
  x = timeTableMonth_fjor,
  y = TabTilleggspros_fiks,
  by.x  = "maaned",
  by.y = "maaned",
  all.x = TRUE) %>%
  janitor::adorn_totals("row", name = paste0("Totalt i ",
                                             periode_data$sisteHeleYear)) %>% 
  dplyr::mutate(aar = periode_data$sisteHeleYear) %>%
  dplyr::relocate("aar", .before = "maaned")


TabTilleggspros_aar <- merge(
  x = timeTableMonth_aar,
  y = TabTilleggspros_fiks,
  by.x  = "maaned",
  by.y = "maaned",
  all.x = TRUE) %>%
  janitor::adorn_totals("row", name = paste0("Totalt hittil i ",
                                             periode_data$nyesteRegYear)) %>% 
  dplyr::mutate(aar = periode_data$nyesteRegYear) %>%
  dplyr::relocate("aar", .before = "maaned")


TabTilleggspros <- rbind(
  TabTilleggspros_fjor,
  TabTilleggspros_aar)

TabTilleggspros[TabTilleggspros == 0] <- " - "
TabTilleggspros[is.na(TabTilleggspros)] <- " - "

align <- c("l", rep("c", dim(TabTilleggspros)[2] - 1))
digs <-  rep(0, dim(TabTilleggspros)[2] )


if (params$tableFormat == "html") {
  TabTilleggspros %>% dplyr::select(-aar) %>% rename(" " = "maaned") %>% 
    knitr::kable(caption = cap, align = align) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped",
                                                    "hover",
                                                    "condensed"),
                              full_width = FALSE, 
                              font_size = 11) %>%
    kableExtra::column_spec(column = 1, width = "7em") %>% 
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=dim(TabTilleggspros)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1, 
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabTilleggspros)[1])

} else if (params$tableFormat == "latex") {
  TabTilleggspros %>% dplyr::select(-aar) %>% rename(" " = "maaned") %>% 
    knitr::kable(format = params$tableFormat,
               caption = cap,
               booktabs = TRUE,
               align = "r") %>%
    kableExtra::kable_styling(latex_options = "HOLD_position", 
                             font_size = 8) %>% 
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE)%>%
    kableExtra::row_spec(row=dim(TabTilleggspros)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1,
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabTilleggspros)[1])
}

```



### Adjuvant terapi i direkte tilknytning til Angio og/eller PCI
```{r TabTilleggsProsedyre3,  results = 'asis'}
cap <- paste0("Antall (andel) prosedyrer registrert i NORIC der det er utført ",
              "tilleggsbehandling i tilknytning til angiografi og/eller PCI ",
              "per måned ved ", params$hospitalName,
              " i perioden ", rangeProsDato, ".")

TabAdjTerapi_var <- TabTillegg[, c("PM",
                                   "IABP",
                                   "Impella",
                                   "ECMO",
                                   "Totalt")]

TabAdjTerapi_fiks <- data.frame(maaned = rownames(TabAdjTerapi_var),
                      TabAdjTerapi_var,
                      row.names = NULL) %>%
  filter(row_number() <= n()-1) %>% 
  mutate_at(vars(-maaned), as.numeric)
         
TabAdjTerapi_fjor <- merge(
  x = timeTableMonth_fjor,
  y = TabAdjTerapi_fiks,
  by.x  = "maaned",
  by.y = "maaned",
  all.x = TRUE) %>%
  janitor::adorn_totals("row", name = paste0("Totalt i ",
                                             periode_data$sisteHeleYear)) %>% 
  dplyr::mutate(aar = periode_data$sisteHeleYear) %>%
  dplyr::relocate("aar", .before = "maaned")


TabAdjTerapi_aar <- merge(
  x = timeTableMonth_aar,
  y = TabAdjTerapi_fiks,
  by.x  = "maaned",
  by.y = "maaned",
  all.x = TRUE) %>%
  janitor::adorn_totals("row", name = paste0("Totalt hittil i ",
                                             periode_data$nyesteRegYear)) %>% 
  dplyr::mutate(aar = periode_data$nyesteRegYear) %>%
  dplyr::relocate("aar", .before = "maaned")


TabAdjTerapi <- rbind(
  TabAdjTerapi_fjor,
  TabAdjTerapi_aar)

TabAdjTerapi[TabAdjTerapi == 0] <- " - "
TabAdjTerapi[is.na(TabAdjTerapi)] <- " - "

align <- c("l", rep("c", dim(TabAdjTerapi)[2] - 1))
digs <-  rep(0, dim(TabAdjTerapi)[2] )


if (params$tableFormat == "html") {
  TabAdjTerapi %>% dplyr::select(-aar) %>% rename(" " = "maaned") %>% 
    knitr::kable(caption = cap, align = align) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped",
                                                    "hover",
                                                    "condensed"),
                              full_width = FALSE, 
                              font_size = 11) %>%
    kableExtra::column_spec(column = 1, width = "7em") %>% 
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=dim(TabAdjTerapi)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1, 
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabAdjTerapi)[1])

} else if (params$tableFormat == "latex") {
  TabAdjTerapi %>% dplyr::select(-aar) %>% rename(" " = "maaned") %>% 
    knitr::kable(format = params$tableFormat,
               caption = cap,
               booktabs = TRUE,
               align = "r") %>%
    kableExtra::kable_styling(latex_options = "HOLD_position", 
                             font_size = 8) %>% 
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE)%>%
    kableExtra::row_spec(row=dim(TabAdjTerapi)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1,
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabAdjTerapi)[1])
}


```


```{r}
if (params$rendered_by_shiny == TRUE && params$tableFormat == "latex")
    shiny::setProgress(0.5)  # set progress to 50%
```

`r if(params$tableFormat !="latex") {"<!--"}`
\newpage
`r if(params$tableFormat !="latex") {"-->"}`

<br/>

## Komplikasjoner
Eventuelle komplikasjoner forbundet med invasiv koronar utredning og 
behandling blir i NORIC delt i to kategorier, avhengig av om komplikasjonene 
blir oppdaget i tilknytning til selve prosedyren eller i observasjonstiden 
etterpå. 

<br>

### Komplikasjoner på kat.lab.

Her rapporteres komplikasjoner oppstått i tilknytning til selve prosedyren mens 
pasienten fortsatt er på hjertekateteriseringslaboratoriet (kat.lab.) 
Datagrunnlaget omfatter både planlagte, subakutte 
og akutte prosedyrer samlet, uavhengig av pasientens helsetilstand på forhånd.
Vi har gruppert komplikasjonenene som Alvorlige eller Øvrige. 
Figuren viser antall registrerte komplikasjoner fra hele fjoråret samt hittil i år. 
Merk at det kan ha blitt registrert flere typer komplikasjoner for en og samme 
pasient.  


<br/> <br/>

```{r FigLabKompl, fig.cap = paste0("Antall komplikasjoner oppstått i tilknytning til selve prosedyren mens pasienten fortsatt ", "er på hjertekateteriseringslaboratoriet. ", "Sammenlagt i perioden fra ", rangeProsDato, ". Hvis det er registrert flere komplikasjoner på samme ", "pasient er disse talt opp hver for seg. ") , echo=FALSE, fig.pos="H", fig.width = 10, fig.height = 10, fig.align = "center", out.width = "\\textwidth"}



fig_df_kompLab <- AP %>%
  dplyr::select(
    aar,
    
    #Alvorlige
    LabKompAllergiskAlvorlig,
    LabKompBehkrevendeArytmi,
    LabKompHemodynamisk,
    LabKompNeurologisk,
    LabKompVaskulaerIkkeKoronar,
    LabKompPerforasjon,
    LabKompTamponade,
    LabKompAkuttACBOperasjon,
    LabKompAnnenAlv,
    LabKompDod,
    LabKompProsedyrerelatertDod, 
    
    # Øvrige
    LabKompAllergiskLettModerat, 
    LabKompMistetStent, 
    LabKompVedvarSidegrensokkl
    
  ) %>% 
  tidyr::pivot_longer(cols = LabKompAllergiskAlvorlig:LabKompVedvarSidegrensokkl) %>% 
  dplyr::mutate(
    type_komplikasjon = case_when(
      name %in% "LabKompAllergiskAlvorlig" ~ "Allergisk reaksjon alvorlig", 
      name %in% "LabKompBehkrevendeArytmi" ~ "Behandlingskrevende arytmi", 
      name %in% "LabKompHemodynamisk" ~ "Hemodynamisk komplikasjon", 
      name %in% "LabKompNeurologisk" ~ "Nevrologisk komplikasjon", 
      name %in% "LabKompVaskulaerIkkeKoronar" ~ "Vaskul\u00e6r (ikke koronare kar)", 
      name %in% "LabKompPerforasjon" ~ "Perforasjon", 
      name %in% "LabKompTamponade" ~ "Tamponade", 
      name %in% "LabKompAkuttACBOperasjon" ~ "Akutt ACB-operasjon fra lab", 
      name %in% "LabKompAnnenAlv" ~ "Annen alvorlig komplikasjon", 
      name %in% "LabKompDod" ~ "D\u00f8d",
      name %in% "LabKompProsedyrerelatertDod" ~ " - herav prosedyrerelatert d\u00f8d",
      name %in% "LabKompAllergiskLettModerat" ~ "Allergisk lett/moderat",
      name %in% "LabKompMistetStent" ~ "Mistet stent",
      name %in% "LabKompVedvarSidegrensokkl" ~ "Vedvarende sidegrensokklusjon",
      TRUE ~ NA_character_ ), 
    
    gradering = ifelse(name %in% c("LabKompAllergiskLettModerat", 
                                   "LabKompMistetStent", 
                                   "LabKompVedvarSidegrensokkl"), 
                       "Øvrige", 
                       "Alvorlige komplikasjoner på lab")) %>% 
  dplyr::count(name, type_komplikasjon, value, gradering, aar) %>%
  tidyr::pivot_wider(names_from = value, 
                     values_from = n, 
                     values_fill = 0) %>% 
  dplyr::select(name, type_komplikasjon, gradering, Ja, aar)


# Rekkefølge: 
# Først alvorlig, med Annen alvorlig nederst. Så øvrige. 
# Prosedyrerelatert død etter død. 
synkende_rekkefolge_lab <- rbind(
  
  fig_df_kompLab %>% 
    dplyr::filter(name != "LabKompAnnenAlv", 
                  name != "LabKompProsedyrerelatertDod", 
                  gradering %in% "Alvorlige komplikasjoner på lab") %>% 
    dplyr::arrange(-Ja), 
  
  fig_df_kompLab %>% 
    dplyr::filter(name == "LabKompAnnenAlv"), 

  fig_df_kompLab %>% 
    dplyr::filter(gradering %in% "Øvrige") %>% 
    dplyr::arrange(-Ja)
  ) 

insert_prsRel_her <- which(synkende_rekkefolge_lab$name == "LabKompDod")
synkende_rekkefolge_lab %<>%
  dplyr::add_row(
    fig_df_kompLab %>% dplyr::filter(name == "LabKompProsedyrerelatertDod"),
    .after = insert_prsRel_her)


# PARAMETRE FOR FIGUR: 
synkende_rekkefolge_lab %<>% 
  dplyr::group_by(aar) %>%
  dplyr::mutate(
    Sortering  = n():1, 
    
    alpha_soyler= ifelse(
      name %in% "LabKompProsedyrerelatertDod", 
      TRUE, 
      FALSE))   %>%
  ungroup()


# PLOT
ggplot2::ggplot(data = synkende_rekkefolge_lab) +
    
  ggplot2::geom_bar(
    mapping = ggplot2::aes(x = reorder(type_komplikasjon, Sortering) ,
                           y = Ja, 
                           alpha= aar),  
    stat="identity",
    width = 0.8,
    position = ggplot2::position_dodge2(padding=0.2), 
    fill = colPrimary[4]) +
  
  ggplot2::scale_alpha_manual("", values = c(0.5, 1)) +
  ggplot2::facet_grid(rows =  "gradering", 
                      scales = "free",
                      space='free', 
                      switch = "y") +
  ggplot2::guides(alpha = ggplot2::guide_legend(reverse = TRUE)) +
  ggplot2::coord_flip(clip = "off") +
  ggplot2::geom_text(
    mapping = ggplot2::aes(label = Ja, 
                           x = reorder(type_komplikasjon, Sortering), 
                           y = Ja, 
                           group = aar, 
                           color = aar),
    vjust = 0.5,
    hjust = -0.15,
    size = 6, 
    position = ggplot2::position_dodge(width = 1)) +
  ggplot2::scale_color_manual("",
                              values = c("gray40", "gray20"),
                              guide = "none") +
  ggplot2::theme_classic(base_size = 20) +
  ggplot2::theme(
    axis.text.x = ggplot2::element_text(size = 18, colour = "black"),
    axis.line.y = ggplot2::element_blank(),
    axis.ticks.y = ggplot2::element_blank(), 
    strip.placement = "outside") +
  # Fjerne akse-tittel:
  ggplot2::labs(x = NULL, 
                y = NULL)


```


```{r TabLabKomp,results='asis'}
cap <- paste0("Antall alvorlige og øvrige komplikasjoner på kat.lab., ",
              "per måned, i ", 
              "perioden fra ", rangeProsDato,  ".", 
              "")

tab_labkomp <- timeTableMonth %>%
  dplyr::left_join(.,
                   AP %>%
                     dplyr::filter(LabKompAllergiskAlvorlig %in% "Ja") %>%
                     dplyr::count(maaned, .drop = FALSE) %>%
                     dplyr::rename("Allergisk reaksjon alvorlig" = n),
                   by = "maaned") %>%
  dplyr::left_join(.,
                   AP %>%
                     dplyr::filter(LabKompBehkrevendeArytmi %in% "Ja") %>%
                     dplyr::count(maaned, .drop = FALSE) %>%
                     dplyr::rename("Behandlingskrevende arytmi" = n),
                   by = "maaned") %>%
  
  dplyr::left_join(.,
                   AP %>%
                     dplyr::filter(LabKompHemodynamisk %in% "Ja") %>%
                     dplyr::count(maaned, .drop = FALSE) %>%
                     dplyr::rename("Hemodynamisk komplikasjon" = n),
                   by = "maaned") %>%
  
  dplyr::left_join(.,
                   AP %>%
                     dplyr::filter(LabKompNeurologisk %in% "Ja") %>%
                     dplyr::count(maaned, .drop = FALSE) %>%
                     dplyr::rename("Nevrologisk komplikasjon" = n),
                   by = "maaned") %>%
  
  
  dplyr::left_join(.,
                   AP %>%
                     dplyr::filter(LabKompVaskulaerIkkeKoronar %in% "Ja") %>%
                     dplyr::count(maaned, .drop = FALSE) %>%
                     dplyr::rename("Vaskulær (ikke koronare kar)" = n),
                   by = "maaned") %>%
  dplyr::left_join(.,
                   AP %>%
                     dplyr::filter(LabKompPerforasjon %in% "Ja") %>%
                     dplyr::count(maaned, .drop = FALSE) %>%
                     dplyr::rename("Perforasjon" = n),
                   by = "maaned") %>%
  
  dplyr::left_join(.,
                   AP %>%
                     dplyr::filter(LabKompTamponade %in% "Ja") %>%
                     dplyr::count(maaned, .drop = FALSE) %>%
                     dplyr::rename("Tamponade" = n),
                   by = "maaned") %>%
  
  dplyr::left_join(.,
                   AP %>%
                     dplyr::filter(LabKompAkuttACBOperasjon %in% "Ja") %>%
                     dplyr::count(maaned, .drop = FALSE) %>%
                     dplyr::rename("Akutt ACB-operasjon fra lab" = n),
                   by = "maaned") %>%
  
  dplyr::left_join(.,
                   AP %>%
                     dplyr::filter(LabKompDod %in% "Ja") %>%
                     dplyr::count(maaned, .drop = FALSE) %>%
                     dplyr::rename("Død" = n),
                   by = "maaned") %>%
  
  
  dplyr::left_join(.,
                   AP %>%
                     dplyr::filter(LabKompProsedyrerelatertDod %in% "Ja") %>%
                     dplyr::count(maaned, .drop = FALSE) %>%
                     dplyr::rename("- herav prosedyrerelatert død" = n),
                   by = "maaned") %>%
  
  dplyr::left_join(.,
                   AP %>%
                     dplyr::filter(LabKompAnnenAlv %in% "Ja") %>%
                     dplyr::count(maaned, .drop = FALSE) %>%
                     dplyr::rename("Annen alvorlig" = n),
                   by = "maaned") %>%
  dplyr::left_join(.,
                   AP %>%
                     dplyr::filter(LabKompAllergiskLettModerat %in% "Ja") %>%
                     dplyr::count(maaned, .drop = FALSE) %>%
                     dplyr::rename("Allergisk lett/moderat" = n),
                   by = "maaned") %>%
  dplyr::left_join(.,
                   AP %>%
                     dplyr::filter(LabKompMistetStent %in% "Ja") %>%
                     dplyr::count(maaned, .drop = FALSE) %>%
                     dplyr::rename("Mistet stent" = n),
                   by = "maaned") %>%
  
  dplyr::left_join(.,
                   AP %>%
                     dplyr::filter(LabKompVedvarSidegrensokkl %in% "Ja") %>%
                     dplyr::count(maaned, .drop = FALSE) %>%
                     dplyr::rename("Vedvarende sidegr.okkl" = n),
                   by = "maaned")


TabLabkomp_fjor <- merge(
  x = timeTableMonth_fjor,
  y = tab_labkomp, 
  by.x  = "maaned", 
  by.y = "maaned", 
  all.x = TRUE) %>% 
  janitor::adorn_totals("row", name = paste0("Totalt i ",
                                             periode_data$sisteHeleYear)) %>% 
  dplyr::mutate(aar = periode_data$sisteHeleYear) %>% 
  dplyr::relocate("aar", .before = "maaned") 

TabLabkomp_aar <- merge(
  x = timeTableMonth_aar,
  y = tab_labkomp, 
  by.x  = "maaned", 
  by.y = "maaned", 
  all.x = TRUE) %>% 
  janitor::adorn_totals("row", name = paste0("Totalt hittil i ",
                                             periode_data$nyesteRegYear)) %>% 
  dplyr::mutate(aar = periode_data$nyesteRegYear) %>% 
  dplyr::relocate("aar", .before = "maaned")


TabLabkomp <- rbind(
  TabLabkomp_fjor,
  TabLabkomp_aar
)


TabLabkomp[TabLabkomp == 0] <- " - "
TabLabkomp[is.na(TabLabkomp)] <- " - "

align <- c("r", rep("c", dim(TabLabkomp)[2] - 1))
digs <-  rep(0, dim(TabLabkomp)[2] )


if (params$tableFormat == "html") {
  TabLabkomp %>% dplyr::select(-aar) %>% rename(" " = "maaned") %>% 
    knitr::kable(caption = cap, align = align) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped",
                                                    "hover",
                                                    "condensed"),
                              full_width = FALSE, 
                              font_size = 11) %>%
    kableExtra::column_spec(column = 1, width = "7em") %>%
     kableExtra::add_header_above(., header = c("", 
                                               "Alvorlige komplikasjoner på lab" = 11, 
                                               "Øvrige " = 3), 
                                 bold = TRUE, 
                                 font_size = 10) %>% 
    kableExtra::row_spec(row = 0, angle = -45) %>%
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=dim(TabLabkomp)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1, 
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabLabkomp)[1])

} else if (params$tableFormat == "latex") {
  TabLabkomp %>% dplyr::select(-aar) %>% rename(" " = "maaned") %>% 
    knitr::kable(format = params$tableFormat,
               caption = cap,
               booktabs = TRUE,
               align = "r") %>%
    kableExtra::kable_styling(latex_options = "HOLD_position", 
                             font_size = 8) %>% 
    kableExtra::row_spec(row = 0, angle = 90) %>%
    kableExtra::add_header_above(., header = c("", 
                                               "Alvorlige komplikasjoner på lab" = 11, 
                                               "Øvrige " = 3), 
                                 bold = TRUE, 
                                 font_size = 10) %>% 
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE)%>%
    kableExtra::row_spec(row=dim(TabLabkomp)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1,
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabLabkomp)[1])


}

```


`r if(params$tableFormat !="latex") {"<!--"}`
\newpage
`r if(params$tableFormat !="latex") {"-->"}`

### Komplikasjoner på avdeling

Her rapporteres komplikasjoner oppstått på sengepost under sykehusoppholdet 
etter avsluttet prosedyre. Hvis det er registrert flere komplikasjoner på 
samme pasient er disse talt opp hver for seg. For pasienter som har hatt 
en eller flere sekundære prosedyrer under samme sykehusopphold,
registreres eventuelle komplikasjoner 
oppstått på avdelingen for alle prosedyrene samlet. 

Vi viser opptellingene for både ferdigstilte og 
ikke ferdigstilte komplikasjonsskjema.  [***Klikk her***](#komplSkjema) 
for å se oversikten over antall (andel) ferdigstilte komplikasjonsskjemaer.


```{r FigAvdKompl2, fig.cap = paste0("Antall komplikasjoner oppstått på avdelingen.", "Sammenlagt i perioden fra ", rangeProsDato, ". Hvis det er registrert flere komplikasjoner på samme ", "pasient er disse talt opp hver for seg. ") , echo=FALSE, fig.pos="H", fig.width = 10, fig.height = 10, fig.align = "center", out.width = "\\textwidth"}

fig_df_kompl_avd <- AP %>%
  
  dplyr::filter(is.na(KobletForlopsID)) %>% 
  
  dplyr::select(
    AvdKompVaskulaer, 
    AvdKompNeurologiskKomp, 
    AvdKompNyNyreinsuffisiens, 
    AvdKompTamponade, 
    AvdKompPCI, 
    AvdKompACB, 
    AvdKompHjerteinfarkt, 
    AvdKompAnnenAlvorlig, 
    AvdKompDod, 
    AvdKompProsedyrerelatertDod, 
    
    # Alvorlige blødninger
    komplik_avd_alvorligBlodning,
    AvdKompBlodningMajor, 
    AvdKompHbFallStor, 
    AvdKompForlengetOppholdStor, 
    AvdKompBlodtransfusjon, 
    AvdKompKirurgiskBeh, 
    AvdKompPseudoaneurysme,
    
    # Mindre alvorlige blødninger og øvrige komplikasjoner
    komplik_avd_ovrigBlodning, 
    AvdKompBlodningMinor, 
    AvdKompHematomStor, 
    AvdKompForlengetTidStor, 
    AvdKompAllergisk ) %>% 
  tidyr::pivot_longer(cols = AvdKompVaskulaer:AvdKompAllergisk) %>% 
 
   dplyr::mutate(
    type_komplikasjon = case_when(
      
      name %in% "AvdKompVaskulaer" ~ "Vaskulær (ikke koronare kar)", 
      name %in% "AvdKompNeurologiskKomp" ~ "Nevrologisk", 
      name %in% "AvdKompNyNyreinsuffisiens" ~ "Nytilkommet nyreinsuffisens", 
      name %in% "AvdKompTamponade" ~ "Tamponade", 
      name %in% "AvdKompPCI" ~ "Re-PCI (behandlet segment)", 
      name %in% "AvdKompACB" ~ "ACB-operasjon (ikke fra lab)", 
      name %in% "AvdKompHjerteinfarkt" ~ "Hjerteinfarkt", 
      name %in% "AvdKompAnnenAlvorlig" ~ "Annen alvorlig", 
      name %in% "AvdKompDod" ~ "Død", 
      name %in% "AvdKompProsedyrerelatertDod" ~ "- herav prosedyrerelatert død", 
     
      name %in% "komplik_avd_alvorligBlodning" ~ " Noen form for alvorlig blødning", 
      name %in% "AvdKompBlodningMajor" ~ "- herav blødning major", 
      name %in% "AvdKompHbFallStor" ~ "- herav Hb fall stor", 
      name %in% "AvdKompForlengetOppholdStor" ~ "- herav forlenget sykehusopphold", 
      name %in% "AvdKompBlodtransfusjon" ~ "- herav blodtransfusjon", 
      name %in% "AvdKompKirurgiskBeh" ~ "- herav kirurgisk behandling", 
      name %in% "AvdKompPseudoaneurysme" ~ "- herav pseudoaneurysme", 
      
      name %in% "komplik_avd_ovrigBlodning" ~ "Noen form for øvrig blødning",
      name %in% "AvdKompBlodningMinor" ~ "- herav blødning minor",
      name %in% "AvdKompHematomStor" ~ "- herav hematom stort", 
      name %in% "AvdKompForlengetTidStor" ~ "- herav forlenget kompresjonstid", 
      name %in% "AvdKompAllergisk" ~ "Allergisk senreaksjon", 
      TRUE ~ NA_character_ ), 
    
    gradering = case_when(
      name %in% c("AvdKompVaskulaer", 
                  "AvdKompNeurologiskKomp", 
                  "AvdKompNyNyreinsuffisiens", 
                  "AvdKompTamponade", 
                  "AvdKompPCI", 
                  "AvdKompACB", 
                  "AvdKompHjerteinfarkt", 
                  "AvdKompAnnenAlvorlig", 
                  "AvdKompDod", 
                  "AvdKompProsedyrerelatertDod",
                  "komplik_avd_alvorligBlodning") ~
                               "Alvorlige komplikasjoner på avdeling", 
      
      name %in% c("AvdKompBlodningMajor", 
                  "AvdKompHbFallStor", 
                  "AvdKompForlengetOppholdStor", 
                  "AvdKompBlodtransfusjon",
                  "AvdKompKirurgiskBeh", 
                  "AvdKompPseudoaneurysme") ~ "Undergruppe alv blødning",
      
      name %in% c("AvdKompBlodningMinor",
                  "AvdKompHematomStor", 
                  "AvdKompForlengetTidStor") ~ "Undergruppe av ovrig blodning", 
      TRUE ~ "Øvrige") ) %>% 
  dplyr::count(name, type_komplikasjon, value, gradering) %>%
  tidyr::pivot_wider(names_from = value, values_from = n, values_fill=0) %>% 
  select(name, type_komplikasjon, gradering, Ja)


# Rekkefølge: 
# Først alvorlig, så øvrige. 
# Annen alvorlig nederst av alvorlige. 
# pros_red_dod etter død
# Alle alvorlige blødnigner under "noen form for.."



synkende_rekkefolge_avd_alvorlig <- rbind(
  
  # Alvorlig (uten annen alvorlig,  pros.rel.dod og undergruppe alvorlig blødning.)
  fig_df_kompl_avd %>% 
    dplyr::filter(name != "AvdKompAnnenAlvorlig", 
                   name != "AvdKompProsedyrerelatertDod", 
                   gradering %in% "Alvorlige komplikasjoner på avdeling") %>% 
    dplyr::arrange(-Ja), 
  
  # Annen alvorlig nederst av alvorlige
  fig_df_kompl_avd %>% 
    dplyr::filter(name == "AvdKompAnnenAlvorlig")
  ) 

# sett inn prosedyrerelatert død på riktig sted
insert_prsRel_her <- which(synkende_rekkefolge_avd_alvorlig$name == "AvdKompDod")

synkende_rekkefolge_avd_alvorlig %<>%
  dplyr::add_row( fig_df_kompl_avd %>% 
    filter(name == "AvdKompProsedyrerelatertDod"),
    .after = insert_prsRel_her) 

# sett inn undergrupper blødning på riktig sted
insert_blod_her<- which(synkende_rekkefolge_avd_alvorlig$name == "komplik_avd_alvorligBlodning")

endelig_alvorlig <- rbind(
  
  # Før blødning
  synkende_rekkefolge_avd_alvorlig[1:insert_blod_her, ], 
  
  # Undergrupper blødingn
  fig_df_kompl_avd %>% 
    filter(gradering %in% "Undergruppe alv blødning") %>% 
      dplyr::arrange(-Ja), 
  
   # Før blødning
  synkende_rekkefolge_avd_alvorlig[-(1:insert_blod_her), ]
  )




  # Deretter øvrige
synkende_rekkefolge_avd_ovrige <-   fig_df_kompl_avd %>% 
    dplyr::filter(gradering %in% "Øvrige") %>% 
    dplyr::arrange(-Ja)

# sett inn undergrupper blødning på riktig sted
insert_blod_her<- which(synkende_rekkefolge_avd_ovrige$name == "komplik_avd_ovrigBlodning")

endelig_ovrig <- rbind(
  
  # Før blødning
  synkende_rekkefolge_avd_ovrige[1:insert_blod_her, ], 
  
  # Undergrupper blødingn
  fig_df_kompl_avd %>% 
    filter(gradering %in% "Undergruppe av ovrig blodning") %>% 
      dplyr::arrange(-Ja), 
  
   # Før blødning
  synkende_rekkefolge_avd_ovrige[-(1:insert_blod_her), ]
  )
 

#SAMMEN: 
endelig_alle <- rbind(
  endelig_alvorlig, 
  endelig_ovrig
) %>% 
  # PARAMETRE FOR PLOT
   dplyr::mutate(
    Sortering = n():1, 

    alpha_soyler= ifelse(
      gradering %in% "Undergruppe alv blødning" |
        gradering %in% "Undergruppe av ovrig blodning" |
        name %in% "AvdKompProsedyrerelatertDod", 
      TRUE, 
      FALSE), 
    
    gradering2 = ifelse(
      gradering %in% c("Undergruppe alv blødning", 
                       "Alvorlige komplikasjoner på avdeling"), 
      "Alvorlige komplikasjoner på avdeling", 
      "Øvrige"
      
    ))  
  




endelig_alle %>%
  ggplot2::ggplot(data = . , 
                  ggplot2::aes(x = reorder(type_komplikasjon, Sortering) ,
                               y = Ja)) +
  ggplot2::geom_bar(
    mapping = ggplot2::aes(alpha = alpha_soyler),
    stat="identity",
    width = 0.85,
    fill = colPrimary[4]) +
    ggplot2::scale_alpha_manual(breaks = c(TRUE, FALSE), 
                              values = c(0.5, 1)) +

  ggplot2::facet_grid(rows =  "gradering2", 
                     scales = "free",
                     space='free', 
                     switch = "y") +
  ggplot2::coord_flip(clip = "off") +
  # FREKVENS-TALL SOM PLASSERES I/PÅ SØYLENE:
  ggplot2::geom_text(
    ggplot2::aes(label = Ja, 
                 alpha = alpha_soyler),
    vjust = 0.5,
    hjust = -0.15,
    size = 6  ) +
  # THEME & BASE SIZE:
  ggplot2::theme_classic( base_size = 20) +
  # THEME -
  ggplot2::theme(
    legend.position = "none", # fjerne hele legend
    axis.text.x = ggplot2::element_text( size = 18, colour = "black"),
    # axis.text.y = ggplot2::element_text(color = farger_tekst),
    axis.line.y = ggplot2::element_blank(),
    axis.ticks.y = ggplot2::element_blank(), 
    strip.placement = "outside"
  ) +
  # Fjerne akse-tittel:
  ggplot2::labs(
    x = NULL,
    y = NULL)

```







```{r TabAvdKomp,results='asis'}
cap <- paste0("Antall alvorlige og øvrige komplikasjoner på sengepost, ",
              "per måned, i ", 
              "perioden fra ", rangeProsDato,  ".", 
              "")

tab_avdkomp <- timeTableMonth %>%
  dplyr::left_join(.,
                   AP %>%
                     dplyr::filter(
                       is.na(KobletForlopsID),
                       AvdKompDod %in% "Ja") %>%
                     dplyr::count(maaned, .drop = FALSE) %>%
                     dplyr::rename("Død på avdeling" = n),
                   by = "maaned") %>%
  dplyr::left_join(.,
                   AP %>%
                     dplyr::filter(
                       is.na(KobletForlopsID),
                       AvdKompProsedyrerelatertDod %in% "Ja") %>%
                     dplyr::count(maaned, .drop = FALSE) %>%
                     dplyr::rename("- herav prosedyrerelatert død" = n),
                   by = "maaned") %>%

    dplyr::left_join(.,
                   AP %>%
                     dplyr::filter(
                       is.na(KobletForlopsID),
                       AvdKompNyNyreinsuffisiens %in% "Ja") %>%
                     dplyr::count(maaned, .drop = FALSE) %>%
                     dplyr::rename("Nytilkommet nyreinsuffisens" = n),
                   by = "maaned") %>%

      dplyr::left_join(.,
                   AP %>%
                     dplyr::filter(
                       is.na(KobletForlopsID),
                       AvdKompNeurologiskKomp %in% "Ja") %>%
                     dplyr::count(maaned, .drop = FALSE) %>%
                     dplyr::rename("Nevrologisk" = n),
                   by = "maaned") %>%
     dplyr::left_join(.,
                   AP %>%
                     dplyr::filter(
                       is.na(KobletForlopsID),
                       AvdKompHjerteinfarkt %in% "Ja") %>%
                     dplyr::count(maaned, .drop = FALSE) %>%
                     dplyr::rename("Hjerteinfarkt" = n),
                   by = "maaned") %>%
     dplyr::left_join(.,
                   AP %>%
                     dplyr::filter(
                       is.na(KobletForlopsID),
                       AvdKompTamponade %in% "Ja") %>%
                     dplyr::count(maaned, .drop = FALSE) %>%
                     dplyr::rename("Tamponade" = n),
                   by = "maaned") %>%
     dplyr::left_join(.,
                   AP %>%
                     dplyr::filter(
                       is.na(KobletForlopsID),
                       AvdKompVaskulaer %in% "Ja") %>%
                     dplyr::count(maaned, .drop = FALSE) %>%
                     dplyr::rename("Vaskulær (ikke koronare kar)" = n),
                   by = "maaned") %>%
     dplyr::left_join(.,
                   AP %>%
                     dplyr::filter(
                       is.na(KobletForlopsID),
                       AvdKompPCI %in% "Ja") %>%
                     dplyr::count(maaned, .drop = FALSE) %>%
                     dplyr::rename("Re-PCI (behandlet segment)" = n),
                   by = "maaned") %>%

       dplyr::left_join(.,
                   AP %>%
                     dplyr::filter(
                       is.na(KobletForlopsID),
                       AvdKompACB %in% "Ja") %>%
                     dplyr::count(maaned, .drop = FALSE) %>%
                     dplyr::rename("ACB-operasjon (ikke fra lab)" = n),
                   by = "maaned") %>%

  dplyr::left_join(.,
                   AP %>%
                     dplyr::filter(
                          is.na(KobletForlopsID),
                          komplik_avd_alvorligBlodning %in% "Ja") %>%
                        dplyr::count(maaned, .drop = FALSE) %>%
                     dplyr::rename("Noen form for alvorlig blødning" = n),
                   by = "maaned") %>%
       dplyr::left_join(.,
                   AP %>%
                     dplyr::filter(
                       is.na(KobletForlopsID),
                       AvdKompAnnenAlvorlig %in% "Ja") %>%
                     dplyr::count(maaned, .drop = FALSE) %>%
                     dplyr::rename("Annen alvorlig" = n),
                   by = "maaned") %>%

        dplyr::left_join(.,
                   AP %>%
                     dplyr::filter(
                       is.na(KobletForlopsID),
                       komplik_avd_ovrigBlodning %in% "Ja") %>%
                     dplyr::count(maaned, .drop = FALSE) %>%
                     dplyr::rename("Noen form for øvrig blødning" = n),
                   by = "maaned") %>%
      dplyr::left_join(.,
                   AP %>%
                     dplyr::filter(
                       is.na(KobletForlopsID),
                       AvdKompAllergisk %in% "Ja") %>%
                     dplyr::count(maaned, .drop = FALSE) %>%
                     dplyr::rename("Allergisk senreaksjon" = n),
                   by = "maaned")


TabAvdkomp_fjor <- merge(
  x = timeTableMonth_fjor,
  y = tab_avdkomp, 
  by.x  = "maaned", 
  by.y = "maaned", 
  all.x = TRUE) %>% 
  janitor::adorn_totals("row", name = paste0("Totalt i ",
                                             periode_data$sisteHeleYear)) %>% 
  dplyr::mutate(aar = periode_data$sisteHeleYear) %>% 
  dplyr::relocate("aar", .before = "maaned") 

TabAvdkomp_aar <- merge(
  x = timeTableMonth_aar,
  y = tab_avdkomp, 
  by.x  = "maaned", 
  by.y = "maaned", 
  all.x = TRUE) %>% 
  janitor::adorn_totals("row", name = paste0("Totalt hittil i ",
                                             periode_data$nyesteRegYear)) %>% 
  dplyr::mutate(aar = periode_data$nyesteRegYear) %>% 
  dplyr::relocate("aar", .before = "maaned")


TabAvdkomp <- rbind(
  TabAvdkomp_fjor,
  TabAvdkomp_aar
)


TabAvdkomp[TabAvdkomp == 0] <- " - "
TabAvdkomp[is.na(TabAvdkomp)] <- " - "

align <- c("r", rep("c", dim(TabAvdkomp)[2] - 1))
digs <-  rep(0, dim(TabAvdkomp)[2] )


if (params$tableFormat == "html") {
  TabAvdkomp %>% dplyr::select(-aar) %>% rename(" " = "maaned") %>% 
    knitr::kable(caption = cap, align = align) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped",
                                                    "hover",
                                                    "condensed"),
                              full_width = FALSE, 
                              font_size = 11) %>%
    kableExtra::column_spec(column = 1, width = "7em") %>% 
    kableExtra::row_spec(row = 0, angle = -45) %>%
    kableExtra::add_header_above(., header = c("",
                                               "Alvorlige komplikasjoner på avdeling" = 11,
                                               "Øvrige " = 2),
                                 bold = TRUE,
                                 font_size = 10) %>%
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=dim(TabAvdkomp)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1, 
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabAvdkomp)[1])

} else if (params$tableFormat == "latex") {
  TabAvdkomp %>% dplyr::select(-aar) %>% rename(" " = "maaned") %>% 
    knitr::kable(format = params$tableFormat,
               caption = cap,
               booktabs = TRUE,
               align = "r") %>%
    kableExtra::kable_styling(latex_options = "HOLD_position", 
                             font_size = 8) %>% 
    kableExtra::row_spec(row = 0, angle = 90) %>% 
    kableExtra::add_header_above(., header = c("",
                                               "Alvorlige komplikasjoner på avdeling" = 11,
                                               "Øvrige " = 2),
                                 bold = TRUE,
                                 font_size = 10) %>%
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE)%>%
    kableExtra::row_spec(row=dim(TabAvdkomp)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1,
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabAvdkomp)[1])


}

```






```{r TabAvdKompBlod,results='asis'}
cap <- paste0("Antall alvorlige og øvrige blødninger på sengepost, ",
              "per måned, i ", 
              "perioden fra ", rangeProsDato,  ".", 
              "")


tab_avdkomp_blod <- timeTableMonth %>%
  dplyr::left_join(.,
                   AP %>%
                     dplyr::filter(
                       is.na(KobletForlopsID),
                       komplik_avd_alvorligBlodning %in% "Ja") %>%
                     dplyr::count(maaned, .drop = FALSE) %>%
                     dplyr::rename("Noen form for alvorlig blødning" = n),
                   by = "maaned") %>%
  dplyr::left_join(.,
                   AP %>%
                     dplyr::filter(
                       is.na(KobletForlopsID),
                       AvdKompHbFallStor %in% "Ja") %>%
                     dplyr::count(maaned, .drop = FALSE) %>%
                     dplyr::rename("- herav Hb fall stor" = n),
                   by = "maaned") %>%
  
  dplyr::left_join(.,
                   AP %>%
                     dplyr::filter(
                       is.na(KobletForlopsID),
                       AvdKompForlengetOppholdStor %in% "Ja") %>%
                     dplyr::count(maaned, .drop = FALSE) %>%
                     dplyr::rename("- herav forlenget sykehusopphold" = n),
                   by = "maaned") %>%
  
  dplyr::left_join(.,
                   AP %>%
                     dplyr::filter(
                       is.na(KobletForlopsID),
                       AvdKompBlodtransfusjon %in% "Ja") %>%
                     dplyr::count(maaned, .drop = FALSE) %>%
                     dplyr::rename("- herav blodtransfusjon" = n),
                   by = "maaned") %>%
  
  dplyr::left_join(.,
                   AP %>%
                     dplyr::filter(
                       is.na(KobletForlopsID),
                       AvdKompKirurgiskBeh %in% "Ja") %>%
                     dplyr::count(maaned, .drop = FALSE) %>%
                     dplyr::rename("- herav kirurgisk behandling" = n),
                   by = "maaned") %>%
  
  dplyr::left_join(.,
                   AP %>%
                     dplyr::filter(
                       is.na(KobletForlopsID),
                       AvdKompPseudoaneurysme %in% "Ja") %>%
                     dplyr::count(maaned, .drop = FALSE) %>%
                     dplyr::rename("- herav pseudoaneurysme" = n),
                   by = "maaned") %>%
  
  dplyr::left_join(.,
                   AP %>%
                     dplyr::filter(
                       is.na(KobletForlopsID),
                       komplik_avd_ovrigBlodning %in% "Ja") %>%
                     dplyr::count(maaned, .drop = FALSE) %>%
                     dplyr::rename("Noen form for øvrig blødning" = n),
                   by = "maaned") %>%
  
  dplyr::left_join(.,
                   AP %>%
                     dplyr::filter(
                       is.na(KobletForlopsID),
                       AvdKompBlodningMinor %in% "Ja") %>%
                     dplyr::count(maaned, .drop = FALSE) %>%
                     dplyr::rename("- herav blødning minor" = n),
                   by = "maaned") %>%
  dplyr::left_join(.,
                   AP %>%
                     dplyr::filter(
                       is.na(KobletForlopsID),
                       AvdKompHematomStor %in% "Ja") %>%
                     dplyr::count(maaned, .drop = FALSE) %>%
                     dplyr::rename("- herav hematom stort" = n),
                   by = "maaned") %>%
  dplyr::left_join(.,
                   AP %>%
                     dplyr::filter(
                       is.na(KobletForlopsID),
                       AvdKompForlengetTidStor %in% "Ja") %>%
                     dplyr::count(maaned, .drop = FALSE) %>%
                     dplyr::rename("- herav forlenget kompresjonstid" = n),
                   by = "maaned")


TabAvdkompBlod_fjor <- merge(
  x = timeTableMonth_fjor,
  y = tab_avdkomp_blod, 
  by.x  = "maaned", 
  by.y = "maaned", 
  all.x = TRUE) %>% 
  janitor::adorn_totals("row", name = paste0("Totalt i ",
                                             periode_data$sisteHeleYear)) %>% 
  dplyr::mutate(aar = periode_data$sisteHeleYear) %>% 
  dplyr::relocate("aar", .before = "maaned") 

TabAvdkompBlod_aar <- merge(
  x = timeTableMonth_aar,
  y = tab_avdkomp_blod, 
  by.x  = "maaned", 
  by.y = "maaned", 
  all.x = TRUE) %>% 
  janitor::adorn_totals("row", name = paste0("Totalt hittil i ",
                                             periode_data$nyesteRegYear)) %>% 
  dplyr::mutate(aar = periode_data$nyesteRegYear) %>% 
  dplyr::relocate("aar", .before = "maaned")


TabAvdkompBlod <- rbind(
  TabAvdkompBlod_fjor,
  TabAvdkompBlod_aar
)


TabAvdkompBlod[TabAvdkompBlod == 0] <- " - "
TabAvdkompBlod[is.na(TabAvdkompBlod)] <- " - "

align <- c("r", rep("c", dim(TabAvdkompBlod)[2] - 1))
digs <-  rep(0, dim(TabAvdkompBlod)[2] )


if (params$tableFormat == "html") {
  TabAvdkompBlod %>% dplyr::select(-aar) %>% rename(" " = "maaned") %>% 
    knitr::kable(caption = cap, align = align) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped",
                                                    "hover",
                                                    "condensed"),
                              full_width = FALSE, 
                              font_size = 11) %>%
    kableExtra::column_spec(column = 1, width = "7em") %>% 
    kableExtra::row_spec(row = 0, angle = -45) %>%
    kableExtra::add_header_above(., header = c("",
                                               "Alvorlige blødninger" = 6,
                                               "Øvrige blødninger " = 4),
                                 bold = TRUE,
                                 font_size = 10) %>%
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=dim(TabAvdkompBlod)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1, 
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabAvdkompBlod)[1])

} else if (params$tableFormat == "latex") {
  TabAvdkompBlod %>% dplyr::select(-aar) %>% rename(" " = "maaned") %>% 
    knitr::kable(format = params$tableFormat,
               caption = cap,
               booktabs = TRUE,
               align = "r") %>%
    kableExtra::kable_styling(latex_options = "HOLD_position", 
                              font_size = 8) %>% 
    kableExtra::row_spec(row = 0, angle = 90) %>% 
    kableExtra::add_header_above(., header = c("",
                                               "Alvorlige blødninger" = 6,
                                               "Øvrige blødninger " = 4),
                                 bold = TRUE,
                                 font_size = 10) %>%
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE)%>%
    kableExtra::row_spec(row=dim(TabAvdkompBlod)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1,
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabAvdkompBlod)[1])

}

```



 
```{r}
if (params$rendered_by_shiny == TRUE && params$tableFormat == "latex")
    shiny::setProgress(0.6)  # set progress to 60%
```

`r if(params$tableFormat !="latex") {"<!--"}`
\newpage
`r if(params$tableFormat !="latex") {"-->"}`

## Kompletthet

### Kompletthet angio/PCI-skjemaer {-}

`r if(params$tableFormat !="latex") {"<!--"}`
\vspace{-4truemm}
`r if(params$tableFormat !="latex") {"-->"}`

```{r SOtab1, results = "asis"}

tabHovedKomplett <- AP %>% 
  dplyr::count(maaned, SkjemastatusHovedskjema, .drop = FALSE) %>% 
  tidyr::pivot_wider(names_from = SkjemastatusHovedskjema, 
                     values_from = n, 
                     values_fill = 0) %>% 
  dplyr::transmute(
    maaned = maaned,
    Totalt = `-1`+ `0` + `1`, 
    Ferdigstilt = `1`, 
    Andel = (round(Ferdigstilt/Totalt, 2) *100))

TabHovedKomplett_fjor <- merge(
  x = timeTableMonth_fjor,
  y = tabHovedKomplett,
  by.x  = "maaned", 
  by.y = "maaned", 
  all.x = TRUE) %>% 
  janitor::adorn_totals("row", name = paste0("Totalt i ",
                                             periode_data$sisteHeleYear)) %>% 
  dplyr::mutate(aar = periode_data$sisteHeleYear) %>% 
  dplyr::relocate("aar", .before = "maaned") 

TabHovedKomplett_aar <- merge(
  x = timeTableMonth_aar,
  y = tabHovedKomplett,
  by.x  = "maaned", 
  by.y = "maaned", 
  all.x = TRUE) %>% 
  janitor::adorn_totals("row", name = paste0("Totalt hittil i ",
                                             periode_data$nyesteRegYear)) %>% 
  dplyr::mutate(aar = periode_data$nyesteRegYear) %>% 
  dplyr::relocate("aar", .before = "maaned") 


TabHovedKomplett <- rbind(
  TabHovedKomplett_fjor, 
  TabHovedKomplett_aar
)


TabHovedKomplett[TabHovedKomplett == 0] <- " - "
TabHovedKomplett[is.na(TabHovedKomplett)] <- " - "

align <- c("l", rep("r", dim(TabHovedKomplett)[2] - 1))
digs <-  rep(0, dim(TabHovedKomplett)[2] )


if (params$tableFormat == "html") {
  TabHovedKomplett %>% dplyr::select(-aar) %>% rename(" " = "maaned") %>% 
    knitr::kable(caption = cap, align = align) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped",
                                                    "hover",
                                                    "condensed"),
                              full_width = FALSE, 
                              font_size = 11) %>%
    kableExtra::column_spec(column = 1, width = "7em") %>% 
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=dim(TabHovedKomplett)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1, 
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabHovedKomplett)[1])

} else if (params$tableFormat == "latex") {
  TabHovedKomplett %>% dplyr::select(-aar) %>% rename(" " = "maaned") %>% 
    knitr::kable(format = params$tableFormat,
               caption = cap,
               booktabs = TRUE,
               align = "r") %>%
    kableExtra::kable_styling(latex_options = "HOLD_position", 
                             font_size = 8) %>% 
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE)%>%
    kableExtra::row_spec(row=dim(TabHovedKomplett)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1,
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabHovedKomplett)[1])


}

```

### Kompletthet komplikasjonsskjemaer {- #komplSkjema}

`r if(params$tableFormat !="latex") {"<!--"}`
\vspace{-4truemm}
`r if(params$tableFormat !="latex") {"-->"}`

```{r SOtab2, results = "asis"}

tabKomplikKomplett <- AP %>% 
  dplyr::filter(Regtype %in% "Primær") %>%

  dplyr::count(maaned, SkjemaStatusKomplikasjoner, .drop = FALSE) %>%
  tidyr::pivot_wider(names_from = SkjemaStatusKomplikasjoner,
                     values_from = n,
                     values_fill = 0) %>%
  dplyr::transmute(
    maaned = maaned,
    Totalt = `-1`+ `0` + `1`,
    Ferdigstilt = `1`,
    Andel = (round(Ferdigstilt/Totalt, 2) *100))

TabKomplikKomplett_fjor <- merge(
  x = timeTableMonth_fjor,
  y = tabKomplikKomplett,
  by.x  = "maaned", 
  by.y = "maaned", 
  all.x = TRUE) %>% 
  janitor::adorn_totals("row", name = paste0("Totalt i ",
                                             periode_data$sisteHeleYear)) %>% 
  dplyr::mutate(aar = periode_data$sisteHeleYear) %>% 
  dplyr::relocate("aar", .before = "maaned") 

TabKomplikKomplett_aar <- merge(
  x = timeTableMonth_aar,
  y = tabKomplikKomplett,
  by.x  = "maaned", 
  by.y = "maaned", 
  all.x = TRUE) %>% 
  janitor::adorn_totals("row", name = paste0("Totalt hittil i ",
                                             periode_data$nyesteRegYear)) %>% 
  dplyr::mutate(aar = periode_data$nyesteRegYear) %>% 
  dplyr::relocate("aar", .before = "maaned") 


TabKomplikKomplett <- rbind(
  TabKomplikKomplett_fjor, 
  TabKomplikKomplett_aar
)


TabKomplikKomplett[TabKomplikKomplett == 0] <- " - "
TabKomplikKomplett[is.na(TabKomplikKomplett)] <- " - "

align <- c("l", rep("r", dim(TabKomplikKomplett)[2] - 1))
digs <-  rep(0, dim(TabKomplikKomplett)[2] )


if (params$tableFormat == "html") {
  TabKomplikKomplett %>% dplyr::select(-aar) %>% rename(" " = "maaned") %>% 
    knitr::kable(caption = cap, align = align) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped",
                                                    "hover",
                                                    "condensed"),
                              full_width = FALSE, 
                              font_size = 11) %>%
    kableExtra::column_spec(column = 1, width = "7em") %>% 
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=dim(TabKomplikKomplett)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1, 
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabKomplikKomplett)[1])

} else if (params$tableFormat == "latex") {
  TabKomplikKomplett %>% dplyr::select(-aar) %>% rename(" " = "maaned") %>% 
    knitr::kable(format = params$tableFormat,
               caption = cap,
               booktabs = TRUE,
               align = "r") %>%
    kableExtra::kable_styling(latex_options = "HOLD_position", 
                             font_size = 8) %>% 
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE)%>%
    kableExtra::row_spec(row=dim(TabKomplikKomplett)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1,
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabKomplikKomplett)[1])
}


```

### Kompletthet utskrivelsesskjemaer {-}

`r if(params$tableFormat !="latex") {"<!--"}`
\vspace{-4truemm}
`r if(params$tableFormat !="latex") {"-->"}`

```{r SOtab3, results = "asis"}

cap <- paste0("Andel ferdigstilte utskrivelsesskjemaer registrert i NORIC per ", 
              "måned ved ", params$hospitalName, " i perioden ",
              rangeProsDato, ".")

tab_UtskrKomplett <- AP %>% 
  dplyr::filter(Regtype %in% "Primær") %>% 
  
  dplyr::count(maaned, SkjemaStatusUtskrivelse, .drop = FALSE) %>% 
  tidyr::pivot_wider(names_from = SkjemaStatusUtskrivelse, 
                     values_from = n, 
                     values_fill = 0) %>% 
  dplyr::transmute(
    maaned = maaned,
    Totalt = `-1`+ `0` + `1`, 
    Ferdigstilt = `1`, 
    Andel = (round(Ferdigstilt/Totalt, 2) *100))

TabUtskrKomplett_fjor <- merge(
  x = timeTableMonth_fjor,
  y = tab_UtskrKomplett,
  by.x  = "maaned", 
  by.y = "maaned", 
  all.x = TRUE) %>% 
  janitor::adorn_totals("row", name = paste0("Totalt i ",
                                             periode_data$sisteHeleYear)) %>% 
  dplyr::mutate(aar = periode_data$sisteHeleYear) %>% 
  dplyr::relocate("aar", .before = "maaned") 

TabUtskrKomplett_aar <- merge(
  x = timeTableMonth_aar,
  y = tab_UtskrKomplett,
  by.x  = "maaned", 
  by.y = "maaned", 
  all.x = TRUE) %>% 
  janitor::adorn_totals("row", name = paste0("Totalt hittil i ",
                                             periode_data$nyesteRegYear)) %>% 
  dplyr::mutate(aar = periode_data$nyesteRegYear) %>% 
  dplyr::relocate("aar", .before = "maaned") 


TabUtskrKomplett<- rbind(
  TabUtskrKomplett_fjor, 
  TabUtskrKomplett_aar
)


TabUtskrKomplett[TabUtskrKomplett == 0] <- " - "
TabUtskrKomplett[is.na(TabUtskrKomplett)] <- " - "

align <- c("l", rep("r", dim(TabUtskrKomplett)[2] - 1))
digs <-  rep(0, dim(TabUtskrKomplett)[2] )


if (params$tableFormat == "html") {
  TabUtskrKomplett %>% dplyr::select(-aar) %>% rename(" " = "maaned") %>% 
    knitr::kable(caption = cap, align = align) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped",
                                                    "hover",
                                                    "condensed"),
                              full_width = FALSE, 
                              font_size = 11) %>%
    kableExtra::column_spec(column = 1, width = "7em") %>% 
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=dim(TabUtskrKomplett)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1, 
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabUtskrKomplett)[1])

} else if (params$tableFormat == "latex") {
  TabUtskrKomplett %>% dplyr::select(-aar) %>% rename(" " = "maaned") %>% 
    knitr::kable(format = params$tableFormat,
               caption = cap,
               booktabs = TRUE,
               align = "r") %>%
    kableExtra::kable_styling(latex_options = "HOLD_position", 
                             font_size = 8) %>% 
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE)%>%
    kableExtra::row_spec(row=dim(TabUtskrKomplett)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1,
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabUtskrKomplett)[1])
}

```

`r if(params$tableFormat !="latex") {"<!--"}`
\newpage
`r if(params$tableFormat !="latex") {"-->"}`


```{r}
if (params$rendered_by_shiny == TRUE && params$tableFormat == "latex")
    shiny::setProgress(0.7)  # set progress to 70%
```

<br/><br/>

# Stentbruk og intervensjoner

Opptellingene under gjelder for prosedyretypene Angio/PCI og PCI. 




## Intervensjonstype
```{r TabNRIntervensjonstype, echo = FALSE, results = "asis"}
cap <- paste0("Antall utførte intervensjoner registrert i NORIC per ",
              "måned ved ", params$hospitalName, " i perioden ",
              rangeProsDato, ". ",
              "Merk at flere intervensjoner kan være utført i samme prosedyre.")

TabDataSsIntervensjonstype <- SS %>% 
  janitor::tabyl(maaned,
                 ProsedyreType2) %>% 
  janitor::adorn_totals("col", name = "Totalt antall intervensjoner") 

TabNInervProsedyreType <- AP %>%
  dplyr::filter(ProsedyreType %in% c("Angio + PCI", "PCI")) %>% 
  janitor::tabyl(maaned,
                 ProsedyreType) %>% 
  janitor::adorn_totals("col", name = "Antall prosedyrer") %>% 
  dplyr::select(maaned, "Antall prosedyrer")

tab_NSsIntervensjonstype <- timeTableMonth %>% 
  merge(., TabDataSsIntervensjonstype, 
        by.x = c("maaned"), by.y = c("maaned"),
        all.x = TRUE, all.y = FALSE) %>% 
  dplyr::right_join(., TabNInervProsedyreType, by = c("maaned"))


TabIntervensjonstype_fjor <- merge(
  x = timeTableMonth_fjor,
  y = tab_NSsIntervensjonstype,
  by.x  = "maaned", 
  by.y = "maaned", 
  all.x = TRUE) %>% 
  janitor::adorn_totals("row", name = paste0("Totalt i ",
                                             periode_data$sisteHeleYear)) %>% 
  dplyr::mutate(aar = periode_data$sisteHeleYear) %>% 
  dplyr::relocate("aar", .before = "maaned")


TabIntervensjonstype_aar <- merge(
  x = timeTableMonth_aar,
  y = tab_NSsIntervensjonstype,
  by.x  = "maaned", 
  by.y = "maaned", 
  all.x = TRUE) %>% 
  janitor::adorn_totals("row", name = paste0("Totalt hittil i ",
                                             periode_data$nyesteRegYear)) %>% 
  dplyr::mutate(aar = periode_data$nyesteRegYear) %>% 
  dplyr::relocate("aar", .before = "maaned") 


TabIntervensjonstype <- rbind(
  TabIntervensjonstype_fjor, 
  TabIntervensjonstype_aar
)


TabIntervensjonstype[TabIntervensjonstype == 0] <- " - "
TabIntervensjonstype[is.na(TabIntervensjonstype)] <- " - "

align <- c("l", rep("r", dim(TabIntervensjonstype)[2] - 1))
digs <-  rep(0, dim(TabIntervensjonstype)[2] )


if (params$tableFormat == "html") {
  TabIntervensjonstype %>% dplyr::select(-aar) %>% rename(" " = "maaned") %>% 
    knitr::kable(caption = cap, align = align) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped",
                                                    "hover",
                                                    "condensed"),
                              full_width = FALSE, 
                              font_size = 11) %>%
    kableExtra::column_spec(column = 1, width = "7em") %>% 
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=dim(TabIntervensjonstype)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1, 
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabIntervensjonstype)[1])

} else if (params$tableFormat == "latex") {
  TabIntervensjonstype %>% dplyr::select(-aar) %>% rename(" " = "maaned") %>% 
    knitr::kable(format = params$tableFormat,
               caption = cap,
               booktabs = TRUE,
               align = "r") %>%
    kableExtra::kable_styling(latex_options = c("HOLD_position",
                                                "scale_down"), 
                             font_size = 8) %>% 
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE)%>%
    kableExtra::row_spec(row=dim(TabIntervensjonstype)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1,
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabIntervensjonstype)[1])
}

```
<br/>

[***Her***](#prosedyretype) er en oversikt over antall prosedyrer per måned.

<br/><br/>

## Stenter per prosedyre
Antall stenter per prosedyre ved `r params$hospitalName` registrert i NORIC i perioden `r rangeProsDato`.
Antall prosedyrer med minst 1 stent er 
`r AP %>% dplyr::filter(Nstents>0, aar %in% periode_data$sisteHeleYear) %>% nrow()` i 
`r periode_data$sisteHeleYear ` og 
`r AP %>% dplyr::filter(Nstents>0, aar %in% periode_data$nyesteRegYear) %>% nrow()` i 
`r periode_data$nyesteRegYear `. 

```{r FigNstentPerProsedyre, fig.width = 7, fig.height = 4.5, fig.align = "center", fig.pos = "H", out.width = "\\textwidth", fig.cap = paste0("Antall stenter per prosedyre for ", params$hospitalName, " i perioden ", rangeProsDato, ".")}

TabNStent <- AP %>% 
  dplyr::filter(Nstents > 0) %>% 
  dplyr::count(.data$Nstents,
               .data$aar) %>% 
  dplyr::group_by(.data$aar) %>% 
  mutate(
    totalt_aar = sum(n),
    nstents_andel = round(n/totalt_aar, 3))


TabNStent %>%  ggplot2::ggplot(
  ggplot2::aes(x = .data$Nstents,
               y = .data$nstents_andel,
               fill = factor(.data$aar))) +
  ggplot2::geom_bar(position = "stack",
                    stat = "identity") +
  ggplot2::geom_text(ggplot2::aes(label = TabNStent$n),
                     vjust = -0.5,
                     colour = "gray20") +
  ggplot2::scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  ggplot2::facet_grid(~ .data$aar, scales = "free_x", space = "free_x") +
  ggplot2::scale_fill_manual(values = c(colPrimary[4], colPrimary[3])) +
  ggplot2::theme_minimal() +
  ggplot2::xlab("Antall stenter per prosedyre") +
  ggplot2::ylab("Andel (antall) prosedyrer") +
  ggplot2::scale_x_continuous(breaks = TabNStent$Nstents) +
  ggplot2::theme(legend.position = "none",
                 strip.text = ggplot2::element_text(size=12),
                 axis.text = ggplot2::element_text(size = 12),
                 axis.title = ggplot2::element_text(size = 12),
                 legend.text = ggplot2::element_text(size = 12))

``` 


```{r}
if (params$rendered_by_shiny == TRUE && params$tableFormat == "latex")
    shiny::setProgress(0.8)  # set progress to 80%
```

<br/>

`r if(params$tableFormat !="latex") {"<!--"}`
\newpage
`r if(params$tableFormat !="latex") {"-->"}`


## Stent - merke



```{r TabNstentNameMonth, echo = FALSE, results = "asis", out.width = "\\textwidth"}
cap <- paste0("Antall stenter registrert i NORIC per måned og merke ved ",
              params$hospitalName, " i perioden ", rangeProsDato, ".")


TabStent_fjor <- merge(
  x = timeTableMonth_fjor,
  y = SS %>%
  dplyr::filter(ProsedyreType2 == "Stent") %>%
  janitor::tabyl(maaned,
                 Stentnavn) %>%
  janitor::adorn_totals("col", name = "Totalt"),
  by.x  = "maaned", 
  by.y = "maaned", 
  all.x = TRUE) %>% 
  janitor::adorn_totals("row", name = paste0("Totalt i ",
                                             periode_data$sisteHeleYear)) %>% 
  dplyr::mutate(aar = periode_data$sisteHeleYear) %>% 
  dplyr::relocate("aar", .before = "maaned")


TabStent_aar <- merge(
  x = timeTableMonth_aar,
  y = SS %>%
  dplyr::filter(ProsedyreType2 == "Stent") %>%
  janitor::tabyl(maaned,
                 Stentnavn) %>%
  janitor::adorn_totals("col", name = "Totalt"),
  by.x  = "maaned", 
  by.y = "maaned", 
  all.x = TRUE) %>% 
  janitor::adorn_totals("row", name = paste0("Totalt hittil i ",
                                             periode_data$nyesteRegYear)) %>% 
  dplyr::mutate(aar = periode_data$nyesteRegYear) %>% 
  dplyr::relocate("aar", .before = "maaned") 


TabStent <- rbind(
  TabStent_fjor, 
  TabStent_aar
)


TabStent[TabStent == 0] <- " - "
TabStent[is.na(TabStent)] <- " - "

align <- c("l", rep("r", dim(TabStent)[2] - 1))
digs <-  rep(0, dim(TabStent)[2] )


if (params$tableFormat == "html") {
  TabStent %>% dplyr::select(-aar) %>% rename(" " = "maaned") %>% 
    knitr::kable(caption = cap, align = align) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped",
                                                    "hover",
                                                    "condensed"),
                              full_width = FALSE, 
                              font_size = 11) %>%
    kableExtra::column_spec(column = 1, width = "7em") %>%
    kableExtra::row_spec(row = 0, font_size = 8, angle = -45) %>%
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=dim(TabStent)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1, 
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabStent)[1])

} else if (params$tableFormat == "latex") {
  TabStent %>% dplyr::select(-aar) %>% rename(" " = "maaned") %>% 
    knitr::kable(format = params$tableFormat,
               caption = cap,
               booktabs = TRUE,
               align = "r") %>%
    kableExtra::kable_styling(latex_options = "HOLD_position", 
                             font_size = 8) %>%
   kableExtra::row_spec(row = 0, angle = 90, font_size = 8) %>%
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE)%>%
    kableExtra::row_spec(row=dim(TabStent)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1,
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabStent)[1])
}

```


```{r}
if (params$rendered_by_shiny == TRUE && params$tableFormat == "latex")
    shiny::setProgress(0.9)  # set progress to 90%
```

`r if(params$tableFormat !="latex" & evaluate_AnP == FALSE) {"<!--"}`
\newpage
`r if(params$tableFormat !="latex" & evaluate_AnP == FALSE) {"-->"}`



# Andre prosedyrer (Stand-alone)
`r if(evaluate_AnP == FALSE){"Dette lokale registeret har ingen registrerte forløp fra Andre Prosedyrer-modulen i datagrunnlaget på nåværende tidspunkt."}`

`r if(evaluate_AnP == TRUE){"Prosedyrer som er utført uten tilknytning til Angio/PCI."}`

```{r TabNAndreProsedyrer,  results = 'asis', eval=evaluate_AnP}
cap <- paste0("Antall prosedyrer registrert i modulen for ",
              "\"Andre prosedyrer\"", " i NORIC (utført uten direkte ",
             "tilknytning til Angio/PCI)  per måned og prosedyretype ved ",
             params$hospitalName, " i perioden ",
             rangeProsDato, ".")

TabAndrePros_fjor <- merge(
  x = timeTableMonth_fjor,
  y =  AnP %>% 
  janitor::tabyl(maaned,
                 AnnenProsType) %>%
  janitor::adorn_totals("col", name = "Totalt"),
  by.x  = "maaned", 
  by.y = "maaned", 
  all.x = TRUE) %>% 
  janitor::adorn_totals("row", name = paste0("Totalt i ",
                                             periode_data$sisteHeleYear)) %>% 
  dplyr::mutate(aar = periode_data$sisteHeleYear) %>% 
  dplyr::relocate("aar", .before = "maaned")


TabAndrePros_aar <- merge(
  x = timeTableMonth_aar,
  y = AnP %>% 
  janitor::tabyl(maaned,
                 AnnenProsType) %>%
  janitor::adorn_totals("col", name = "Totalt"),
  by.x  = "maaned", 
  by.y = "maaned", 
  all.x = TRUE) %>% 
  janitor::adorn_totals("row", name = paste0("Totalt hittil i ",
                                             periode_data$nyesteRegYear)) %>% 
  dplyr::mutate(aar = periode_data$nyesteRegYear) %>% 
  dplyr::relocate("aar", .before = "maaned") 


TabAndrePros <- rbind(
  TabAndrePros_fjor, 
  TabAndrePros_aar
)


TabAndrePros[TabAndrePros == 0] <- " - "
TabAndrePros[is.na(TabAndrePros)] <- " - "

align <- c("l", rep("r", dim(TabAndrePros)[2] - 1))
digs <-  rep(0, dim(TabAndrePros)[2] )


if (params$tableFormat == "html") {
  TabAndrePros %>% dplyr::select(-aar) %>% rename(" " = "maaned") %>% 
    knitr::kable(caption = cap, align = align) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped",
                                                    "hover",
                                                    "condensed"),
                              full_width = FALSE, 
                              font_size = 11) %>%
    kableExtra::column_spec(column = 1, width = "7em") %>%
    kableExtra::row_spec(row = 0, font_size = 8, angle = -45) %>%
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=dim(TabAndrePros)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1, 
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabAndrePros)[1])

} else if (params$tableFormat == "latex") {
  TabAndrePros %>% dplyr::select(-aar) %>% rename(" " = "maaned") %>% 
    knitr::kable(format = params$tableFormat,
               caption = cap,
               booktabs = TRUE,
               align = "r") %>%
    kableExtra::kable_styling(latex_options = "HOLD_position", 
                             font_size = 8) %>%
   kableExtra::row_spec(row = 0, angle = 90, font_size = 8) %>%
    kableExtra::row_spec(row=12, hline_after =  TRUE) %>%
    kableExtra::row_spec(row=13, hline_after =  TRUE)%>%
    kableExtra::row_spec(row=dim(TabAndrePros)[1]-1, hline_after =  TRUE) %>%
    kableExtra::pack_rows(group_label = as.character(periode_data$sisteHeleYear),
                          start_row = 1,
                          end_row = 13) %>% 
    kableExtra::pack_rows(group_label = as.character(periode_data$nyesteRegYear),
                          start_row = 14, 
                          end_row = dim(TabAndrePros)[1])
}

```



```{r}
if (params$rendered_by_shiny == TRUE && params$tableFormat == "latex")
    shiny::setProgress(1)  # set progress to 100%
```
